<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒªã‚·ãƒ¼ç®¡ç† - AEGIS</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        /* ã‚¿ãƒ– */
        .tabs {
            background: white;
            padding: 4px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            display: flex;
            gap: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #718096;
        }

        .tab.active {
            background: #4299e1;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4299e1;
        }

        textarea.form-control {
            min-height: 200px;
            resize: vertical;
            font-family: inherit;
        }

        select.form-control {
            background: white;
        }

        /* ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿é¢¨ */
        .code-editor {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 300px;
            font-size: 13px;
            line-height: 1.6;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .preview-section {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .preview-section h4 {
            margin-bottom: 12px;
            color: #2d3748;
        }

        /* ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .test-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }

        .test-result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            background: #f7fafc;
        }

        .test-result.success {
            background: #c6f6d5;
            border: 1px solid #9ae6b4;
        }

        .test-result.error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
        }

        /* ãƒãƒªã‚·ãƒ¼ãƒªã‚¹ãƒˆ */
        .policy-list {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }

        .policy-item {
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .policy-item:hover {
            border-color: #4299e1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .policy-item.selected {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .policy-name {
            font-weight: 600;
            color: #2d3748;
        }

        .policy-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .policy-type.nl {
            background: #e6fffa;
            color: #234e52;
        }

        .policy-type.odrl {
            background: #ebf8ff;
            color: #2c5282;
        }

        /* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */
        .help-text {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert.success {
            background: #c6f6d5;
            color: #276749;
        }

        .alert.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .alert.info {
            background: #bee3f8;
            color: #2c5282;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top-color: #4299e1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ“‹ ãƒãƒªã‚·ãƒ¼ç®¡ç†</h1>
                <p style="color: #718096; margin-top: 4px;">ãƒãƒªã‚·ãƒ¼ã®ä½œæˆãƒ»ç·¨é›†ãƒ»ãƒ†ã‚¹ãƒˆ</p>
            </div>
            <a href="/" class="btn btn-secondary">
                ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            </a>
        </div>

        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">
                ğŸ“‹ ãƒãƒªã‚·ãƒ¼ä¸€è¦§
            </button>
            <button class="tab" onclick="switchTab('natural')">
                ğŸ’¬ è‡ªç„¶è¨€èªã‚¨ãƒ‡ã‚£ã‚¿
            </button>
            <button class="tab" onclick="switchTab('odrl')">
                ğŸ“ ODRLãƒ•ã‚©ãƒ¼ãƒ 
            </button>
            <button class="tab" onclick="switchTab('test')">
                ğŸ§ª APIãƒ†ã‚¹ãƒˆ
            </button>
        </div>

        <!-- ãƒãƒªã‚·ãƒ¼ä¸€è¦§ã‚¿ãƒ– -->
        <div id="listTab" class="tab-content active">
            <div class="policy-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>æ—¢å­˜ã®ãƒãƒªã‚·ãƒ¼</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="createNewPolicy()">
                            â• æ–°è¦ä½œæˆ
                        </button>
                        <button class="btn btn-secondary" onclick="refreshPolicyList()">
                            ğŸ”„ æ›´æ–°
                        </button>
                    </div>
                </div>
                <div id="policyListContent">
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <div class="loading"></div>
                        <p style="margin-top: 12px;">ãƒãƒªã‚·ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‡ªç„¶è¨€èªã‚¨ãƒ‡ã‚£ã‚¿ã‚¿ãƒ– -->
        <div id="naturalTab" class="tab-content">
            <div class="two-column">
                <div class="panel">
                    <h2>è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ã‚¨ãƒ‡ã‚£ã‚¿</h2>
                    <div id="nlAlert" class="alert info" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label>ãƒãƒªã‚·ãƒ¼ID</label>
                        <input type="text" id="nlPolicyId" class="form-control" placeholder="ä¾‹: customer-data-policy">
                        <div class="help-text">è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½</div>
                    </div>

                    <div class="form-group">
                        <label>èª¬æ˜</label>
                        <input type="text" id="nlDescription" class="form-control" placeholder="ã“ã®ãƒãƒªã‚·ãƒ¼ã®èª¬æ˜">
                    </div>

                    <div class="form-group">
                        <label>ãƒãƒªã‚·ãƒ¼å†…å®¹</label>
                        <textarea id="nlPolicyText" class="form-control" placeholder="æ—¥æœ¬èªã¾ãŸã¯è‹±èªã§ãƒãƒªã‚·ãƒ¼ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

ä¾‹ï¼š
é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š

ã€åŸºæœ¬åŸå‰‡ã€‘
- é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¯é¡§å®¢ã‚µãƒãƒ¼ãƒˆç›®çš„ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ã‚¢ã‚¯ã‚»ã‚¹ã¯å–¶æ¥­æ™‚é–“å†…ï¼ˆå¹³æ—¥9æ™‚ã‹ã‚‰18æ™‚ï¼‰ã‚’åŸºæœ¬ã¨ã™ã‚‹

ã€åˆ¶é™äº‹é …ã€‘
- å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- å€‹äººæƒ…å ±ã®é•·æœŸä¿å­˜ç¦æ­¢

ã€ç¾©å‹™ã€‘
- å…¨ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ­ã‚°è¨˜éŒ²å¿…é ˆ
- 30æ—¥å¾Œã®è‡ªå‹•å‰Šé™¤" style="min-height: 400px;"></textarea>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="saveNaturalLanguagePolicy()">
                            ğŸ’¾ ä¿å­˜
                        </button>
                        <button class="btn btn-secondary" onclick="previewNaturalLanguagePolicy()">
                            ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </button>
                        <button class="btn btn-secondary" onclick="clearNaturalLanguageForm()">
                            ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>

                <div class="panel">
                    <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»ãƒ†ã‚¹ãƒˆ</h2>
                    
                    <div class="preview-section">
                        <h4>ãƒãƒªã‚·ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>
                        <div id="nlPreview" class="code-editor" style="background: #f7fafc; color: #2d3748;">
                            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</h4>
                        <button class="btn btn-success" onclick="testNaturalLanguagePolicy()">
                            ğŸ§ª ãƒãƒªã‚·ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
                        </button>
                        <div id="nlTestResult" class="test-result" style="display: none; margin-top: 16px;"></div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h4>
                        <select class="form-control" onchange="loadNLTemplate(this.value)">
                            <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ...</option>
                            <option value="customer-data">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹</option>
                            <option value="after-hours">å–¶æ¥­æ™‚é–“å¤–åˆ¶é™</option>
                            <option value="high-risk">é«˜ãƒªã‚¹ã‚¯æ“ä½œåˆ¶é™</option>
                            <option value="external-agent">å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¶é™</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ODRLãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ– -->
        <div id="odrlTab" class="tab-content">
            <iframe src="/odrl-policy-form.html" style="width: 100%; height: 800px; border: none; border-radius: 12px;"></iframe>
        </div>

        <!-- APIãƒ†ã‚¹ãƒˆã‚¿ãƒ– -->
        <div id="testTab" class="tab-content">
            <div class="test-section">
                <h2>APIè©•ä¾¡ãƒ†ã‚¹ãƒˆ</h2>
                
                <div class="two-column">
                    <div>
                        <h3>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ</h3>
                        
                        <div class="form-group">
                            <label>ãƒãƒªã‚·ãƒ¼ID</label>
                            <select id="testPolicyId" class="form-control">
                                <option value="">ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠ...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</label>
                            <input type="text" id="testAgent" class="form-control" value="test-agent">
                        </div>

                        <div class="form-group">
                            <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
                            <select id="testAction" class="form-control">
                                <option value="read">read (èª­ã¿å–ã‚Š)</option>
                                <option value="write">write (æ›¸ãè¾¼ã¿)</option>
                                <option value="execute">execute (å®Ÿè¡Œ)</option>
                                <option value="list">list (ä¸€è¦§)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>ãƒªã‚½ãƒ¼ã‚¹</label>
                            <input type="text" id="testResource" class="form-control" placeholder="ä¾‹: gmail://inbox/message/123">
                        </div>

                        <div class="form-group">
                            <label>ç›®çš„ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                            <input type="text" id="testPurpose" class="form-control" placeholder="ä¾‹: customer-support">
                        </div>

                        <div class="form-group">
                            <label>è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆJSONï¼‰</label>
                            <textarea id="testAdditionalContext" class="form-control" placeholder='{"location": "office", "department": "support"}' style="min-height: 100px;"></textarea>
                        </div>

                        <button class="btn btn-primary" onclick="runAPITest()">
                            â–¶ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                        </button>
                    </div>

                    <div>
                        <h3>å®Ÿè¡Œçµæœ</h3>
                        <div id="testResultContainer" style="display: none;">
                            <div class="test-result" id="testResultContent"></div>
                            
                            <div style="margin-top: 20px;">
                                <h4>ãƒªã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°</h4>
                                <div class="code-editor" id="testRequestDetails"></div>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <h4>ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°</h4>
                                <div class="code-editor" id="testResponseDetails"></div>
                            </div>
                        </div>
                        
                        <div id="testPlaceholder" style="text-align: center; color: #718096; padding: 60px;">
                            ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'list';
        let policies = [];
        let selectedPolicy = null;

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            currentTab = tab;
            
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.tab').forEach((btn, index) => {
                btn.classList.toggle('active', 
                    (tab === 'list' && index === 0) ||
                    (tab === 'natural' && index === 1) ||
                    (tab === 'odrl' && index === 2) ||
                    (tab === 'test' && index === 3)
                );
            });
            
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('listTab').classList.toggle('active', tab === 'list');
            document.getElementById('naturalTab').classList.toggle('active', tab === 'natural');
            document.getElementById('odrlTab').classList.toggle('active', tab === 'odrl');
            document.getElementById('testTab').classList.toggle('active', tab === 'test');
            
            // ã‚¿ãƒ–ã”ã¨ã®åˆæœŸåŒ–å‡¦ç†
            if (tab === 'list') {
                refreshPolicyList();
            } else if (tab === 'test') {
                loadPolicyOptions();
            }
        }

        // ãƒãƒªã‚·ãƒ¼ä¸€è¦§ã®æ›´æ–°
        async function refreshPolicyList() {
            try {
                const response = await fetch('/api/odrl/policies');
                const data = await response.json();
                policies = data.policies || [];
                
                renderPolicyList();
            } catch (error) {
                console.error('Failed to load policies:', error);
            }
        }

        // ãƒãƒªã‚·ãƒ¼ä¸€è¦§ã®æç”»
        function renderPolicyList() {
            const content = document.getElementById('policyListContent');
            
            if (policies.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <p>ãƒãƒªã‚·ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <button class="btn btn-primary" onclick="createNewPolicy()" style="margin-top: 16px;">
                            æ–°è¦ä½œæˆ
                        </button>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = policies.map(policy => {
                const isNL = !!policy.naturalLanguageSource;
                const policyName = policy.uid.replace('aegis:policy:', '');
                
                return `
                    <div class="policy-item" onclick="selectPolicy('${policy.uid}')">
                        <div class="policy-header">
                            <div class="policy-name">${policyName}</div>
                            <span class="policy-type ${isNL ? 'nl' : 'odrl'}">
                                ${isNL ? 'è‡ªç„¶è¨€èª' : 'ODRL'}
                            </span>
                        </div>
                        <div style="color: #718096; font-size: 14px;">
                            ${policy.metadata?.description || 'No description'}
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" 
                                    onclick="editPolicy('${policy.uid}', event)">
                                âœï¸ ç·¨é›†
                            </button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" 
                                    onclick="testPolicy('${policy.uid}', event)">
                                ğŸ§ª ãƒ†ã‚¹ãƒˆ
                            </button>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" 
                                    onclick="deletePolicy('${policy.uid}', event)">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ãƒãƒªã‚·ãƒ¼é¸æŠ
        function selectPolicy(policyId) {
            selectedPolicy = policies.find(p => p.uid === policyId);
            
            // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
            document.querySelectorAll('.policy-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // ãƒãƒªã‚·ãƒ¼ç·¨é›†
        function editPolicy(policyId, event) {
            event.stopPropagation();
            const policy = policies.find(p => p.uid === policyId);
            
            if (policy.naturalLanguageSource) {
                // è‡ªç„¶è¨€èªã‚¨ãƒ‡ã‚£ã‚¿ã«åˆ‡ã‚Šæ›¿ãˆ
                switchTab('natural');
                document.getElementById('nlPolicyId').value = policy.uid.replace('aegis:policy:', '');
                document.getElementById('nlDescription').value = policy.metadata?.description || '';
                document.getElementById('nlPolicyText').value = policy.naturalLanguageSource;
                previewNaturalLanguagePolicy();
            } else {
                // ODRLãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
                alert('ODRLãƒãƒªã‚·ãƒ¼ã®ç·¨é›†ã¯ODRLãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–ã§è¡Œã£ã¦ãã ã•ã„');
                switchTab('odrl');
            }
        }

        // ãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆ
        function testPolicy(policyId, event) {
            event.stopPropagation();
            switchTab('test');
            document.getElementById('testPolicyId').value = policyId;
        }

        // ãƒãƒªã‚·ãƒ¼å‰Šé™¤
        async function deletePolicy(policyId, event) {
            event.stopPropagation();
            
            if (!confirm(`ãƒãƒªã‚·ãƒ¼ "${policyId}" ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/odrl/policies/${policyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('success', 'ãƒãƒªã‚·ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    refreshPolicyList();
                } else {
                    showAlert('error', 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                showAlert('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // æ–°è¦ãƒãƒªã‚·ãƒ¼ä½œæˆ
        function createNewPolicy() {
            if (confirm('è‡ªç„¶è¨€èªã§ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nã€Œã„ã„ãˆã€ã‚’é¸æŠã™ã‚‹ã¨ODRLãƒ•ã‚©ãƒ¼ãƒ ãŒé–‹ãã¾ã™ã€‚')) {
                switchTab('natural');
                clearNaturalLanguageForm();
            } else {
                switchTab('odrl');
            }
        }

        // è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ã®ä¿å­˜
        async function saveNaturalLanguagePolicy() {
            const policyId = document.getElementById('nlPolicyId').value.trim();
            const description = document.getElementById('nlDescription').value.trim();
            const policyText = document.getElementById('nlPolicyText').value.trim();
            
            if (!policyId || !policyText) {
                showNLAlert('error', 'ãƒãƒªã‚·ãƒ¼IDã¨ãƒãƒªã‚·ãƒ¼å†…å®¹ã¯å¿…é ˆã§ã™');
                return;
            }
            
            try {
                const response = await fetch('/api/odrl/policies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        uid: `aegis:policy:${policyId}`,
                        naturalLanguageSource: policyText,
                        metadata: {
                            description: description,
                            created: new Date().toISOString()
                        }
                    })
                });
                
                if (response.ok) {
                    showNLAlert('success', 'ãƒãƒªã‚·ãƒ¼ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
                    setTimeout(() => {
                        switchTab('list');
                    }, 1500);
                } else {
                    const error = await response.json();
                    showNLAlert('error', 'ã‚¨ãƒ©ãƒ¼: ' + (error.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                }
            } catch (error) {
                showNLAlert('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function previewNaturalLanguagePolicy() {
            const policyText = document.getElementById('nlPolicyText').value;
            const preview = document.getElementById('nlPreview');
            
            if (!policyText) {
                preview.textContent = 'ãƒãƒªã‚·ãƒ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return;
            }
            
            preview.textContent = policyText;
        }

        // è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
        async function testNaturalLanguagePolicy() {
            const policyText = document.getElementById('nlPolicyText').value.trim();
            
            if (!policyText) {
                showNLAlert('error', 'ãƒ†ã‚¹ãƒˆã™ã‚‹ãƒãƒªã‚·ãƒ¼å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const testContext = {
                agent: 'test-agent',
                action: 'read',
                resource: 'test-resource',
                time: new Date().toISOString()
            };
            
            try {
                // ä»®ã®ãƒãƒªã‚·ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ãƒ†ã‚¹ãƒˆ
                const tempPolicy = {
                    uid: 'test-policy',
                    naturalLanguageSource: policyText
                };
                
                const resultDiv = document.getElementById('nlTestResult');
                resultDiv.style.display = 'block';
                resultDiv.className = 'test-result';
                resultDiv.innerHTML = `
                    <strong>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:</strong><br>
                    ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${testContext.agent}<br>
                    ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${testContext.action}<br>
                    ãƒªã‚½ãƒ¼ã‚¹: ${testContext.resource}<br>
                    <br>
                    <strong>çµæœ:</strong> AIåˆ¤å®šæ©Ÿèƒ½ãŒå¿…è¦ã§ã™<br>
                    <br>
                    <em>æ³¨: å®Ÿéš›ã®åˆ¤å®šã«ã¯ANTHROPIC_API_KEYã®è¨­å®šãŒå¿…è¦ã§ã™</em>
                `;
            } catch (error) {
                showNLAlert('error', 'ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
        function clearNaturalLanguageForm() {
            document.getElementById('nlPolicyId').value = '';
            document.getElementById('nlDescription').value = '';
            document.getElementById('nlPolicyText').value = '';
            document.getElementById('nlPreview').textContent = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            document.getElementById('nlTestResult').style.display = 'none';
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        function loadNLTemplate(templateId) {
            const templates = {
                'customer-data': `é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š

ã€åŸºæœ¬åŸå‰‡ã€‘
- é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¯é¡§å®¢ã‚µãƒãƒ¼ãƒˆç›®çš„ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ã‚¢ã‚¯ã‚»ã‚¹ã¯å–¶æ¥­æ™‚é–“å†…ï¼ˆå¹³æ—¥9æ™‚ã‹ã‚‰18æ™‚ï¼‰ã‚’åŸºæœ¬ã¨ã™ã‚‹
- é©åˆ‡ãªã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦

ã€åˆ¶é™äº‹é …ã€‘  
- å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨å…±æœ‰ã¯ä¸€åˆ‡ç¦æ­¢
- å€‹äººæƒ…å ±ã®é•·æœŸä¿å­˜ç¦æ­¢

ã€ç¾©å‹™ã€‘
- å…¨ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒ­ã‚°è¨˜éŒ²å¿…é ˆ
- ãƒ‡ãƒ¼ã‚¿å‡¦ç†å¾Œã®çµæœé€šçŸ¥
- 30æ—¥å¾Œã®è‡ªå‹•å‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š`,

                'after-hours': `å–¶æ¥­æ™‚é–“å¤–ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š

ã€åŸºæœ¬ãƒ«ãƒ¼ãƒ«ã€‘
- å–¶æ¥­æ™‚é–“å¤–ï¼ˆå¹³æ—¥18æ™‚ä»¥é™ãŠã‚ˆã³åœŸæ—¥ç¥æ—¥ï¼‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯åŸå‰‡ç¦æ­¢
- ç·Šæ€¥å¯¾å¿œãƒãƒ¼ãƒ ã®ã¿ä¾‹å¤–çš„ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

ã€è¨±å¯æ¡ä»¶ã€‘
- ç·Šæ€¥å¯¾å¿œãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚‹ã“ã¨
- äº‹å‰æ‰¿èªæ¸ˆã¿ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä½œæ¥­
- ã‚·ã‚¹ãƒ†ãƒ éšœå®³å¯¾å¿œ

ã€è¿½åŠ åˆ¶é™ã€‘
- èª­ã¿å–ã‚Šå°‚ç”¨ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿
- é‡è¦ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯è¨˜éŒ²å¿…é ˆ
- ä½œæ¥­å®Œäº†å¾Œã®å ±å‘Šæ›¸æå‡ºç¾©å‹™`,

                'high-risk': `é«˜ãƒªã‚¹ã‚¯æ“ä½œåˆ¶é™ãƒãƒªã‚·ãƒ¼ï¼š

ã€å¯¾è±¡æ“ä½œã€‘
- ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å‰Šé™¤
- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´
- æ¨©é™è¨­å®šã®å¤‰æ›´
- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºè¨­å®š

ã€åˆ¶é™äº‹é …ã€‘
- ç®¡ç†è€…æ¨©é™ã‚’æŒã¤ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã¿å®Ÿè¡Œå¯èƒ½
- äºŒè¦ç´ èªè¨¼å¿…é ˆ
- å®Ÿè¡Œå‰ã®æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹å¿…é ˆ

ã€ç›£æŸ»è¦ä»¶ã€‘
- å…¨æ“ä½œã®è©³ç´°ãƒ­ã‚°è¨˜éŒ²
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã®é€ä¿¡
- æœˆæ¬¡ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆã¸ã®è¨˜è¼‰`,

                'external-agent': `å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¶é™ãƒãƒªã‚·ãƒ¼ï¼š

ã€åŸºæœ¬æ–¹é‡ã€‘
- å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
- å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- APIã‚’é€šã˜ãŸé™å®šçš„ãªã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯

ã€è¨±å¯ã•ã‚Œã‚‹æ“ä½œã€‘
- å…¬é–‹æƒ…å ±ã®èª­ã¿å–ã‚Š
- äº‹å‰å®šç¾©ã•ã‚ŒãŸAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
- ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿å‚ç…§ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¸å¯ï¼‰

ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã€‘
- IPã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¶é™
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆ1åˆ†é–“ã«10ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ã§ï¼‰
- ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å®šæœŸæ›´æ–°å¿…é ˆ`
            };
            
            if (templateId && templates[templateId]) {
                document.getElementById('nlPolicyText').value = templates[templateId];
                previewNaturalLanguagePolicy();
            }
        }

        // APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAPITest() {
            const policyId = document.getElementById('testPolicyId').value;
            const agent = document.getElementById('testAgent').value;
            const action = document.getElementById('testAction').value;
            const resource = document.getElementById('testResource').value;
            const purpose = document.getElementById('testPurpose').value;
            let additionalContext = {};
            
            try {
                const contextText = document.getElementById('testAdditionalContext').value.trim();
                if (contextText) {
                    additionalContext = JSON.parse(contextText);
                }
            } catch (e) {
                alert('è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®JSONãŒç„¡åŠ¹ã§ã™');
                return;
            }
            
            if (!policyId || !resource) {
                alert('ãƒãƒªã‚·ãƒ¼IDã¨ãƒªã‚½ãƒ¼ã‚¹ã¯å¿…é ˆã§ã™');
                return;
            }
            
            const context = {
                agent,
                action,
                resource,
                purpose: purpose || undefined,
                time: new Date().toISOString(),
                ...additionalContext
            };
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆè©³ç´°è¡¨ç¤º
            document.getElementById('testRequestDetails').textContent = JSON.stringify({
                policyId,
                context
            }, null, 2);
            
            try {
                const response = await fetch('/api/test/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ context, policyId })
                });
                
                const result = await response.json();
                
                // çµæœè¡¨ç¤º
                document.getElementById('testPlaceholder').style.display = 'none';
                document.getElementById('testResultContainer').style.display = 'block';
                
                const resultContent = document.getElementById('testResultContent');
                resultContent.className = `test-result ${result.decision === 'PERMIT' ? 'success' : 'error'}`;
                resultContent.innerHTML = `
                    <h3>${result.decision === 'PERMIT' ? 'âœ… è¨±å¯' : 'âŒ æ‹’å¦'}</h3>
                    <p><strong>åˆ¤å®š:</strong> ${result.decision}</p>
                    <p><strong>ç†ç”±:</strong> ${result.reason}</p>
                    <p><strong>ä¿¡é ¼åº¦:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                    ${result.processingTime ? `<p><strong>å‡¦ç†æ™‚é–“:</strong> ${result.processingTime}ms</p>` : ''}
                `;
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹è©³ç´°è¡¨ç¤º
                document.getElementById('testResponseDetails').textContent = JSON.stringify(result, null, 2);
                
            } catch (error) {
                alert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒãƒªã‚·ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
        async function loadPolicyOptions() {
            try {
                const response = await fetch('/api/odrl/policies');
                const data = await response.json();
                const policies = data.policies || [];
                
                const select = document.getElementById('testPolicyId');
                select.innerHTML = '<option value="">ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠ...</option>' +
                    policies.map(p => `<option value="${p.uid}">${p.uid.replace('aegis:policy:', '')}</option>`).join('');
            } catch (error) {
                console.error('Failed to load policy options:', error);
            }
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showNLAlert(type, message) {
            const alert = document.getElementById('nlAlert');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showAlert(type, message) {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆå®Ÿè£…ã¯çœç•¥ï¼‰
            alert(message);
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            refreshPolicyList();
        });
    </script>
</body>
</html>