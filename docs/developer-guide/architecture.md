# ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

AEGISã®å…¨ä½“çš„ãªã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆã¨ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°ãªèª¬æ˜ã§ã™ã€‚

## ğŸ›ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

AEGISã¯ã€è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ã¨MCPãƒ—ãƒ­ã‚­ã‚·ã‚’çµ„ã¿åˆã‚ã›ãŸé©æ–°çš„ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå±¤                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆå„ç¨®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ MCPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PEP (Policy Enforcement Point) - MCPãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆ    â”‚ â”‚åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³  â”‚ â”‚åˆ¶ç´„ãƒ»ç¾©å‹™               â”‚ â”‚
â”‚  â”‚ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆâ”‚ â”‚å‘¼ã³å‡ºã—      â”‚ â”‚å®Ÿè¡Œ                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚
          â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PIP              â”‚    â”‚PDP                                  â”‚
â”‚(Policy Info     â”‚    â”‚(Policy Decision Point)             â”‚
â”‚Point)           â”‚    â”‚è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³          â”‚
â”‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ      â”‚    â”‚                                     â”‚
â”‚æƒ…å ±åé›†ãƒ»æ‹¡å¼µ    â”‚    â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                 â”‚    â”‚â”‚è‡ªç„¶è¨€èª      â”‚ â”‚AIåˆ¤å®š           â”‚â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚â”‚ãƒãƒªã‚·ãƒ¼      â”‚ â”‚(LLM)            â”‚â”‚
â”‚â”‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ  â”‚  â”‚    â”‚â”‚â†’ã‚·ã‚¹ãƒ†ãƒ      â”‚ â”‚                 â”‚â”‚
â”‚â”‚æƒ…å ±å–å¾—      â”‚  â”‚    â”‚â”‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›â”‚ â”‚PERMIT/DENY/     â”‚â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚INDETERMINATE    â”‚â”‚
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚â”‚ãƒªã‚½ãƒ¼ã‚¹åˆ†é¡  â”‚  â”‚    â”‚                                     â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                        â–²
â”‚â”‚æ™‚é–“ãƒ»å ´æ‰€    â”‚  â”‚                        â”‚
â”‚â”‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£  â”‚  â”‚                        â”‚
â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚PAP                                  â”‚
          â”‚             â”‚(Policy Administration Point)       â”‚
          â”‚             â”‚è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ç®¡ç†                 â”‚
          â”‚             â”‚                                     â”‚
          â”‚             â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
          â”‚             â”‚â”‚ãƒãƒªã‚·ãƒ¼ä½œæˆ  â”‚ â”‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†   â”‚â”‚
          â”‚             â”‚â”‚æ›´æ–°ãƒ»å‰Šé™¤    â”‚ â”‚ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†   â”‚â”‚
          â”‚             â”‚â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
          â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸ŠæµMCPã‚µãƒ¼ãƒãƒ¼ç¾¤                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Gmail MCP    â”‚ â”‚Google Drive â”‚ â”‚ãã®ä»–å„ç¨®MCPã‚µãƒ¼ãƒãƒ¼     â”‚ â”‚
â”‚  â”‚ã‚µãƒ¼ãƒãƒ¼     â”‚ â”‚MCPã‚µãƒ¼ãƒãƒ¼   â”‚ â”‚(Slack, Calendar, etc.)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### 1. PEP (Policy Enforcement Point) - MCPãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼

**å½¹å‰²**: ã™ã¹ã¦ã®MCPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã—ã€ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ã‚’é€æ˜ã«å®Ÿè¡Œ

```typescript
export class MCPProxyServer implements PolicyEnforcementPoint {
  private server: Server;
  private pdp: PolicyDecisionPoint;
  private pip: PolicyInformationPoint;
  private enforcementSystem: EnforcementSystem;
  
  async handleRequest(request: MCPRequest): Promise<MCPResponse> {
    // 1. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰
    const context = await this.buildContext(request);
    
    // 2. PIPã«ã‚ˆã‚‹æƒ…å ±æ‹¡å¼µ
    const enrichedContext = await this.pip.enrich(context);
    
    // 3. PDPåˆ¤å®š
    const decision = await this.pdp.evaluate(enrichedContext);
    
    // 4. åˆ¤å®šã«åŸºã¥ãå‡¦ç†
    if (decision.decision === 'PERMIT') {
      // åˆ¶ç´„é©ç”¨
      const processedRequest = await this.applyConstraints(request, decision.constraints);
      
      // ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã¸ãƒ—ãƒ­ã‚­ã‚·
      const response = await this.proxyToUpstream(processedRequest);
      
      // ç¾©å‹™å®Ÿè¡Œ
      await this.executeObligations(decision.obligations, context, response);
      
      return response;
    } else {
      throw new AccessDeniedError(decision.reason);
    }
  }
}
```

**ä¸»è¦æ©Ÿèƒ½**:
- é€æ˜ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦å‹•ä½œ
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®äº‹å‰ãƒ»äº‹å¾Œå‡¦ç†
- åˆ¶ç´„ã¨ç¾©å‹™ã®å®Ÿè¡Œç®¡ç†
- ç›£æŸ»ãƒ­ã‚°ã®è‡ªå‹•è¨˜éŒ²

### 2. PDP (Policy Decision Point) - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³

**å½¹å‰²**: ODRLãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹åˆ¤å®šã¨AIåˆ¤å®šã‚’çµ„ã¿åˆã‚ã›ãŸé«˜é€Ÿãƒ»æŸ”è»Ÿãªåˆ¤å®šã‚’è¡Œã†

> **ğŸ“ æ³¨**: æœ€æ–°ã®å®Ÿè£…ã§ã¯ã€AIã®éåº¦ãªå³æ ¼ã•ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€ODRLãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
> è©³ç´°ã¯[ODRLã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](../ODRL_ARCHITECTURE_OVERVIEW.md)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```typescript
export class AIPolicyDecisionPoint implements PolicyDecisionPoint {
  private llm: LLMProvider;
  private policyStore: PolicyStore;
  private cache: DecisionCache;
  
  async evaluate(context: DecisionContext): Promise<PolicyDecision> {
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    const cached = await this.cache.get(context);
    if (cached) return cached;
    
    // é©ç”¨å¯èƒ½ãªãƒãƒªã‚·ãƒ¼ã‚’é¸æŠ
    const policies = await this.selectApplicablePolicies(context);
    
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
    const prompt = this.buildPrompt(policies, context);
    
    // LLMåˆ¤å®š
    const llmResponse = await this.llm.complete(prompt, {
      temperature: 0.2,  // ä¸€è²«æ€§é‡è¦–
      responseFormat: 'json'
    });
    
    // çµæœãƒ‘ãƒ¼ã‚¹
    const decision = this.parseDecision(llmResponse);
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    await this.cache.set(context, decision);
    
    return decision;
  }
  
  private buildPrompt(policies: Policy[], context: DecisionContext): string {
    return `
ã‚ãªãŸã¯ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®åˆ¤å®šã‚’è¡Œã†ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã„ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯(PERMIT)ã¾ãŸã¯æ‹’å¦(DENY)ã—ã¦ãã ã•ã„ã€‚

ãƒãƒªã‚·ãƒ¼:
${policies.map(p => p.content).join('\n\n')}

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:
- ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${context.agent}
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${context.action}
- ãƒªã‚½ãƒ¼ã‚¹: ${context.resource}
- æ™‚åˆ»: ${context.time}
- è¿½åŠ æƒ…å ±: ${JSON.stringify(context.metadata)}

ä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
{
  "decision": "PERMIT" | "DENY" | "INDETERMINATE",
  "reason": "åˆ¤å®šç†ç”±ã®è©³ç´°ãªèª¬æ˜",
  "confidence": 0.0-1.0ã®ä¿¡é ¼åº¦,
  "constraints": ["é©ç”¨ã™ã¹ãåˆ¶ç´„ã®ãƒªã‚¹ãƒˆ"],
  "obligations": ["å®Ÿè¡Œã™ã¹ãç¾©å‹™ã®ãƒªã‚¹ãƒˆ"]
}
`;
  }
}
```

### 3. PIP (Policy Information Point) - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ‹¡å¼µ

**å½¹å‰²**: åˆ¤å®šã«å¿…è¦ãªè¿½åŠ æƒ…å ±ã‚’åé›†ã—ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å……å®Ÿã•ã›ã‚‹

```typescript
export class ContextEnrichmentPIP implements PolicyInformationPoint {
  private enrichers: Map<string, ContextEnricher>;
  
  constructor() {
    this.registerEnrichers();
  }
  
  private registerEnrichers(): void {
    this.enrichers.set('agent', new AgentInfoEnricher());
    this.enrichers.set('time', new TimeBasedEnricher());
    this.enrichers.set('resource', new ResourceClassificationEnricher());
    this.enrichers.set('security', new SecurityContextEnricher());
    this.enrichers.set('lineage', new DataLineageEnricher());
  }
  
  async enrich(context: DecisionContext): Promise<EnrichedContext> {
    const enriched = { ...context };
    
    // ä¸¦åˆ—ã§å…¨enricherã‚’å®Ÿè¡Œ
    const enrichmentPromises = Array.from(this.enrichers.entries()).map(
      async ([name, enricher]) => {
        try {
          const data = await enricher.enrich(context);
          enriched[name] = data;
        } catch (error) {
          logger.warn(`Enricher ${name} failed`, error);
        }
      }
    );
    
    await Promise.all(enrichmentPromises);
    
    return enriched as EnrichedContext;
  }
}
```

### 4. PAP (Policy Administration Point) - ãƒãƒªã‚·ãƒ¼ç®¡ç†

**å½¹å‰²**: ãƒãƒªã‚·ãƒ¼ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ã‚’ç®¡ç†

```typescript
export class PolicyAdministrationPoint {
  private storage: PolicyStorage;
  private validator: PolicyValidator;
  private versionControl: VersionControl;
  
  async createPolicy(
    name: string, 
    content: string, 
    metadata?: PolicyMetadata
  ): Promise<string> {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    await this.validator.validate(content);
    
    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    const policy: Policy = {
      id: generateId(),
      name,
      content,
      metadata: {
        ...metadata,
        version: '1.0.0',
        createdAt: new Date(),
        createdBy: getCurrentUser(),
        status: 'draft'
      }
    };
    
    // ä¿å­˜
    await this.storage.save(policy);
    
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
    await this.versionControl.commit(policy);
    
    return policy.id;
  }
  
  async updatePolicy(
    id: string, 
    content: string, 
    reason?: string
  ): Promise<void> {
    const existing = await this.storage.get(id);
    if (!existing) throw new NotFoundError('Policy not found');
    
    // æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä½œæˆ
    const newVersion = incrementVersion(existing.metadata.version);
    
    const updated: Policy = {
      ...existing,
      content,
      metadata: {
        ...existing.metadata,
        version: newVersion,
        lastModified: new Date(),
        lastModifiedBy: getCurrentUser()
      }
    };
    
    // ä¿å­˜ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
    await this.storage.save(updated);
    await this.versionControl.commit(updated, reason);
  }
}
```

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
// è©³ç´°ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼
async function processRequest(mcpRequest: MCPRequest): Promise<MCPResponse> {
  // Phase 1: å—ä¿¡ã¨ãƒ‘ãƒ¼ã‚¹
  const parsedRequest = parseRequest(mcpRequest);
  const requestId = generateRequestId();
  
  // Phase 2: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰
  const baseContext: DecisionContext = {
    requestId,
    agent: extractAgent(parsedRequest),
    action: extractAction(parsedRequest),
    resource: extractResource(parsedRequest),
    time: new Date(),
    metadata: extractMetadata(parsedRequest)
  };
  
  // Phase 3: PIPæƒ…å ±æ‹¡å¼µ
  const enrichedContext = await pip.enrich(baseContext);
  
  // Phase 4: ãƒãƒªã‚·ãƒ¼é¸æŠ
  const applicablePolicies = await pap.selectPolicies(enrichedContext);
  
  // Phase 5: PDPåˆ¤å®š
  const decision = await pdp.evaluate(enrichedContext, applicablePolicies);
  
  // Phase 6: åˆ¤å®šå®Ÿè¡Œ
  if (decision.decision === 'PERMIT') {
    // åˆ¶ç´„é©ç”¨
    const constrainedRequest = await enforcer.applyConstraints(
      parsedRequest, 
      decision.constraints
    );
    
    // ä¸Šæµå®Ÿè¡Œ
    const upstreamResponse = await upstream.execute(constrainedRequest);
    
    // ç¾©å‹™å®Ÿè¡Œï¼ˆéåŒæœŸï¼‰
    enforcer.executeObligations(decision.obligations, enrichedContext)
      .catch(error => logger.error('Obligation execution failed', error));
    
    // ç›£æŸ»ãƒ­ã‚°
    await auditLogger.log({
      requestId,
      context: enrichedContext,
      decision,
      response: upstreamResponse
    });
    
    return upstreamResponse;
  } else {
    // æ‹’å¦å‡¦ç†
    await auditLogger.log({
      requestId,
      context: enrichedContext,
      decision
    });
    
    throw new AccessDeniedError(decision);
  }
}
```

### 2. éåŒæœŸå‡¦ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```typescript
export class AsyncProcessingArchitecture {
  private eventBus: EventBus;
  private taskQueue: TaskQueue;
  
  constructor() {
    this.setupEventHandlers();
  }
  
  private setupEventHandlers(): void {
    // åˆ¤å®šå®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
    this.eventBus.on('decision.made', async (event) => {
      // çµ±è¨ˆæ›´æ–°
      await this.updateStatistics(event);
      
      // ç•°å¸¸æ¤œçŸ¥
      await this.detectAnomalies(event);
      
      // é€šçŸ¥é€ä¿¡
      if (event.decision.decision === 'DENY') {
        await this.sendAlerts(event);
      }
    });
    
    // ç¾©å‹™å®Ÿè¡Œã‚¤ãƒ™ãƒ³ãƒˆ
    this.eventBus.on('obligation.execute', async (obligation) => {
      await this.taskQueue.enqueue({
        type: 'obligation',
        payload: obligation,
        priority: obligation.priority || 'normal'
      });
    });
  }
}
```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1. ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆåŸå‰‡

```typescript
export class ZeroTrustArchitecture {
  // ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¤œè¨¼
  async validateRequest(request: MCPRequest): Promise<ValidationResult> {
    // 1. èªè¨¼æ¤œè¨¼
    const authResult = await this.validateAuthentication(request);
    if (!authResult.valid) return authResult;
    
    // 2. èªå¯æ¤œè¨¼
    const authzResult = await this.validateAuthorization(request);
    if (!authzResult.valid) return authzResult;
    
    // 3. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œè¨¼
    const contextResult = await this.validateContext(request);
    if (!contextResult.valid) return contextResult;
    
    // 4. ç•°å¸¸æ¤œçŸ¥
    const anomalyResult = await this.detectAnomalies(request);
    if (anomalyResult.suspicious) {
      return { valid: false, reason: 'Anomaly detected' };
    }
    
    return { valid: true };
  }
}
```

### 2. æš—å·åŒ–ã¨å®Œå…¨æ€§

```typescript
export class SecurityLayer {
  // ç›£æŸ»ãƒ­ã‚°ã®æš—å·åŒ–
  async encryptAuditLog(log: AuditLog): Promise<EncryptedLog> {
    const key = await this.keyManager.getCurrentKey();
    const encrypted = await crypto.encrypt(JSON.stringify(log), key);
    
    // ãƒ‡ã‚¸ã‚¿ãƒ«ç½²å
    const signature = await crypto.sign(encrypted, this.signingKey);
    
    return {
      data: encrypted,
      signature,
      keyId: key.id,
      timestamp: new Date()
    };
  }
  
  // é€šä¿¡ã®æš—å·åŒ–
  setupTLS(): void {
    this.server.use(tls({
      cert: fs.readFileSync('server.crt'),
      key: fs.readFileSync('server.key'),
      ciphers: 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384',
      minVersion: 'TLSv1.2'
    }));
  }
}
```

## ğŸš€ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£è¨­è¨ˆ

### 1. æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

```yaml
# Kubernetes Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aegis-proxy
spec:
  replicas: 3
  selector:
    matchLabels:
      app: aegis-proxy
  template:
    metadata:
      labels:
        app: aegis-proxy
    spec:
      containers:
      - name: aegis
        image: aegis:latest
        env:
        - name: REDIS_URL
          value: "redis://redis-cluster:6379"
        - name: ENABLE_CLUSTERING
          value: "true"
```

### 2. ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

```typescript
export class MultiLayerCache {
  private l1Cache: MemoryCache;  // ãƒ—ãƒ­ã‚»ã‚¹å†…ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  private l2Cache: RedisCache;   // åˆ†æ•£ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  
  async get(key: string): Promise<any> {
    // L1ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    const l1Result = await this.l1Cache.get(key);
    if (l1Result) return l1Result;
    
    // L2ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    const l2Result = await this.l2Cache.get(key);
    if (l2Result) {
      // L1ã«ã‚‚ä¿å­˜
      await this.l1Cache.set(key, l2Result);
      return l2Result;
    }
    
    return null;
  }
  
  async set(key: string, value: any, ttl?: number): Promise<void> {
    // ä¸¡ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ä¿å­˜
    await Promise.all([
      this.l1Cache.set(key, value, ttl),
      this.l2Cache.set(key, value, ttl)
    ]);
  }
}
```

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [MCPçµ±åˆè©³ç´°](./mcp-integration.md) - MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®Ÿè£…è©³ç´°
- [API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](./api-reference.md) - REST APIã®ä»•æ§˜
- [æ‹¡å¼µãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º](./extending.md) - ã‚·ã‚¹ãƒ†ãƒ ã®æ‹¡å¼µæ–¹æ³•