# 自然言語ポリシー記述ガイド

AEGISの最大の特徴は、複雑なXMLやJSONではなく、自然言語でポリシーを記述できることです。このガイドでは、効果的なポリシーの書き方を説明します。

## 📋 基本構造

### ポリシーの基本要素

良いポリシーには以下の要素が含まれます：

1. **ポリシー名**: 明確で識別しやすい名前
2. **基本原則**: このポリシーの目的と方針
3. **許可条件**: どのような場合にアクセスを許可するか
4. **制限事項**: どのような場合にアクセスを拒否するか
5. **必須対応**: アクセス時に実行すべき義務

### 基本的なテンプレート

```
【ポリシー名】

基本原則：
- 主要な方針1
- 主要な方針2
- 主要な方針3

許可条件：
- 許可される場合1
- 許可される場合2

制限事項：
- 禁止される操作1
- 禁止される操作2

必須対応：
- 実行すべき義務1
- 実行すべき義務2
```

## 📝 実践的なポリシー例

### 1. 顧客データアクセスポリシー

```
【顧客データアクセスポリシー】

基本原則：
- 顧客データは顧客サポート業務の目的でのみアクセス可能
- アクセスは営業時間内（平日9-18時）を基本とする
- 適切なクリアランスレベル（standard以上）が必要

許可条件：
- サポートチームのエージェントによるアクセス
- 顧客からの問い合わせ対応中
- 読み取り専用のアクセス

制限事項：
- 外部エージェントのアクセスは禁止
- 個人情報の外部システム送信は一切禁止
- 個人情報の長期間保存（30日超）は禁止
- 大量データの一括ダウンロード禁止

必須対応：
- 全アクセスの詳細ログ記録
- アクセスした顧客IDの記録
- データ処理完了後の関係者通知
- 30日後の自動削除予約設定
```

### 2. 開発環境セキュリティポリシー

```
【開発環境セキュリティポリシー】

基本原則：
- 開発者の生産性を維持しつつ、セキュリティリスクを最小化
- 本番環境への影響を防ぐ
- 危険なコマンドの実行を制限

許可条件：
- 開発チームメンバーによる操作
- プロジェクトディレクトリ内でのファイル操作
- 一般的な開発ツールの使用

制限事項：
- システムファイルの変更禁止
- rm -rf / などの破壊的コマンドの実行禁止
- 本番データベースへの直接アクセス禁止
- sudo/管理者権限でのコマンド実行禁止

必須対応：
- 危険なコマンドの実行ログ記録
- 異常なアクセスパターンの通知
- コード実行の監査証跡保存
```

### 3. AIツール制御ポリシー

```
【MCPツール制御ポリシー】

基本原則：
- ツール名から自動的にリスクレベルを判定
- リスクレベルに応じた適切な制御を適用
- 新しいツールも自動的に制御対象

リスク判定基準：

高リスク（厳格な制御）:
- bash, shell, exec, cmd, powershell を含むツール
- system, os, process を含むツール
- delete, remove, destroy を含むツール
- admin, root, sudo を含むツール
- agent（再帰的実行）を含むツール

中リスク（標準制御）:
- write, create, update, modify, edit を含むツール
- move, rename, copy を含むツール
- config, setting を含むツール

低リスク（最小限の制御）:
- read, get, list, search, find を含むツール
- view, show, display を含むツール
- info, status, stat を含むツール
- todo, task, note を含むツール

制御内容：
- 高リスク: 詳細ログ、パラメータ検証、上長承認
- 中リスク: 実行ログ、大量操作警告
- 低リスク: 基本的なアクセスログ
```

## 🎯 効果的なポリシーの書き方

### 1. 明確で具体的に

❌ 悪い例：
```
データへのアクセスは適切に制御する
```

✅ 良い例：
```
顧客の個人情報へのアクセスは、サポートチームのみ、
営業時間内（平日9-18時）に、顧客対応目的でのみ許可
```

### 2. 条件を明示的に

❌ 悪い例：
```
必要に応じてアクセスを許可
```

✅ 良い例：
```
以下の条件をすべて満たす場合のみアクセスを許可：
- エージェントのクリアランスレベルがstandard以上
- アクセス時刻が営業時間内
- 正当な業務目的が記録されている
```

### 3. 技術用語を適切に使用

AIが理解しやすいように、一般的な技術用語を使用：

```
- ファイルシステムの「読み取り」「書き込み」「削除」
- データベースの「SELECT」「INSERT」「UPDATE」「DELETE」
- ネットワークの「内部IP」「外部IP」「VPN接続」
- 時間の「営業時間」「深夜」「週末」
```

### 4. 例外を明記

```
制限事項：
- 原則として個人情報の外部送信は禁止
- ただし、以下の場合は例外とする：
  - 顧客の明示的な同意がある場合
  - 法的要求に基づく場合
  - 匿名化処理後のデータ
```

## 🔧 高度なテクニック

### 1. コンテキスト依存の制御

```
アクセス制御：
- 通常時: 読み取りのみ許可
- 緊急時（incident_levelがcritical）: 書き込みも許可
- ただし、緊急時でも削除操作は上長承認必須
```

### 2. 段階的エスカレーション

```
異常検知時の対応：
- 1回目の異常: 警告ログのみ
- 3回以内の異常: 管理者に通知
- 5回超の異常: アクセスを一時的にブロック
- ブロック後は手動解除が必要
```

### 3. 時間ベースの制御

```
時間帯別アクセス制御：
- 営業時間（9-18時）: 通常アクセス許可
- 時間外（18-21時）: 読み取りのみ、ログ強化
- 深夜（21-6時）: 緊急時のみ、承認必須
- 週末・祝日: オンコール担当者のみ
```

## ✅ ポリシーのテスト

### 1. Web UIでのテスト

1. ポリシー管理画面でポリシーを作成
2. 「テスト」タブを選択
3. 仮想的なリクエストを入力：
   ```json
   {
     "agent": "test-agent",
     "action": "read",
     "resource": "customer-data",
     "context": {
       "time": "2024-01-01T10:00:00Z",
       "clearanceLevel": "standard"
     }
   }
   ```
4. 判定結果を確認

### 2. コマンドラインでのテスト

```bash
curl -X POST http://localhost:3000/api/policy/test \
  -H "Content-Type: application/json" \
  -d '{
    "policyName": "customer-data-policy",
    "request": {
      "agent": "support-agent-001",
      "action": "read",
      "resource": "customer/12345"
    }
  }'
```

## 📊 ポリシーの最適化

### 1. ログ分析による改善

定期的に以下を確認：
- よくある拒否理由
- 誤検知のパターン
- ユーザーからのフィードバック

### 2. パフォーマンスの考慮

```
キャッシュ可能な判定：
- エージェントの属性ベースの判定
- 時間帯ベースの判定
- 静的なリソース分類

キャッシュ不可の判定：
- リアルタイムのリスク評価
- 動的なコンテキスト依存
- 外部システム連携が必要な判定
```

## 🚫 よくある間違い

### 1. 曖昧な表現

❌ 「適切に判断する」
❌ 「必要に応じて許可」
❌ 「セキュリティを考慮」

### 2. 矛盾する条件

❌ 「全員アクセス可能だが、外部からは禁止」（「全員」の定義が不明確）

### 3. 実装不可能な要求

❌ 「ユーザーの意図を読み取って判断」
❌ 「将来の利用を予測して制御」

## 📚 次のステップ

- [利用可能なツール一覧](./tools-catalog.md) - 制御対象のツールを確認
- [実践的な使用例](./examples.md) - 実際のシナリオでの適用例
- [ガバナンス運用](../admin-guide/governance.md) - ポリシー管理のベストプラクティス