# AEGIS ユニバーサルMCPプロキシ設計書

## 概要

AEGIS MCPプロキシは、設定ベースのMCPサーバーに加えて、MCPクライアント（Claude Desktop、Claude Code、Cursor、VSCode等）が提供するあらゆるツールを統合的に制御します。自然言語ポリシーによる動的なリスク判定により、柔軟かつ安全なツール実行環境を提供します。

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    MCPクライアント                           │
│        (Claude Desktop/Claude Code/Cursor/VSCode等)         │
└─────────────────┬───────────────────────────────────────────┘
                  │ MCPプロトコル
                  ▼
┌─────────────────────────────────────────────────────────────┐
│              AEGIS MCPプロキシサーバー                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │  設定ベース     │  │  自然言語      │  │ AI判定      │ │
│  │  MCPサーバー    │  │  ポリシー      │  │ エンジン    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │         ユニバーサルツール制御システム                   │ │
│  │  - すべてのツールを自然言語ポリシーで判定               │ │
│  │  - ツール名からリスクレベルを自動推定                   │ │
│  │  - 動的な制約・義務の適用                               │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 主要な特徴

### 1. ユニバーサルツール制御

従来のハードコーディングやパターンマッチングを廃止し、自然言語ポリシーによる動的な判定を採用：

```typescript
// tool-control-policy.ts
export const TOOL_CONTROL_POLICY = {
  name: 'mcp-tool-control-policy',
  policy: `
MCPツール制御ポリシー：

【リスク判定基準】
高リスク（厳格な制御）:
- bash, shell, exec, cmd, powershell を含むツール
- system, os, process を含むツール
- delete, remove, destroy を含むツール
- admin, root, sudo を含むツール
- agent（再帰的実行）を含むツール

中リスク（標準制御）:
- write, create, update, modify, edit を含むツール
- move, rename, copy を含むツール
- config, setting を含むツール

低リスク（最小限の制御）:
- read, get, list, search, find を含むツール
- view, show, display を含むツール
- info, status, stat を含むツール
- todo, task, note を含むツール
`
};
```

### 2. 自然言語による柔軟な判定

AIがツール名とコンテキストから動的にリスクを判定：

```typescript
// 判定例
{
  tool: "bash",
  decision: "DENY",
  reason: "ツール名がbashであり、高リスクツールに該当するため",
  constraints: ["実行内容の詳細ログ記録が必須", "危険なパラメータのブロック"]
}

{
  tool: "filesystem__read_file", 
  decision: "PERMIT",
  reason: "リソースがファイルの読み取りであり、低リスクツール",
  obligations: ["基本的なアクセスログの記録"]
}
```

### 3. シンプルな設定

複雑な設定ファイルは不要。既存のMCPサーバー設定のみ：

```json
// aegis-mcp-config.json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path"]
    }
  }
}
```

### 4. 個別ポリシーとの連携

特定のクライアント向けポリシーで、ツール制御ポリシーを参照：

```typescript
// claude-desktop-policy.ts
export const CLAUDE_DESKTOP_POLICY = {
  name: 'claude-desktop-policy',
  policy: `
【ツール実行ポリシー】
- ファイルシステムの書き込み系操作（write_file, edit_file等）は禁止
- ファイルシステムの読み取り系操作は許可
- その他のツールは、tool-control-policyに従って判定
`
};
```

## 実装のポイント

### 1. ツール名の正規化

すべてのツールはプロキシ内で`tool:`プレフィックスを持つ：

```typescript
// 例：
// filesystem__read_file → tool:filesystem__read_file
// Bash → tool:Bash
// TodoRead → tool:TodoRead
```

### 2. リスクレベルの自動判定

AIがツール名から自動的にリスクを判定し、適切な制約・義務を適用：

- **高リスク**: 詳細ログ、パラメータ検証、監査レポート
- **中リスク**: 実行ログ、大量操作警告
- **低リスク**: 基本的なアクセスログ

### 3. 動的な拡張性

新しいツールが追加されても、ポリシーの更新だけで対応可能：

```typescript
// 新しいツールが追加されても自動的に判定
"tool:new_dangerous_tool" → 高リスク（"dangerous"を含む）
"tool:safe_viewer" → 低リスク（"view"を含む）
```

## 利点

1. **シンプル**: 複雑な設定ファイルやハードコーディング不要
2. **柔軟**: 自然言語による動的な判定
3. **ユニバーサル**: あらゆるMCPクライアントに対応
4. **安全**: AIによる適切なリスク判定と制御
5. **拡張可能**: 新しいツールも自動的に制御対象

## セキュリティ考慮事項

- 未知のツールはAIが名前から推定してリスク判定
- 高リスクツールは常に厳格な制御を適用
- すべての判定は監査ログに記録
- 例外的なツール（TodoRead等）も明示的に定義

## まとめ

AEGIS ユニバーサルMCPプロキシは、自然言語ポリシーの力を活用して、複雑な設定なしに安全で柔軟なツール制御を実現します。これにより、様々なMCPクライアント環境で統一的なセキュリティポリシーを適用できます。