
> aegis-policy-engine@1.0.0 test
> NODE_ENV=test jest

ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[ts-jest-transformer] (WARN) Define `ts-jest` config under `globals` is deprecated. Please do
transform: {
    <transform_regex>: ['ts-jest', { /* ts-jest config goes here in Jest */ }],
},
See more at https://kulshekhar.github.io/ts-jest/docs/getting-started/presets#advanced
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
ts-jest[config] (WARN) 
    The "ts-jest" config option "isolatedModules" is deprecated and will be removed in v30.0.0. Please use "isolatedModules: true" in /Users/shingo/Develop/aegis-policy-engine/tsconfig.test.json instead, see https://www.typescriptlang.org/tsconfig/#isolatedModules
  
[AI Judgment] Initializing with provider: anthropic
[AI Judgment] Using Anthropic Claude API for real AI judgment
2026-02-13 09:26:56 [aegis] [31merror[39m: Failed to start MCP Proxy Server: listen EADDRINUSE: address already in use :::3000 {"code":"EADDRINUSE","errno":-48,"syscall":"listen","address":"::","port":3000,"stack":"Error: listen EADDRINUSE: address already in use :::3000\n    at Server.setupListenHandle [as _listen2] (node:net:1908:16)\n    at listenInCluster (node:net:1965:12)\n    at Server.listen (node:net:2067:7)\n    at Function.listen (/Users/shingo/Develop/aegis-policy-engine/node_modules/express/lib/application.js:635:24)\n    at /Users/shingo/Develop/aegis-policy-engine/dist/src/mcp/http-proxy.js:665:31\n    at new Promise (<anonymous>)\n    at MCPHttpPolicyProxy.start (/Users/shingo/Develop/aegis-policy-engine/dist/src/mcp/http-proxy.js:663:15)\n    at async startMCPServer (/Users/shingo/Develop/aegis-policy-engine/dist/src/mcp-server.js:199:9)\n    at async main (/Users/shingo/Develop/aegis-policy-engine/dist/src/mcp-server.js:376:5)"}
FAIL src/test/e2e/mcp-proxy-integration.test.ts
  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º è¨±å¯ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚ŠãŒæˆåŠŸã™ã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º ç¦æ­¢ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãŒæ‹’å¦ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º åˆ¶ç´„ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§åŒ¿ååŒ–ãŒé©ç”¨ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§å–å¾—ãŒåˆ¶å¾¡ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º ãƒªã‚½ãƒ¼ã‚¹èª­ã¿å–ã‚ŠãŒãƒãƒªã‚·ãƒ¼ã§åˆ¶å¾¡ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ç›£æŸ»ã¨ãƒ­ã‚°è¨˜éŒ² â€º ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ç›£æŸ»ã¨ãƒ­ã‚°è¨˜éŒ² â€º ãƒãƒªã‚·ãƒ¼é•åãŒç‰¹åˆ¥ã«ãƒãƒ¼ã‚¯ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â€º åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¿”ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ç„¡åŠ¹ãªãƒ„ãƒ¼ãƒ«åã§ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

FAIL test/integration/real-ai-api.test.ts
  â— AIåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ - å®ŸAPIãƒ†ã‚¹ãƒˆ â€º å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ç¢ºèª â€º ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒªã‚·ãƒ¼åˆ¤å®š - å®Ÿéš›ã«APIã‚’å‘¼ã³å‡ºã™

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      76 |         // åŸºæœ¬çš„ãªã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
      77 |         expect(decision.decision).toMatch(/PERMIT|DENY|INDETERMINATE/);
    > 78 |         expect(decision.confidence).toBeGreaterThan(0);
         |                                     ^
      79 |         expect(decision.reason).toBeTruthy();
      80 |         expect(elapsed).toBeLessThan(10000); // 10ç§’ä»¥å†…
      81 |

      at Object.<anonymous> (test/integration/real-ai-api.test.ts:78:37)

  â— AIåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ - å®ŸAPIãƒ†ã‚¹ãƒˆ â€º å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ç¢ºèª â€º ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‹•ä½œç¢ºèª

    expect(received).toBeLessThan(expected)

    Expected: < 22.900000000000002
    Received:   224

      121 |
      122 |       // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®å–å¾—ã¯é«˜é€Ÿã§ã‚ã‚‹ã¹ã
    > 123 |       expect(time2).toBeLessThan(time1 * 0.1); // 10%æœªæº€ã®æ™‚é–“
          |                     ^
      124 |       expect(decision2).toEqual(decision1); // åŒã˜çµæœ
      125 |
      126 |       console.log(`\nâœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ­£å¸¸ã«å‹•ä½œ: ${Math.round((1 - time2/time1) * 100)}% é«˜é€ŸåŒ–`);

      at Object.<anonymous> (test/integration/real-ai-api.test.ts:123:21)

  â— AIåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ - å®ŸAPIãƒ†ã‚¹ãƒˆ â€º å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ç¢ºèª â€º è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ã§ã®åˆ¤å®š

    expect(received).toContain(expected) // indexOf

    Expected substring: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
    Received string:    "AIåˆ¤å®šã‚¨ãƒ©ãƒ¼: Anthropic API Error: 401 {\"type\":\"error\",\"error\":{\"type\":\"authentication_error\",\"message\":\"invalid x-api-key\"},\"request_id\":\"req_011CY57tfah5MKuCtsG1NEXi\"}"

      170 |       // ã‚ˆã‚Šè©³ç´°ãªåˆ†æ
      171 |       expect(decision.decision).toBeDefined();
    > 172 |       expect(decision.reason).toContain('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£');
          |                               ^
      173 |       
      174 |       if (decision.obligations?.length) {
      175 |         console.log('\nğŸ“Œ AIãŒæ¨å¥¨ã™ã‚‹ç¾©å‹™:', decision.obligations);

      at Object.<anonymous> (test/integration/real-ai-api.test.ts:172:31)

FAIL test/constraints-obligations.test.ts
  â— åˆ¶ç´„ãƒ»ç¾©å‹™å‡¦ç† - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ObligationExecutor - ç¾©å‹™ã®å®Ÿè¡Œ â€º è¤‡æ•°ç¾©å‹™ã®ä¸¦åˆ—å®Ÿè¡Œ â€º è¤‡æ•°ã®ç¾©å‹™ã‚’åŠ¹ç‡çš„ã«ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'send')

      441 |         // å…¨ã¦ã®ç¾©å‹™ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
      442 |         expect(executor['auditLogger'].log).toHaveBeenCalled();
    > 443 |         expect(executor['notificationService'].send).toHaveBeenCalled();
          |                                                ^
      444 |
      445 |         // ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚Šã€é †æ¬¡å®Ÿè¡Œã‚ˆã‚Šé«˜é€Ÿã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      446 |         expect(elapsed).toBeLessThan(1000); // å„ç¾©å‹™ãŒ200msç¨‹åº¦ã¨ä»®å®š

      at Object.<anonymous> (test/constraints-obligations.test.ts:443:48)

  â— åˆ¶ç´„ãƒ»ç¾©å‹™å‡¦ç† - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ObligationExecutor - ç¾©å‹™ã®å®Ÿè¡Œ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ç¾©å‹™å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ãŒå‡¦ç†ã¯ç¶™ç¶šã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'send')

      459 |
      460 |         // é€šçŸ¥é€ä¿¡ã‚’ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
    > 461 |         executor['notificationService'].send.mockRejectedValueOnce(
          |                                         ^
      462 |           new Error('Notification service unavailable')
      463 |         );
      464 |

      at Object.<anonymous> (test/constraints-obligations.test.ts:461:41)

FAIL src/test/mcp-http-proxy-extended.test.ts
  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š â€º ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒãªã„å ´åˆã¯UUIDã‚’ç”Ÿæˆã™ã‚‹

    expect(received).toBeDefined()

    Received: undefined

      208 |       // UUIDãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      209 |       const context = proxy['requestContext'].get('test-uuid-123');
    > 210 |       expect(context).toBeDefined();
          |                       ^
      211 |     });
      212 |
      213 |     it('ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡å¾Œã«å¤ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹', () => {

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:210:23)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒªã‚½ãƒ¼ã‚¹èª­ã¿å–ã‚Šçµæœã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:272:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒ„ãƒ¼ãƒ«åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:301:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§stdioã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ ã™ã‚‹

    TypeError: this.stdioRouter.addServerFromConfig is not a function

      540 |       this.enableBridgeMode();
      541 |     }
    > 542 |     this.stdioRouter!.addServerFromConfig(name, config);
          |                       ^
      543 |     this.logger.info(`Stdio upstream server configured: ${name}`);
      544 |   }
      545 |   

      at MCPHttpPolicyProxy.addStdioUpstreamServer (src/mcp/http-proxy.ts:542:23)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:327:13)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:350:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ â€º ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¤§æ–‡å­—ã®å ´åˆã‚‚å‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, ObjectContaining {"agent": "TEST-AGENT"}, Any<Object>

    Number of calls: 0

      402 |       await enforcePolicy('read', 'test://resource', context);
      403 |
    > 404 |       expect(mockJudgmentEngine.makeDecision).toHaveBeenCalledWith(
          |                                               ^
      405 |         expect.any(String),
      406 |         expect.objectContaining({
      407 |           agent: 'TEST-AGENT'

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:404:47)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º åŒ…æ‹¬çš„ãªãƒ˜ãƒ«ã‚¹æƒ…å ±ã‚’è¿”ã™

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:416:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Upstream request failed", Any<Error>

    Number of calls: 0

      467 |       ).rejects.toThrow();
      468 |
    > 469 |       expect(mockLogger.error).toHaveBeenCalledWith(
          |                                ^
      470 |         expect.stringContaining('Upstream request failed'),
      471 |         expect.any(Error)
      472 |       );

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:469:32)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º JSON-RPCã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã™ã‚‹

    expect(received).rejects.toThrow(expected)

    Expected substring: "Internal error"
    Received message:   "No upstream servers available"

          398 |     
          399 |     if (!upstreamServer) {
        > 400 |       throw new Error('No upstream servers available');
              |             ^
          401 |     }
          402 |     
          403 |     try {

      at MCPHttpPolicyProxy.forwardToUpstream (src/mcp/http-proxy.ts:400:13)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:491:9)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:492:17)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’å‡¦ç†ã™ã‚‹

    expect(received).rejects.toThrow(expected)

    Expected substring: "Request failed with status 500"
    Received message:   "No upstream servers available"

          398 |     
          399 |     if (!upstreamServer) {
        > 400 |       throw new Error('No upstream servers available');
              |             ^
          401 |     }
          402 |     
          403 |     try {

      at MCPHttpPolicyProxy.forwardToUpstream (src/mcp/http-proxy.ts:400:13)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:505:9)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:506:17)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º APIç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:512:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º APIç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:539:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º APIç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º ç„¡åŠ¹ãªãƒãƒªã‚·ãƒ¼ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:567:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º MCPç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º MCPãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:594:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º MCPç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º MCPå‡¦ç†ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:633:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åœæ­¢å‡¦ç† â€º HTTPã‚µãƒ¼ãƒãƒ¼ã‚’é©åˆ‡ã«åœæ­¢ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:669:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åœæ­¢å‡¦ç† â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚‚åœæ­¢ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:681:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åœæ­¢å‡¦ç† â€º åœæ­¢æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:688:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'bind')

      704 |       proxy.addPolicy('default-policy', 'Default policy content');
      705 |       
    > 706 |       const selectPolicy = proxy['selectPolicy'].bind(proxy);
          |                                                  ^
      707 |       const policy = selectPolicy('unknown-action', 'unknown-resource');
      708 |       
      709 |       expect(policy).toBe('Default policy content');

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:706:50)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'bind')

      715 |       proxy.addPolicy('file-system-policy', 'File system policy');
      716 |       
    > 717 |       const selectPolicy = proxy['selectPolicy'].bind(proxy);
          |                                                  ^
      718 |       
      719 |       expect(selectPolicy('read', 'customer://data')).toBe('Customer data policy');
      720 |       expect(selectPolicy('read', 'email://inbox')).toBe('Email access policy');

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:717:50)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚·ãƒ¼é¸æŠã‚’è¡Œã†

    TypeError: Cannot read properties of undefined (reading 'bind')

      725 |       proxy.addPolicy('claude-desktop-policy', 'Claude Desktop policy');
      726 |       
    > 727 |       const selectPolicy = proxy['selectPolicy'].bind(proxy);
          |                                                  ^
      728 |       const policy = selectPolicy('read', 'test://resource', 'claude-desktop');
      729 |       
      730 |       expect(policy).toBe('Claude Desktop policy');

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:727:50)

FAIL src/test/error-handling/external-dependencies-failures.test.ts (5.538 s)
  â— External Dependencies and Integration Failures â€º Network Service Failures â€º should handle DNS resolution failures

    TypeError: Cannot set property lookup of #<Object> which has only a getter

      50 |
      51 |       // Mock DNS failure
    > 52 |       (dns.lookup as jest.Mock) = jest.fn((hostname, callback) => {
         |                                ^
      53 |         callback(new Error('ENOTFOUND: DNS lookup failed'), null);
      54 |       });
      55 |

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:52:32)

  â— External Dependencies and Integration Failures â€º Network Service Failures â€º should handle SSL/TLS certificate errors

    TypeError: http_proxy_1.MCPHttpProxy is not a constructor

      75 |
      76 |     it('should handle SSL/TLS certificate errors', async () => {
    > 77 |       const httpProxy = new MCPHttpProxy({
         |                         ^
      78 |         port: 3000,
      79 |         upstreamMCPServers: [{
      80 |           url: 'https://secure.example.com',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:77:25)

  â— External Dependencies and Integration Failures â€º Network Service Failures â€º should handle proxy connection failures

    TypeError: http_proxy_1.MCPHttpProxy is not a constructor

      110 |       process.env.HTTPS_PROXY = 'http://proxy.example.com:8080';
      111 |       
    > 112 |       const httpProxy = new MCPHttpProxy({
          |                         ^
      113 |         port: 3000,
      114 |         upstreamMCPServers: [{
      115 |           url: 'https://api.example.com',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:112:25)

  â— External Dependencies and Integration Failures â€º External API Failures â€º should handle OpenAI API outage

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      173 |       });
      174 |
    > 175 |       expect(result.decision).toBe('PERMIT');
          |                               ^
      176 |       expect(result.reason).toContain('Fallback');
      177 |       expect(mockLogger.warn).toHaveBeenCalledWith(
      178 |         expect.stringContaining('Primary LLM failed, using fallback'),

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:175:31)

  â— External Dependencies and Integration Failures â€º External API Failures â€º should handle GeoIP service rate limiting

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {}

      207 |       };
      208 |
    > 209 |       await expect(
          |             ^
      210 |         geoRestrictor.apply('geo-restrict:JP', {}, context)
      211 |       ).rejects.toThrow('Rate limit exceeded');
      212 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:209:13)

  â— External Dependencies and Integration Failures â€º Message Queue and Event Bus Failures â€º should handle event bus disconnection

    TypeError: auditSystem.publishEvent is not a function

      285 |
      286 |       await expect(
    > 287 |         auditSystem.publishEvent({
          |                     ^
      288 |           type: 'policy.decision',
      289 |           data: {
      290 |             decision: 'DENY',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:287:21)

  â— External Dependencies and Integration Failures â€º Database and Storage Failures â€º should handle database connection pool exhaustion

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"executedAt": 2026-02-13T00:26:55.552Z, "metadata": {"actionId": "action-1770942415549-acg23oz0g", "actionType": "delete", "resource": "customer-data", "scheduledFor": 2027-02-13T00:26:55.551Z}, "success": true}

      321 |       (dataLifecycle as any).db = mockDb;
      322 |
    > 323 |       await expect(
          |             ^
      324 |         dataLifecycle.execute(
      325 |           'schedule-deletion:30d',
      326 |           {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:323:13)

  â— External Dependencies and Integration Failures â€º Database and Storage Failures â€º should handle storage quota exceeded

    TypeError: auditSystem.writeAuditLog is not a function

      363 |
      364 |       await expect(
    > 365 |         auditSystem.writeAuditLog({
          |                     ^
      366 |           timestamp: new Date(),
      367 |           action: 'test',
      368 |           decision: 'PERMIT',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:365:21)

  â— External Dependencies and Integration Failures â€º Authentication and Authorization Failures â€º should handle OAuth token expiration

    TypeError: http_proxy_1.MCPHttpProxy is not a constructor

      421 |   describe('Authentication and Authorization Failures', () => {
      422 |     it('should handle OAuth token expiration', async () => {
    > 423 |       const httpProxy = new MCPHttpProxy({
          |                         ^
      424 |         port: 3000,
      425 |         upstreamMCPServers: [{
      426 |           url: 'https://oauth-api.example.com',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:423:25)

  â— External Dependencies and Integration Failures â€º Authentication and Authorization Failures â€º should handle API key revocation

    expect(received).toContain(expected) // indexOf

    Expected substring: "Authentication failed"
    Received string:    "AIåˆ¤å®šã‚¨ãƒ©ãƒ¼: Invalid API key: Key has been revoked"

      500 |
      501 |       expect(result.decision).toBe('INDETERMINATE');
    > 502 |       expect(result.reason).toContain('Authentication failed');
          |                             ^
      503 |       
      504 |       expect(mockLogger.critical).toHaveBeenCalledWith(
      505 |         expect.stringContaining('API key revoked'),

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:502:29)

FAIL src/test/integration/mcp-enforcement.test.ts
  â— MCP + EnforcementSystem Integration â€º Stdio Proxy Integration â€º should use EnforcementSystem for constraints

    TypeError: Cannot read properties of undefined (reading 'contents')

      78 |
      79 |       // åŒ¿ååŒ–ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 80 |       const parsedContent = JSON.parse(result.contents[0].text);
         |                                               ^
      81 |       expect(parsedContent.name).toBe('[REDACTED]');
      82 |       expect(parsedContent.email).toMatch(/\*\*\*\*@example\.com/);
      83 |       expect(parsedContent.phone).toBe('[REDACTED]');

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:80:47)

  â— MCP + EnforcementSystem Integration â€º Stdio Proxy Integration â€º should use EnforcementSystem for obligations

    expect(received).toContain(expected) // indexOf

    Expected value: "ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²"
    Received array: []

      101 |
      102 |       // ç¾©å‹™ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    > 103 |       expect(executedObligations).toContain('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²');
          |                                   ^
      104 |       expect(executedObligations).toContain('30æ—¥å¾Œå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š');
      105 |     });
      106 |

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:103:35)

  â— MCP + EnforcementSystem Integration â€º Stdio Proxy Integration â€º should handle constraint errors gracefully

    expect(received).toEqual(expected) // deep equality

    Expected: {"test": "data"}
    Received: undefined

      118 |       );
      119 |
    > 120 |       expect(result).toEqual(testData);
          |                      ^
      121 |     });
      122 |   });
      123 |

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:120:22)

  â— MCP + EnforcementSystem Integration â€º HTTP Proxy Integration â€º should use EnforcementSystem for constraints

    TypeError: Cannot read properties of undefined (reading 'contents')

      150 |
      151 |       // åŒ¿ååŒ–ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 152 |       const parsedContent = JSON.parse(result.contents[0].text);
          |                                               ^
      153 |       expect(parsedContent.name).toBe('[REDACTED]');
      154 |       expect(parsedContent.email).toMatch(/\*\*\*\*@example\.com/);
      155 |       expect(parsedContent.ssn).toBe('[REDACTED]');

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:152:47)

  â— MCP + EnforcementSystem Integration â€º HTTP Proxy Integration â€º should use EnforcementSystem for obligations

    expect(received).toContain(expected) // indexOf

    Expected value: "ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²"
    Received array: []

      172 |
      173 |       // ç¾©å‹™ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    > 174 |       expect(executedObligations).toContain('ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²');
          |                                   ^
      175 |       expect(executedObligations).toContain('ã‚¢ã‚¯ã‚»ã‚¹é€šçŸ¥é€ä¿¡');
      176 |     });
      177 |

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:174:35)

  â— MCP + EnforcementSystem Integration â€º Legacy to New System Migration â€º should not have any legacy anonymization code in stdio proxy

    expect(received).toBeUndefined()

    Received: [Function sendNotification]

      203 |       // ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèª
      204 |       expect((stdioProxy as any).anonymizeData).toBeUndefined();
    > 205 |       expect((stdioProxy as any).sendNotification).toBeUndefined();
          |                                                    ^
      206 |       expect((stdioProxy as any).scheduleDataDeletion).toBeUndefined();
      207 |       expect((stdioProxy as any).generateAccessReport).toBeUndefined();
      208 |     });

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:205:52)

FAIL src/test/mcp-stdio-proxy.test.ts
  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º MCPã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "name": "aegis-policy-proxy",
    +   "name": "aegis-proxy",
        "version": "1.0.0",
      },
      Object {
        "capabilities": Object {
    -     "resources": Object {},
    +     "prompts": Object {},
    +     "resources": Object {
    +       "listChanged": true,
    +     },
          "tools": Object {},
        },
      },

    Number of calls: 1

      148 |   describe('åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', () => {
      149 |     it('MCPã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹', () => {
    > 150 |       expect(Server).toHaveBeenCalledWith(
          |                      ^
      151 |         {
      152 |           name: 'aegis-policy-proxy',
      153 |           version: '1.0.0'

      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:150:22)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º resources/read ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:198:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º resources/read ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:198:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º DENYã®åˆ¤å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:228:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º DENYã®åˆ¤å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:228:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º tools/call ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:255:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º tools/call ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:255:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º åˆ¶ç´„ã‚’é©ç”¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŠ å·¥ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:307:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º åˆ¶ç´„ã‚’é©ç”¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŠ å·¥ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:307:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º tools/list ã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’è¿”ã™

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:343:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º tools/list ã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’è¿”ã™

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:343:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º resources/list ã§åˆ©ç”¨å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚’è¿”ã™

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:370:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º resources/list ã§åˆ©ç”¨å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚’è¿”ã™

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:370:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º è¨­å®šã•ã‚ŒãŸä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’ç™»éŒ²ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:382:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º è¨­å®šã•ã‚ŒãŸä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’ç™»éŒ²ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:382:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º å…¨ã¦ã®ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:394:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º å…¨ã¦ã®ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:394:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º åœæ­¢æ™‚ã«ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:403:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º åœæ­¢æ™‚ã«ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:403:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼æ™‚ã«INDETERMINATEã¨ã—ã¦å‡¦ç†

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:419:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼æ™‚ã«INDETERMINATEã¨ã—ã¦å‡¦ç†

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:419:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:448:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:448:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ãƒ»æ›´æ–°ã§ãã‚‹

    TypeError: proxy.updatePolicy is not a function

      469 |       expect(proxy['policies'].get('test-policy')).toBe('ãƒ†ã‚¹ãƒˆãƒãƒªã‚·ãƒ¼å†…å®¹');
      470 |
    > 471 |       proxy.updatePolicy('test-policy', 'æ›´æ–°ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼å†…å®¹');
          |             ^
      472 |       expect(proxy['policies'].get('test-policy')).toBe('æ›´æ–°ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼å†…å®¹');
      473 |     });
      474 |

      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:471:13)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ â€º è¤‡æ•°ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:502:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ â€º è¤‡æ•°ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ğŸš€ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:502:7)

FAIL src/test/mcp/base-proxy.test.ts
  â— MCPPolicyProxyBase â€º initialization â€º should work without judgment engine

    AIJudgmentEngine is required for AIPolicyEngine

      48 |     // AIãƒãƒªã‚·ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
      49 |     if (!judgmentEngine) {
    > 50 |       throw new Error('AIJudgmentEngine is required for AIPolicyEngine');
         |             ^
      51 |     }
      52 |     this.aiPolicyEngine = new AIPolicyEngine(judgmentEngine, {
      53 |       aiThreshold: parseFloat(process.env.AEGIS_AI_THRESHOLD || '0.7'),

      at new MCPPolicyProxyBase (src/mcp/base-proxy.ts:50:13)
      at new TestMCPProxy (src/test/mcp/base-proxy.test.ts:29:9)
      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:150:30)

  â— MCPPolicyProxyBase â€º selectApplicablePolicy â€º should select high-risk-operations-policy for dangerous actions

    expect(received).toBe(expected) // Object.is equality

    Expected: "high-risk-operations-policy"
    Received: "file-system-policy"

      217 |
      218 |       const policy = await proxy.testSelectApplicablePolicy(deleteContext);
    > 219 |       expect(policy).toBe('high-risk-operations-policy');
          |                      ^
      220 |     });
      221 |
      222 |     it('should select default-policy when no specific policy matches', async () => {

      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:219:22)

  â— MCPPolicyProxyBase â€º addPolicy â€º should add policy to internal map

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Policy added: test-policy"
    Received
           1: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: time-based"
           2: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: agent-info"
           3: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: resource-classifier"

    Number of calls: 5

      357 |
      358 |       expect(proxy.getPolicies().get('test-policy')).toBe('Test policy content');
    > 359 |       expect(mockLogger.info).toHaveBeenCalledWith('Policy added: test-policy');
          |                               ^
      360 |     });
      361 |
      362 |     it('should handle policy addition errors gracefully', () => {

      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:359:31)

  â— MCPPolicyProxyBase â€º addPolicy â€º should handle policy addition errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Policy added: error-policy"
    Received
           1: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: time-based"
           2: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: agent-info"
           3: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: resource-classifier"

    Number of calls: 5

      366 |       // Should still add to internal map
      367 |       expect(proxy.getPolicies().get('error-policy')).toBe('Error policy content');
    > 368 |       expect(mockLogger.info).toHaveBeenCalledWith('Policy added: error-policy');
          |                               ^
      369 |     });
      370 |   });
      371 |

      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:368:31)

FAIL src/test/core-controller.test.ts
  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 4
    Received number of calls: 5

      103 |       expect(AIJudgmentEngine).toHaveBeenCalledWith(testConfig.llm);
      104 |       expect(ContextCollector).toHaveBeenCalled();
    > 105 |       expect(mockContextCollector.registerEnricher).toHaveBeenCalledTimes(4); // 4ã¤ã®ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼
          |                                                     ^
      106 |       expect(mockLogger.info).toHaveBeenCalledWith('Context enrichers registered successfully');
      107 |     });
      108 |

      at Object.<anonymous> (src/test/core-controller.test.ts:105:53)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      109 |     it('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹', () => {
      110 |       // setupDefaultPoliciesãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 111 |       expect(controller['policies'].size).toBeGreaterThan(0);
          |                                           ^
      112 |     });
      113 |   });
      114 |

      at Object.<anonymous> (src/test/core-controller.test.ts:111:43)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º å®Œå…¨ãªåˆ¤å®šãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, {"action": "read", "agent": "test-agent", "environment": {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}, "resource": "customer://data/123", "time": 2026-02-13T00:26:59.682Z}, {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}

    Number of calls: 0

      162 |       );
      163 |
    > 164 |       expect(mockJudgmentEngine.makeDecision).toHaveBeenCalledWith(
          |                                               ^
      165 |         expect.any(String), // ãƒãƒªã‚·ãƒ¼æ–‡å­—åˆ—
      166 |         enrichedContext,
      167 |         enrichedContext.environment

      at Object.<anonymous> (src/test/core-controller.test.ts:164:47)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º DENYã®åˆ¤å®šã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "external-agent", "DENY", "customer://all-data", "External agents cannot delete customer data"

    Number of calls: 0

      218 |       expect(result.decision).toBe('DENY');
      219 |       expect(result.riskLevel).toBe('CRITICAL');
    > 220 |       expect(mockLogger.decision).toHaveBeenCalledWith(
          |                                   ^
      221 |         'external-agent',
      222 |         'DENY',
      223 |         'customer://all-data',

      at Object.<anonymous> (src/test/core-controller.test.ts:220:35)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º æ±ºå®šå±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      338 |
      339 |       // å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 340 |       expect(controller['decisionHistory']).toHaveLength(1);
          |                                             ^
      341 |       expect(controller['decisionHistory'][0]).toMatchObject({
      342 |         timestamp: expect.any(Date),
      343 |         context: enrichedContext,

      at Object.<anonymous> (src/test/core-controller.test.ts:340:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º å±¥æ­´ã®ä¸Šé™ã‚’å®ˆã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 3
    Received length: 0
    Received array:  []

      383 |
      384 |       // å±¥æ­´ãŒ3ä»¶ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 385 |       expect(limitedController['decisionHistory']).toHaveLength(3);
          |                                                    ^
      386 |       // æœ€æ–°ã®3ä»¶ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      387 |       expect(limitedController['decisionHistory'][0].context.agent).toBe('agent-1');
      388 |       expect(limitedController['decisionHistory'][2].context.agent).toBe('agent-3');

      at Object.<anonymous> (src/test/core-controller.test.ts:385:52)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º çµ±è¨ˆæƒ…å ± â€º çµ±è¨ˆæƒ…å ±ã‚’åé›†ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 5
    + Received  + 5

      Object {
    -   "averageConfidence": closeTo<0.8375, 2>,
    +   "averageConfidence": 0,
        "averageProcessingTime": Any<Number>,
    -   "denyCount": 1,
    -   "indeterminateCount": 1,
    -   "permitCount": 2,
    -   "totalDecisions": 4,
    +   "denyCount": 0,
    +   "indeterminateCount": 0,
    +   "permitCount": 0,
    +   "totalDecisions": 0,
      }

      415 |       const stats = controller.getStatistics();
      416 |
    > 417 |       expect(stats).toMatchObject({
          |                     ^
      418 |         totalDecisions: 4,
      419 |         permitCount: 2,
      420 |         denyCount: 1,

      at Object.<anonymous> (src/test/core-controller.test.ts:417:21)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º æ±ºå®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      470 |       controller.clearCache();
      471 |       
    > 472 |       expect(mockJudgmentEngine.clearCache).toHaveBeenCalled();
          |                                             ^
      473 |       expect(mockLogger.info).toHaveBeenCalledWith('Decision cache cleared');
      474 |     });
      475 |

      at Object.<anonymous> (src/test/core-controller.test.ts:472:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º å‡¦ç†æ™‚é–“ã‚’æ­£ç¢ºã«æ¸¬å®šã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 150
    Received:   55

      498 |
      499 |       // å‡¦ç†æ™‚é–“ãŒé©åˆ‡ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆä½™è£•ã‚’æŒãŸã›ã¦150msä»¥ä¸Šï¼‰
    > 500 |       expect(result.processingTime).toBeGreaterThan(150);
          |                                     ^
      501 |     });
      502 |   });
      503 | });

      at Object.<anonymous> (src/test/core-controller.test.ts:500:37)

FAIL src/test/mcp-http-proxy.test.ts
  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º Expressã‚¢ãƒ—ãƒªã¨MCPã‚µãƒ¼ãƒãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "name": "aegis-policy-proxy-http",
    +   "name": "aegis-proxy",
        "version": "1.0.0",
      },
      Object {
        "capabilities": Object {
    -     "resources": Object {},
    +     "prompts": Object {},
    +     "resources": Object {
    +       "listChanged": true,
    +     },
          "tools": Object {},
        },
      },

    Number of calls: 1

      127 |     it('Expressã‚¢ãƒ—ãƒªã¨MCPã‚µãƒ¼ãƒãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹', () => {
      128 |       expect(express).toHaveBeenCalled();
    > 129 |       expect(Server).toHaveBeenCalledWith(
          |                      ^
      130 |         {
      131 |           name: 'aegis-policy-proxy-http',
      132 |           version: '1.0.0'

      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:129:22)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:147:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º resources/read ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:176:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º tools/call ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åˆ¶ç´„ã‚’é©ç”¨ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:224:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º DENYã®åˆ¤å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:252:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ â€º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:267:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼é€šä¿¡ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:319:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼é€šä¿¡ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:354:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼é€šä¿¡ â€º ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:376:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:405:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:423:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ â€º è¤‡æ•°ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:453:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç† â€º ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ãƒ»åœæ­¢ã§ãã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:472:7)

FAIL test/core-controller.test.ts
  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 4
    Received number of calls: 5

      103 |       expect(AIJudgmentEngine).toHaveBeenCalledWith(testConfig.llm);
      104 |       expect(ContextCollector).toHaveBeenCalled();
    > 105 |       expect(mockContextCollector.registerEnricher).toHaveBeenCalledTimes(4); // 4ã¤ã®ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼
          |                                                     ^
      106 |       expect(mockLogger.info).toHaveBeenCalledWith('Context enrichers registered successfully');
      107 |     });
      108 |

      at Object.<anonymous> (test/core-controller.test.ts:105:53)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      109 |     it('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹', () => {
      110 |       // setupDefaultPoliciesãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 111 |       expect(controller['policies'].size).toBeGreaterThan(0);
          |                                           ^
      112 |     });
      113 |   });
      114 |

      at Object.<anonymous> (test/core-controller.test.ts:111:43)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º å®Œå…¨ãªåˆ¤å®šãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, {"action": "read", "agent": "test-agent", "environment": {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}, "resource": "customer://data/123", "time": 2026-02-13T00:26:59.974Z}, {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}

    Number of calls: 0

      162 |       );
      163 |
    > 164 |       expect(mockJudgmentEngine.makeDecision).toHaveBeenCalledWith(
          |                                               ^
      165 |         expect.any(String), // ãƒãƒªã‚·ãƒ¼æ–‡å­—åˆ—
      166 |         enrichedContext,
      167 |         enrichedContext.environment

      at Object.<anonymous> (test/core-controller.test.ts:164:47)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º DENYã®åˆ¤å®šã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "external-agent", "DENY", "customer://all-data", "External agents cannot delete customer data"

    Number of calls: 0

      218 |       expect(result.decision).toBe('DENY');
      219 |       expect(result.riskLevel).toBe('CRITICAL');
    > 220 |       expect(mockLogger.decision).toHaveBeenCalledWith(
          |                                   ^
      221 |         'external-agent',
      222 |         'DENY',
      223 |         'customer://all-data',

      at Object.<anonymous> (test/core-controller.test.ts:220:35)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º æ±ºå®šå±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      338 |
      339 |       // å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 340 |       expect(controller['decisionHistory']).toHaveLength(1);
          |                                             ^
      341 |       expect(controller['decisionHistory'][0]).toMatchObject({
      342 |         timestamp: expect.any(Date),
      343 |         context: enrichedContext,

      at Object.<anonymous> (test/core-controller.test.ts:340:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º å±¥æ­´ã®ä¸Šé™ã‚’å®ˆã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 3
    Received length: 0
    Received array:  []

      383 |
      384 |       // å±¥æ­´ãŒ3ä»¶ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 385 |       expect(limitedController['decisionHistory']).toHaveLength(3);
          |                                                    ^
      386 |       // æœ€æ–°ã®3ä»¶ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      387 |       expect(limitedController['decisionHistory'][0].context.agent).toBe('agent-1');
      388 |       expect(limitedController['decisionHistory'][2].context.agent).toBe('agent-3');

      at Object.<anonymous> (test/core-controller.test.ts:385:52)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º çµ±è¨ˆæƒ…å ± â€º çµ±è¨ˆæƒ…å ±ã‚’åé›†ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 5
    + Received  + 5

      Object {
    -   "averageConfidence": closeTo<0.8375, 2>,
    +   "averageConfidence": 0,
        "averageProcessingTime": Any<Number>,
    -   "denyCount": 1,
    -   "indeterminateCount": 1,
    -   "permitCount": 2,
    -   "totalDecisions": 4,
    +   "denyCount": 0,
    +   "indeterminateCount": 0,
    +   "permitCount": 0,
    +   "totalDecisions": 0,
      }

      415 |       const stats = controller.getStatistics();
      416 |
    > 417 |       expect(stats).toMatchObject({
          |                     ^
      418 |         totalDecisions: 4,
      419 |         permitCount: 2,
      420 |         denyCount: 1,

      at Object.<anonymous> (test/core-controller.test.ts:417:21)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º æ±ºå®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      470 |       controller.clearCache();
      471 |       
    > 472 |       expect(mockJudgmentEngine.clearCache).toHaveBeenCalled();
          |                                             ^
      473 |       expect(mockLogger.info).toHaveBeenCalledWith('Decision cache cleared');
      474 |     });
      475 |

      at Object.<anonymous> (test/core-controller.test.ts:472:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º å‡¦ç†æ™‚é–“ã‚’æ­£ç¢ºã«æ¸¬å®šã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 150
    Received:   52

      498 |
      499 |       // å‡¦ç†æ™‚é–“ãŒé©åˆ‡ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆä½™è£•ã‚’æŒãŸã›ã¦150msä»¥ä¸Šï¼‰
    > 500 |       expect(result.processingTime).toBeGreaterThan(150);
          |                                     ^
      501 |     });
      502 |   });
      503 | });

      at Object.<anonymous> (test/core-controller.test.ts:500:37)

FAIL src/test/integration/config-integration.test.ts
  â— Configuration Integration Tests â€º Component Configuration Integration â€º should handle missing API keys gracefully in components

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "OpenAI API key not set"

    Number of calls: 0

      70 |       (config as any).validateConfig();
      71 |
    > 72 |       expect(consoleSpy).toHaveBeenCalledWith(
         |                          ^
      73 |         expect.stringContaining('OpenAI API key not set')
      74 |       );
      75 |

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:72:26)

  â— Configuration Integration Tests â€º Security Integration Tests â€º should prevent system startup with default secret in production

    [Config] Secret key must be changed in production environment

      175 |     // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæ¤œè¨¼
      176 |     if (this.config.nodeEnv === 'production' && this.config.secretKey === DEFAULT_SECRET_KEY) {
    > 177 |       throw new Error('[Config] Secret key must be changed in production environment');
          |             ^
      178 |     }
      179 |
      180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {

      at Config.validateConfig (src/utils/config.ts:177:13)
      at new Config (src/utils/config.ts:87:10)
      at Object.<anonymous> (src/test/integration/config-integration.test.ts:86:22)

  â— Configuration Integration Tests â€º Configuration Update and Reload â€º should handle configuration updates correctly

    ReferenceError: Configuration is not defined

      196 |       
      197 |       // Reset singleton to reload
    > 198 |       (Configuration as any).instance = null;
          |        ^
      199 |       config = new Config();
      200 |       
      201 |       expect(config.getConfig().logLevel).toBe('debug');

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:198:8)

  â— Configuration Integration Tests â€º Error Scenarios â€º should handle invalid port numbers gracefully

    expect(received).toBeTruthy()

    Received: false

      224 |       const port = config.getConfig().port;
      225 |       
    > 226 |       expect(isNaN(port)).toBeTruthy();
          |                           ^
      227 |     });
      228 |
      229 |     it('should handle malformed JSON in upstream servers', () => {

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:226:27)

  â— Configuration Integration Tests â€º Error Scenarios â€º should handle malformed JSON in upstream servers

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 3

    - Object {}
    + Object {
    +   "{\"invalid\"": " json}",
    + }

      232 |       const config = new Config();
      233 |       // Should fallback to empty object or handle error
    > 234 |       expect(config.getConfig().mcpProxy.upstreamServers).toEqual({});
          |                                                           ^
      235 |     });
      236 |
      237 |     it('should handle invalid boolean values', () => {

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:234:59)

FAIL test/ai-judgment-engine.test.ts
  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ â†’ AIåˆ¤å®šå¤‰æ› â€º é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’æ­£ã—ãåˆ¤å®šã§ãã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      72 |       const decision = await engine.judge(context, policy);
      73 |
    > 74 |       expect(decision.decision).toBe('PERMIT');
         |                                 ^
      75 |       expect(decision.confidence).toBe(0.95);
      76 |       expect(decision.constraints).toContain('å€‹äººæƒ…å ±ã®åŒ¿ååŒ–');
      77 |       expect(decision.obligations).toContain('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²');

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:74:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ â†’ AIåˆ¤å®šå¤‰æ› â€º å–¶æ¥­æ™‚é–“å¤–ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦ã•ã‚Œã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

       97 |
       98 |       const decision = await engine.judge(context);
    >  99 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      100 |       expect(decision.reason).toContain('å–¶æ¥­æ™‚é–“å¤–');
      101 |     });
      102 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:99:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š â€º ç·Šæ€¥æ™‚ã¯å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      123 |
      124 |       const decision = await engine.judge(context);
    > 125 |       expect(decision.decision).toBe('PERMIT');
          |                                 ^
      126 |       expect(decision.obligations).toContain('ä¸Šé•·ã¸ã®é€šçŸ¥');
      127 |     });
      128 |

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:125:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š â€º å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

      146 |
      147 |       const decision = await engine.judge(context);
    > 148 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      149 |       expect(decision.confidence).toBeGreaterThan(0.9);
      150 |     });
      151 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:148:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒƒãƒå‡¦ç† â€º è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã§ãã‚‹

    TypeError: engine.judgeBatch is not a function

      187 |       ]);
      188 |
    > 189 |       const decisions = await engine.judgeBatch(contexts);
          |                                      ^
      190 |       
      191 |       expect(decisions).toHaveLength(2);
      192 |       expect(decisions[0].decision).toBe('PERMIT');

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:189:38)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º LLMã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ï¼ˆDENYï¼‰ã«å€’ã™

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

      210 |       const decision = await engine.judge(context);
      211 |       
    > 212 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      213 |       expect(decision.reason).toContain('ã‚¨ãƒ©ãƒ¼');
      214 |       expect(decision.confidence).toBe(0);
      215 |     });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:212:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã‚‚å‡¦ç†ã‚’ç¶™ç¶š

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

      231 |       const decision = await engine.judge(context);
      232 |       
    > 233 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      234 |       expect(decision.reason).toContain('å½¢å¼ã‚¨ãƒ©ãƒ¼');
      235 |     });
      236 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:233:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆ¤å®šä¿¡é ¼åº¦ã®å‡¦ç† â€º ä½ä¿¡é ¼åº¦ã®åˆ¤å®šã¯ç†ç”±ã«å«ã‚ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.4
    Received: 0

      256 |       const decision = await engine.judge(context);
      257 |       
    > 258 |       expect(decision.confidence).toBe(0.4);
          |                                   ^
      259 |       expect(decision.reason).toContain('ä¿¡é ¼åº¦: 40%');
      260 |     });
      261 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:258:35)

FAIL src/test/mcp-stdio-proxy-extended.test.ts (6.785 s)
  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼æ©Ÿèƒ½ â€º ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒªã‚·ãƒ¼ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã™ã‚‹

    TypeError: this.stdioRouter.on is not a function

      1529 |   private setupNotificationHandling(): void {
      1530 |     // StdioRouterã‹ã‚‰ã®upstreamNotificationã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
    > 1531 |     this.stdioRouter.on('upstreamNotification', (event: {
           |                      ^
      1532 |       serverName: string;
      1533 |       notificationMethod: string;
      1534 |       notificationParams: any;

      at MCPStdioPolicyProxy.setupNotificationHandling (src/mcp/stdio-proxy.ts:1531:22)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1513:10)
      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:211:7)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç•°å¸¸æ¤œçŸ¥ â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šå¾Œã«ç•°å¸¸æ¤œçŸ¥ã‚’å®Ÿè¡Œã™ã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      267 |       await enforcePolicy('read', 'test://resource', {});
      268 |       
    > 269 |       expect(mockAnomalyDetector.detectRealTimeAnomalies).toHaveBeenCalled();
          |                                                           ^
      270 |       expect(mockLogger.info).toHaveBeenCalledWith(
      271 |         expect.stringContaining('Detected 1 real-time anomalies'),
      272 |         expect.any(Object)

      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:269:59)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ  â€º æ–°ã—ã„åˆ¤å®šçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      329 |       await enforcePolicy('read', 'test://resource', {});
      330 |       
    > 331 |       expect(mockCacheSystem.set).toHaveBeenCalled();
          |                                   ^
      332 |     });
      333 |
      334 |     it('ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹', () => {

      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:331:35)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼æ©Ÿèƒ½ â€º æˆåŠŸæ™‚ã«ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: undefined

      438 |       
      439 |       const stats = proxy.getCircuitBreakerStats();
    > 440 |       expect(stats['test-method']?.failures).toBe(0);
          |                                              ^
      441 |     });
      442 |
      443 |     it('ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“å¾Œã«ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹', async () => {

      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:440:46)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° â€º èµ·å‹•æ™‚ã«ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹

    Configuration error:

    Could not locate module ./http-proxy.js mapped as:
    $1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^(\.{1,2}\/.*)\.js$/": "$1"
      },
      "resolver": undefined
    }

      637 |       };
      638 |       
    > 639 |       jest.doMock('./http-proxy.js', () => ({
          |            ^
      640 |         MCPHttpPolicyProxy: jest.fn().mockImplementation(() => mockHttpProxy)
      641 |       }));
      642 |       

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/resolver.js:759:17)
      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:639:12)

FAIL src/test/error-handling/edge-cases-and-boundaries.test.ts
  â— Edge Cases and Boundary Value Tests â€º Input Validation Edge Cases â€º should handle extremely long policy names

    expect(received).resolves.toBeDefined()

    Received promise rejected instead of resolved
    Rejected to value: [TypeError: this.contextCollector.enrichContext is not a function]

      54 |
      55 |       // Should truncate or handle gracefully
    > 56 |       await expect(
         |             ^
      57 |         enforcer.enforcePolicy('read', 'test', context, {
      58 |           selectPolicy: async () => ({ id: '1', name: veryLongPolicyName, content: 'test' })
      59 |         } as any)

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:56:13)

  â— Edge Cases and Boundary Value Tests â€º Input Validation Edge Cases â€º should handle unicode and special characters in inputs

    expect(received).toBeDefined()

    Received: undefined

       96 |         // Should handle without crashing
       97 |         expect(result).toBeDefined();
    >  98 |         expect(result.data).toBeDefined();
          |                             ^
       99 |       }
      100 |     });
      101 |

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:98:29)

  â— Edge Cases and Boundary Value Tests â€º Input Validation Edge Cases â€º should handle empty and whitespace-only inputs

    TypeError: dynamic_tool_discovery_1.DynamicToolDiscovery is not a constructor

      110 |       ];
      111 |
    > 112 |       const discovery = new DynamicToolDiscovery(mockLogger);
          |                         ^
      113 |
      114 |       for (const input of emptyInputs) {
      115 |         // Should handle empty tool names gracefully

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:112:25)

  â— Edge Cases and Boundary Value Tests â€º Numeric Boundary Values â€º should handle rate limiter at boundaries

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      146 |       for (let i = 0; i < 3; i++) {
      147 |         const result = await rateLimiter.apply('rate-limit:3/100ms', {}, context);
    > 148 |         expect(result.rateLimited).toBe(false);
          |                                    ^
      149 |       }
      150 |
      151 |       // Just over limit

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:148:36)

  â— Edge Cases and Boundary Value Tests â€º Numeric Boundary Values â€º should handle cache size limits

    TypeError: cache.metrics is not a function

      186 |       }
      187 |
    > 188 |       const stats1 = await cache.metrics();
          |                                  ^
      189 |       expect(stats1.size).toBe(3);
      190 |       expect(stats1.evictions).toBe(0);
      191 |

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:188:34)

  â— Edge Cases and Boundary Value Tests â€º Date and Time Edge Cases â€º should handle various date formats and edge cases

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      285 |             { decision: 'PERMIT', reason: 'Test', confidence: 0.9 }
      286 |           );
    > 287 |           expect(result.logged).toBe(true);
          |                                 ^
      288 |         }
      289 |       }
      290 |     });

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:287:33)

  â— Edge Cases and Boundary Value Tests â€º Concurrency Edge Cases â€º should handle exactly simultaneous requests

    expect(received).toMatch(expected)

    Matcher error: received value must be a string

    Received has value: undefined

      412 |       const result = await cache.get(context, 'policy', {});
      413 |       expect(result).toBeDefined();
    > 414 |       expect(result?.reason).toMatch(/Decision \d/);
          |                              ^
      415 |     });
      416 |
      417 |     it('should handle rapid policy updates without corruption', async () => {

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:414:30)

  â— Edge Cases and Boundary Value Tests â€º Memory and Buffer Edge Cases â€º should handle buffer overflow scenarios

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Large buffer allocation", ObjectContaining {"size": 16777216}

    Number of calls: 0

      560 |         
      561 |         if (size > 10 * 1024 * 1024) {
    > 562 |           expect(mockLogger.warn).toHaveBeenCalledWith(
          |                                   ^
      563 |             expect.stringContaining('Large buffer allocation'),
      564 |             expect.objectContaining({ size })
      565 |           );

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:562:35)

FAIL src/test/policy-management.test.ts
  â— PolicyAdministrator - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼CRUDæ“ä½œ â€º æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "test-policies/policy-", StringContaining "Customer Data Access Policy", {"encoding": "utf-8"}
    Received
           1: "test-policies/policy-8e08e743-e509-4b10-88b3-0fb5bba08042.json", "{
      \"name\": \"Customer Data Access Policy\",
      \"description\": \"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãƒãƒªã‚·ãƒ¼\",
      \"policy\": \"\\n        é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š\\n        \\n        ã€åŸºæœ¬åŸå‰‡ã€‘\\n        - é¡§å®¢ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½\\n        - å–¶æ¥­æ™‚é–“å†…ã®ã¿è¨±å¯\\n        - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°å¿…é ˆ\\n        \\n        ã€åˆ¶é™äº‹é …ã€‘\\n        - å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢\\n        - ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨å…±æœ‰ã¯ä¸€åˆ‡ç¦æ­¢\\n        - å€‹äººæƒ…å ±ã®é•·æœŸä¿å­˜ç¦æ­¢\\n      \",
      \"examples\": [],
      \"metadata\": {
        \"id\": \"policy-8e08e743-e509-4b10-88b3-0fb5bba08042\",
        \"name\": \"Customer Data Access Policy\",
        \"description\": \"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãƒãƒªã‚·ãƒ¼\",
        \"version\": \"1.0.0\",
        \"createdAt\": \"2026-02-13T00:27:00.237Z\",
        \"createdBy\": \"admin\",
        \"lastModified\": \"2026-02-13T00:27:00.237Z\",
        \"lastModifiedBy\": \"admin\",
        \"tags\": [
          \"customer\",
          \"data-access\"
        ],
        \"status\": \"active\"
      }
    }"
           2: "test-policies/history/policy-8e08e743-e509-4b10-88b3-0fb5bba08042.json", "[
      {
        \"version\": \"1.0.0\",
        \"policy\": \"\\n        é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š\\n        \\n        ã€åŸºæœ¬åŸå‰‡ã€‘\\n        - é¡§å®¢ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½\\n        - å–¶æ¥­æ™‚é–“å†…ã®ã¿è¨±å¯\\n        - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°å¿…é ˆ\\n        \\n        ã€åˆ¶é™äº‹é …ã€‘\\n        - å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢\\n        - ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨å…±æœ‰ã¯ä¸€åˆ‡ç¦æ­¢\\n        - å€‹äººæƒ…å ±ã®é•·æœŸä¿å­˜ç¦æ­¢\\n      \",
        \"createdAt\": \"2026-02-13T00:27:00.237Z\",
        \"createdBy\": \"admin\",
        \"changeLog\": \"Initial version\"
      }
    ]"

    Number of calls: 2

      52 |
      53 |       expect(policyId).toMatch(/^policy-[a-f0-9-]+$/);
    > 54 |       expect(fs.writeFile).toHaveBeenCalledWith(
         |                            ^
      55 |         expect.stringContaining('test-policies/policy-'),
      56 |         expect.stringContaining('Customer Data Access Policy'),
      57 |         { encoding: 'utf-8' }

      at Object.<anonymous> (src/test/policy-management.test.ts:54:28)

  â— PolicyAdministrator - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "exports", Any<String>, Any<String>
    Received
           1: "test-policies/policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58.json", "{
      \"name\": \"Export Test\",
      \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
      \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
      \"examples\": [],
      \"metadata\": {
        \"id\": \"policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58\",
        \"name\": \"Export Test\",
        \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
        \"version\": \"1.0.0\",
        \"createdAt\": \"2026-02-13T00:27:00.366Z\",
        \"createdBy\": \"system\",
        \"lastModified\": \"2026-02-13T00:27:00.366Z\",
        \"lastModifiedBy\": \"system\",
        \"tags\": [
          \"test\",
          \"export\"
        ],
        \"status\": \"active\"
      }
    }"
           2: "test-policies/history/policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58.json", "[
      {
        \"version\": \"1.0.0\",
        \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
        \"createdAt\": \"2026-02-13T00:27:00.366Z\",
        \"createdBy\": \"system\",
        \"changeLog\": \"Initial version\"
      }
    ]"
           3: "test-policies/exports/policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58-export-1770942420366.json", "{
      \"version\": \"1.0\",
      \"exportedAt\": \"2026-02-13T00:27:00.366Z\",
      \"exportedBy\": \"system\",
      \"policy\": {
        \"name\": \"Export Test\",
        \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
        \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
        \"examples\": [],
        \"metadata\": {
          \"id\": \"policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58\",
          \"name\": \"Export Test\",
          \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
          \"version\": \"1.0.0\",
          \"createdAt\": \"2026-02-13T00:27:00.366Z\",
          \"createdBy\": \"system\",
          \"lastModified\": \"2026-02-13T00:27:00.366Z\",
          \"lastModifiedBy\": \"system\",
          \"tags\": [
            \"test\",
            \"export\"
          ],
          \"status\": \"active\"
        }
      },
      \"history\": [
        {
          \"version\": \"1.0.0\",
          \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
          \"createdAt\": \"2026-02-13T00:27:00.366Z\",
          \"createdBy\": \"system\",
          \"changeLog\": \"Initial version\"
        }
      ]
    }"

    Number of calls: 3

      267 |       });
      268 |
    > 269 |       expect(fs.writeFile).toHaveBeenCalledWith(
          |                            ^
      270 |         expect.stringContaining('exports'),
      271 |         expect.any(String),
      272 |         expect.any(String)

      at Object.<anonymous> (src/test/policy-management.test.ts:269:28)

  â— PolicyAdministrator - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ°¸ç¶šåŒ– â€º ãƒãƒªã‚·ãƒ¼ä½œæˆæ™‚ã«ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "test-policies/policy-", StringContaining "Persist Test", Any<String>
    Received
           1: "test-policies/policy-9012dd5c-5d53-417e-836f-0f42b8bc5741.json", "{
      \"name\": \"Persist Test\",
      \"description\": \"Policy for Persist Test\",
      \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\næ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
      \"examples\": [],
      \"metadata\": {
        \"id\": \"policy-9012dd5c-5d53-417e-836f-0f42b8bc5741\",
        \"name\": \"Persist Test\",
        \"description\": \"Policy for Persist Test\",
        \"version\": \"1.0.0\",
        \"createdAt\": \"2026-02-13T00:27:00.492Z\",
        \"createdBy\": \"system\",
        \"lastModified\": \"2026-02-13T00:27:00.492Z\",
        \"lastModifiedBy\": \"system\",
        \"tags\": [],
        \"status\": \"active\"
      }
    }"
           2: "test-policies/history/policy-9012dd5c-5d53-417e-836f-0f42b8bc5741.json", "[
      {
        \"version\": \"1.0.0\",
        \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\næ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
        \"createdAt\": \"2026-02-13T00:27:00.492Z\",
        \"createdBy\": \"system\",
        \"changeLog\": \"Initial version\"
      }
    ]"

    Number of calls: 2

      407 |       );
      408 |
    > 409 |       expect(fs.writeFile).toHaveBeenCalledWith(
          |                            ^
      410 |         expect.stringContaining('test-policies/policy-'),
      411 |         expect.stringContaining('Persist Test'),
      412 |         expect.any(String)

      at Object.<anonymous> (src/test/policy-management.test.ts:409:28)

FAIL src/test/integration/full-mcp-flow.test.ts
  â— Full MCP Request Flow Integration â€º End-to-End Request Scenarios â€º should handle complete tool discovery and execution flow

    TypeError: policyAdmin.getAuditTrail is not a function

      206 |
      207 |       // Verify audit trail
    > 208 |       const auditEntries = await policyAdmin.getAuditTrail();
          |                                              ^
      209 |       expect(auditEntries).toContainEqual(expect.objectContaining({
      210 |         action: 'tools/call',
      211 |         resource: 'execute-command',

      at Object.<anonymous> (src/test/integration/full-mcp-flow.test.ts:208:46)

FAIL src/test/core/obligations/manager.test.ts
  â— ObligationExecutorManager â€º execution history and stats â€º should calculate execution statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 4
    Received: 3

      371 |       const stats = manager.getExecutionStats();
      372 |       
    > 373 |       expect(stats.totalExecutions).toBe(4); // 3 success + 1 fail
          |                                     ^
      374 |       expect(stats.successCount).toBe(3);
      375 |       expect(stats.failureCount).toBe(1);
      376 |       expect(stats.averageDuration).toBeGreaterThan(0);

      at Object.<anonymous> (src/test/core/obligations/manager.test.ts:373:37)

FAIL src/test/security/config-security.test.ts
  â— Configuration Security Tests â€º Secret Key Security â€º should reject weak secret keys in production

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should reject weak secret keys in production

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should enforce minimum secret key length

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should enforce minimum secret key length

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should generate cryptographically secure defaults in development

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should generate cryptographically secure defaults in development

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º API Key Security â€º should never expose API keys in error messages

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º API Key Security â€º should never expose API keys in error messages

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º API Key Security â€º should validate API key format

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º API Key Security â€º should validate API key format

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º API Key Security â€º should mask API keys in toString representations

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º API Key Security â€º should mask API keys in toString representations

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º JWT Security â€º should enforce strong JWT secrets

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º JWT Security â€º should enforce strong JWT secrets

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º JWT Security â€º should use different secrets for JWT and encryption

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º JWT Security â€º should use different secrets for JWT and encryption

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should only allow secure encryption algorithms

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should only allow secure encryption algorithms

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should validate encryption key derivation settings

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should validate encryption key derivation settings

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º CORS Security â€º should validate CORS origins

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º CORS Security â€º should validate CORS origins

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º CORS Security â€º should only allow HTTPS origins in production

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º CORS Security â€º should only allow HTTPS origins in production

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should enforce encryption for audit logs

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should enforce encryption for audit logs

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should validate audit log retention policies

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should validate audit log retention policies

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should not expose services on all interfaces by default

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should not expose services on all interfaces by default

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should validate upstream server URLs

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should validate upstream server URLs

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should not log environment variables

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should not log environment variables

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should sanitize configuration output

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should sanitize configuration output

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should prevent prototype pollution

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should prevent prototype pollution

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should validate numeric inputs to prevent injection

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should validate numeric inputs to prevent injection

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Security Headers and Settings â€º should enforce secure defaults

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Security Headers and Settings â€º should enforce secure defaults

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should support compliance configuration

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should support compliance configuration

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should validate data retention policies

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should validate data retention policies

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

FAIL test/dynamic-tool-discovery.test.ts
  â— DynamicToolDiscoveryService â€º åˆæœŸåŒ– â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      55 |     it('æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹', () => {
      56 |       expect(service).toBeDefined();
    > 57 |       expect(Logger).toHaveBeenCalled();
         |                      ^
      58 |     });
      59 |
      60 |     it('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–“éš”ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å®šæœŸå®Ÿè¡Œã‚’è¨­å®šã™ã‚‹', () => {

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:57:22)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º é«˜ãƒªã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 8
    Received number of calls: 4

      252 |
      253 |       // å„ãƒ„ãƒ¼ãƒ«ãŒé«˜ãƒªã‚¹ã‚¯ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 254 |       expect(mockLogger.info).toHaveBeenCalledTimes(highRiskTools.length * 2); // ç™ºè¦‹ãƒ­ã‚° + ç™»éŒ²ãƒ­ã‚°
          |                               ^
      255 |       
      256 |       highRiskTools.forEach(tool => {
      257 |         expect(mockLogger.info).toHaveBeenCalledWith(

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:254:31)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’é©ç”¨ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "custom_high_risk", "risk": "high"}
    Received
           1: "Registered dynamic tool", {"category": "general", "name": "custom_high_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "general", "name": "custom_low_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}

    Number of calls: 2

      321 |
      322 |       // execãƒ‘ã‚¿ãƒ¼ãƒ³ãŒhighRiskPatternsã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚
    > 323 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      324 |         'Registered dynamic tool',
      325 |         expect.objectContaining({
      326 |           name: 'custom_high_risk',

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:323:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "trusted-tool", "policyEnforced": false, "source": "official-mcp-server"}
    Received: "Registered dynamic tool", {"category": "general", "name": "trusted-tool", "policyEnforced": true, "risk": "medium", "source": "official-mcp-server"}

    Number of calls: 1

      369 |       );
      370 |
    > 371 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      372 |         'Registered dynamic tool',
      373 |         expect.objectContaining({
      374 |           name: 'trusted-tool',

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:371:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º smartãƒ¢ãƒ¼ãƒ‰ã§ä½ãƒªã‚¹ã‚¯ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "read_data", "policyEnforced": false, "risk": "low"}
    Received: "Registered dynamic tool", {"category": "data", "name": "read_data", "policyEnforced": true, "risk": "low", "source": "unknown-source"}

    Number of calls: 1

      445 |       await service.discoverToolsFromListResponse({ tools: [tool] }, 'unknown-source');
      446 |
    > 447 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      448 |         'Registered dynamic tool',
      449 |         expect.objectContaining({
      450 |           name: 'read_data',

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:447:31)

  â— DynamicToolDiscoveryService â€º ãƒ„ãƒ¼ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ â€º è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’åŒã˜ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"category": "file-management", "name": "read_file"}
    Received
           1: "Registered dynamic tool", {"category": "filesystem", "name": "read_file", "policyEnforced": true, "risk": "low", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "filesystem", "name": "write_file", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           3: "Registered dynamic tool", {"category": "filesystem", "name": "delete_file", "policyEnforced": true, "risk": "high", "source": "test-source"}

    Number of calls: 3

      490 |       // ã™ã¹ã¦ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…
      491 |       fileTools.forEach(tool => {
    > 492 |         expect(mockLogger.info).toHaveBeenCalledWith(
          |                                 ^
      493 |           'Registered dynamic tool',
      494 |           expect.objectContaining({
      495 |             name: tool.name,

      at test/dynamic-tool-discovery.test.ts:492:33
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:491:17)

  â— DynamicToolDiscoveryService â€º ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ â€º ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒ„ãƒ¼ãƒ«ã‚’å–å¾—ã§ãã‚‹

    expect(received).toBeGreaterThanOrEqual(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      601 |
      602 |       const fileTools = getToolsByCategory('file-management');
    > 603 |       expect(fileTools?.size).toBeGreaterThanOrEqual(2);
          |                               ^
      604 |       
      605 |       const execTools = getToolsByCategory('execution');
      606 |       expect(execTools?.has('exec_command')).toBe(true);

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:603:31)

FAIL src/test/mcp/tool-discovery.test.ts
  â— ToolDiscoveryService â€º Native Tools Registration â€º should register all native tools on initialization

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      47 |       
      48 |       // Check some native tools are registered
    > 49 |       expect(tools.some(t => t.name === 'Agent')).toBe(true);
         |                                                   ^
      50 |       expect(tools.some(t => t.name === 'Bash')).toBe(true);
      51 |       expect(tools.some(t => t.name === 'Edit')).toBe(true);
      52 |       

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:49:51)

  â— ToolDiscoveryService â€º Native Tools Registration â€º should apply policy control based on risk level

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      91 |       const read = service.getTool('Read');
      92 |       
    > 93 |       expect(agent?.source.policyControlled).toBe(true); // High risk
         |                                              ^
      94 |       expect(read?.source.policyControlled).toBe(true); // Low risk but not in exceptions
      95 |     });
      96 |

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:93:46)

  â— ToolDiscoveryService â€º Native Tools Registration â€º should respect exceptions list

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

       99 |       const ls = service.getTool('LS');
      100 |       
    > 101 |       expect(todoRead?.source.policyControlled).toBe(false);
          |                                                 ^
      102 |       expect(ls?.source.policyControlled).toBe(false);
      103 |     });
      104 |   });

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:101:49)

  â— ToolDiscoveryService â€º Policy Control â€º should force policy control for high-risk tools

    expect(received).toBe(expected) // Object.is equality

    Expected: "high"
    Received: "medium"

      254 |       // For test, we'll use the risk assessment method
      255 |       const bashRisk = serviceHighRisk.assessToolRisk('Bash');
    > 256 |       expect(bashRisk).toBe('high');
          |                        ^
      257 |     });
      258 |   });
      259 |

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:256:24)

  â— ToolDiscoveryService â€º Tool Risk Assessment â€º should assess risk based on tool metadata

    expect(received).toBe(expected) // Object.is equality

    Expected: "high"
    Received: "medium"

      261 |     it('should assess risk based on tool metadata', () => {
      262 |       // Native tools have risk metadata
    > 263 |       expect(service.assessToolRisk('Agent')).toBe('high');
          |                                               ^
      264 |       expect(service.assessToolRisk('Edit')).toBe('medium');
      265 |       expect(service.assessToolRisk('Read')).toBe('low');
      266 |     });

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:263:47)

  â— ToolDiscoveryService â€º Tool Queries â€º should get policy-controlled tools only

    expect(received).toBeDefined()

    Received: undefined

      307 |       // Should include high-risk tools
      308 |       const agent = controlledTools.find(t => t.name === 'Agent');
    > 309 |       expect(agent).toBeDefined();
          |                     ^
      310 |     });
      311 |
      312 |     it('should get specific tool by name', () => {

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:309:21)

FAIL src/test/dynamic-tool-discovery.test.ts
  â— DynamicToolDiscoveryService â€º åˆæœŸåŒ– â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      55 |     it('æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹', () => {
      56 |       expect(service).toBeDefined();
    > 57 |       expect(Logger).toHaveBeenCalled();
         |                      ^
      58 |     });
      59 |
      60 |     it('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–“éš”ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å®šæœŸå®Ÿè¡Œã‚’è¨­å®šã™ã‚‹', () => {

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:57:22)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º é«˜ãƒªã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 8
    Received number of calls: 4

      252 |
      253 |       // å„ãƒ„ãƒ¼ãƒ«ãŒé«˜ãƒªã‚¹ã‚¯ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 254 |       expect(mockLogger.info).toHaveBeenCalledTimes(highRiskTools.length * 2); // ç™ºè¦‹ãƒ­ã‚° + ç™»éŒ²ãƒ­ã‚°
          |                               ^
      255 |       
      256 |       highRiskTools.forEach(tool => {
      257 |         expect(mockLogger.info).toHaveBeenCalledWith(

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:254:31)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’é©ç”¨ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "custom_high_risk", "risk": "high"}
    Received
           1: "Registered dynamic tool", {"category": "general", "name": "custom_high_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "general", "name": "custom_low_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}

    Number of calls: 2

      321 |
      322 |       // execãƒ‘ã‚¿ãƒ¼ãƒ³ãŒhighRiskPatternsã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚
    > 323 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      324 |         'Registered dynamic tool',
      325 |         expect.objectContaining({
      326 |           name: 'custom_high_risk',

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:323:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "trusted-tool", "policyEnforced": false, "source": "official-mcp-server"}
    Received: "Registered dynamic tool", {"category": "general", "name": "trusted-tool", "policyEnforced": true, "risk": "medium", "source": "official-mcp-server"}

    Number of calls: 1

      369 |       );
      370 |
    > 371 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      372 |         'Registered dynamic tool',
      373 |         expect.objectContaining({
      374 |           name: 'trusted-tool',

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:371:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º smartãƒ¢ãƒ¼ãƒ‰ã§ä½ãƒªã‚¹ã‚¯ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "read_data", "policyEnforced": false, "risk": "low"}
    Received: "Registered dynamic tool", {"category": "data", "name": "read_data", "policyEnforced": true, "risk": "low", "source": "unknown-source"}

    Number of calls: 1

      445 |       await service.discoverToolsFromListResponse({ tools: [tool] }, 'unknown-source');
      446 |
    > 447 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      448 |         'Registered dynamic tool',
      449 |         expect.objectContaining({
      450 |           name: 'read_data',

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:447:31)

  â— DynamicToolDiscoveryService â€º ãƒ„ãƒ¼ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ â€º è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’åŒã˜ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"category": "file-management", "name": "read_file"}
    Received
           1: "Registered dynamic tool", {"category": "filesystem", "name": "read_file", "policyEnforced": true, "risk": "low", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "filesystem", "name": "write_file", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           3: "Registered dynamic tool", {"category": "filesystem", "name": "delete_file", "policyEnforced": true, "risk": "high", "source": "test-source"}

    Number of calls: 3

      490 |       // ã™ã¹ã¦ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…
      491 |       fileTools.forEach(tool => {
    > 492 |         expect(mockLogger.info).toHaveBeenCalledWith(
          |                                 ^
      493 |           'Registered dynamic tool',
      494 |           expect.objectContaining({
      495 |             name: tool.name,

      at src/test/dynamic-tool-discovery.test.ts:492:33
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:491:17)

  â— DynamicToolDiscoveryService â€º ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ â€º ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒ„ãƒ¼ãƒ«ã‚’å–å¾—ã§ãã‚‹

    expect(received).toBeGreaterThanOrEqual(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      601 |
      602 |       const fileTools = getToolsByCategory('file-management');
    > 603 |       expect(fileTools?.size).toBeGreaterThanOrEqual(2);
          |                               ^
      604 |       
      605 |       const execTools = getToolsByCategory('execution');
      606 |       expect(execTools?.has('exec_command')).toBe(true);

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:603:31)

FAIL test/context-enrichers.test.ts
  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º ãƒªã‚½ãƒ¼ã‚¹ã®æ©Ÿå¯†åº¦ã‚’åˆ†é¡ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 4
    + Received  + 4

      Object {
    -   "dataType": "customer-data",
    +   "dataType": "unclassified",
        "sensitivityLevel": "high",
    -   "tags": ArrayContaining [
    -     "pii",
    -     "regulated",
    +   "tags": Array [
    +     "unclassified",
    +     "review-required",
        ],
      }

      319 |         const enriched = await classifier.enrich(context);
      320 |
    > 321 |         expect(enriched['resource-classifier']).toMatchObject({
          |                                                 ^
      322 |           dataType: testCase.expectedType,
      323 |           sensitivityLevel: testCase.expectedSensitivity,
      324 |           tags: expect.arrayContaining(testCase.expectedTags)

      at Object.<anonymous> (test/context-enrichers.test.ts:321:49)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º å€‹äººæƒ…å ±ã‚’å«ã‚€ãƒªã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥ã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      346 |         const enriched = await classifier.enrich(context);
      347 |
    > 348 |         expect(enriched['resource-classifier'].isPii).toBe(true);
          |                                                       ^
      349 |         expect(enriched['resource-classifier'].tags).toContain('pii');
      350 |       }
      351 |     });

      at Object.<anonymous> (test/context-enrichers.test.ts:348:55)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º SecurityInfoEnricher â€º ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      521 |       
      522 |       // ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 523 |       expect(enriched['security-info'].unusualActivity.length).toBeGreaterThan(0);
          |                                                                ^
      524 |     });
      525 |   });
      526 |

      at Object.<anonymous> (test/context-enrichers.test.ts:523:64)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ContextCollectorçµ±åˆãƒ†ã‚¹ãƒˆ â€º å…¨ã¦ã®enricherãŒå”èª¿ã—ã¦å‹•ä½œã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  -  12
    + Received  + 123

    @@ -1,28 +1,139 @@
      Object {
        "action": "read",
        "agent": "customer-support-agent",
    -   "environment": ObjectContaining {
    -     "enrichments": ObjectContaining {
    -       "agent-info": ObjectContaining {
    -         "agentType": Any<String>,
    -         "clearanceLevel": Any<Number>,
    -         "department": Any<String>,
    +   "environment": Object {
    +     "clientIP": "192.168.1.100",
    +     "enrichmentTime": 1,
    +     "enrichments": Object {
    +       "agent-info": Object {
    +         "activityStatus": "active-today",
    +         "ageDays": 760,
    +         "agentId": "customer-support-agent",
    +         "agentType": "support",
    +         "clearanceLevel": 2,
    +         "clearanceName": "standard",
    +         "createdAt": "2024-01-15T00:00:00.000Z",
    +         "department": "customer-service",
    +         "hasAdminPrivileges": false,
    +         "hasHighClearance": false,
    +         "inactiveDays": 0,
    +         "isExternal": false,
    +         "isInactive": false,
    +         "isNewAgent": false,
    +         "lastActivity": "2026-02-13T00:27:01.243Z",
    +         "location": "tokyo-office",
    +         "permissions": Array [
    +           "read-customer-data",
    +           "create-tickets",
    +         ],
    +         "requiresSupervision": false,
    +         "riskScore": 0.2,
    +         "supervisor": "support-manager",
    +         "tags": Array [
    +           "production",
    +           "verified",
    +         ],
    +         "trustScore": 1,
    +       },
    +       "resource-classifier": Object {
    +         "accessFrequency": Object {
    +           "daily": 92,
    +           "monthly": 992,
    +           "trend": "stable",
    +           "weekly": 223,
    +         },
    +         "dataAge": "current",
    +         "dataController": "data-governance-team",
    +         "dataType": "unclassified",
    +         "department": "unknown",
    +         "isFinancial": false,
    +         "isPhi": false,
    +         "isPii": false,
    +         "isPublic": false,
    +         "isRegulated": false,
    +         "lineage": Object {
    +           "dependencies": Array [],
    +           "lastModified": "2026-02-13T00:27:01.276Z",
    +           "source": "original-system",
    +           "transformations": Array [
    +             "anonymized",
    +             "aggregated",
    +           ],
    +           "version": "1.0",
              },
    -       "resource-classifier": ObjectContaining {
    -         "dataType": "customer-data",
    -         "isPii": true,
    +         "owner": "unknown",
    +         "requiresAudit": false,
    +         "requiresEncryption": true,
    +         "resourceHost": "profile",
    +         "resourcePath": "/12345",
    +         "resourceScheme": "customer",
    +         "resourceUri": "customer://profile/12345",
    +         "retentionDays": 90,
              "sensitivityLevel": "high",
    +         "sensitivityScore": 0.8,
    +         "tags": Array [
    +           "unclassified",
    +           "review-required",
    +         ],
            },
    -       "security-info": ObjectContaining {
    +       "security-info": Object {
    +         "authMethod": "password",
    +         "authStrength": "medium",
              "clientIP": "192.168.1.100",
    -         "threatLevel": Any<String>,
    +         "deviceTrust": "untrusted",
    +         "geoLocation": Object {
    +           "city": "Unknown",
    +           "country": "US",
    +           "isHighRisk": false,
    +           "region": "Unknown",
    +           "timezone": "UTC",
    +         },
    +         "ipType": "external",
    +         "isInternalIP": false,
    +         "isOfficeIP": false,
    +         "isThreatIP": false,
    +         "isVpnConnection": false,
    +         "lastSuccessfulAccess": null,
    +         "mfaEnabled": false,
    +         "networkTrust": "untrusted",
    +         "recentFailedAttempts": 0,
    +         "requiresAdditionalAuth": true,
    +         "securityScore": 0.4,
    +         "sessionAge": 2768,
    +         "threatLevel": "low",
    +         "threatReasons": Array [],
    +         "unusualActivity": Array [],
    +         "vpnType": null,
    +       },
    +       "time-based": Object {
    +         "businessHoursConfig": Object {
    +           "end": 18,
    +           "start": 9,
    +           "timezone": "Asia/Tokyo",
              },
    -       "time-based": ObjectContaining {
    +         "currentTime": "2024-01-15T01:00:00.000Z",
    +         "dayOfMonth": 15,
    +         "dayOfWeek": 1,
              "dayOfWeekName": "Monday",
    +         "fiscalQuarter": 4,
    +         "fiscalYear": 2023,
    +         "hour": 10,
    +         "isBusinessDay": true,
              "isBusinessHours": true,
    +         "isHoliday": false,
    +         "isMonthEnd": false,
              "isWeekend": false,
    +         "minute": 0,
    +         "month": 1,
    +         "monthName": "January",
    +         "quarter": 1,
    +         "timeOfDay": "morning",
    +         "timeSinceBusinessStart": 60,
    +         "timeUntilBusinessEnd": 480,
    +         "timezone": "Asia/Tokyo",
    +         "year": 2024,
            },
          },
          "requestId": "req-123",
          "sessionId": "session-456",
        },

      557 |
      558 |       // å…¨ã¦ã®enricherã‹ã‚‰ã®æƒ…å ±ãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 559 |       expect(enrichedContext).toMatchObject({
          |                               ^
      560 |         // åŸºæœ¬æƒ…å ±
      561 |         agent: 'customer-support-agent',
      562 |         action: 'read',

      at Object.<anonymous> (test/context-enrichers.test.ts:559:31)

FAIL test/mcp/tool-discovery.test.ts
  â— ToolDiscoveryService â€º Native Tools Registration â€º should register all native tools on initialization

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      47 |       
      48 |       // Check some native tools are registered
    > 49 |       expect(tools.some(t => t.name === 'Agent')).toBe(true);
         |                                                   ^
      50 |       expect(tools.some(t => t.name === 'Bash')).toBe(true);
      51 |       expect(tools.some(t => t.name === 'Edit')).toBe(true);
      52 |       expect(tools.some(t => t.name === 'Read')).toBe(true);

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:49:51)

  â— ToolDiscoveryService â€º Native Tools Registration â€º should apply policy control to native tools

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      62 |       // Default enabled tools should have policy control
      63 |       const bashTool = tools.find(t => t.name === 'Bash');
    > 64 |       expect(bashTool?.policyControlled).toBe(true);
         |                                          ^
      65 |       
      66 |       // Exception tools should not have policy control
      67 |       const todoRead = tools.find(t => t.name === 'TodoRead');

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:64:42)

  â— ToolDiscoveryService â€º Tool Discovery â€º should discover tools from configured sources

    TypeError: service.discoverTools is not a function

      112 |       
      113 |       service = new ToolDiscoveryService(config, mockLogger);
    > 114 |       await service.discoverTools();
          |                     ^
      115 |       
      116 |       const tools = service.getAllTools();
      117 |       

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:114:21)

  â— ToolDiscoveryService â€º Tool Discovery â€º should handle discovery errors gracefully

    TypeError: service.discoverTools is not a function

      138 |       
      139 |       service = new ToolDiscoveryService(config, mockLogger);
    > 140 |       await service.discoverTools();
          |                     ^
      141 |       
      142 |       // Should log error but not throw
      143 |       expect(mockLogger.error).toHaveBeenCalledWith(

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:140:21)

  â— ToolDiscoveryService â€º Tool Discovery â€º should apply policy control based on exceptions

    TypeError: service.discoverTools is not a function

      177 |       
      178 |       service = new ToolDiscoveryService(config, mockLogger);
    > 179 |       await service.discoverTools();
          |                     ^
      180 |       
      181 |       const tools = service.getAllTools();
      182 |       

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:179:21)

  â— ToolDiscoveryService â€º Tool Filtering â€º should filter tools by policy control status

    TypeError: service.getNonPolicyControlledTools is not a function

      192 |     it('should filter tools by policy control status', () => {
      193 |       const policyControlledTools = service.getPolicyControlledTools();
    > 194 |       const nonPolicyControlledTools = service.getNonPolicyControlledTools();
          |                                                ^
      195 |       
      196 |       // All policy controlled tools should have policyControlled = true
      197 |       policyControlledTools.forEach(tool => {

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:194:48)

  â— ToolDiscoveryService â€º Tool Filtering â€º should get tool by name

    TypeError: service.getToolByName is not a function

      211 |
      212 |     it('should get tool by name', () => {
    > 213 |       const bashTool = service.getToolByName('Bash');
          |                                ^
      214 |       expect(bashTool).toBeDefined();
      215 |       expect(bashTool?.name).toBe('Bash');
      216 |       

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:213:32)

  â— ToolDiscoveryService â€º Tool Prefixing â€º should check if tool name has prefix

    TypeError: service.hasToolPrefix is not a function

      222 |   describe('Tool Prefixing', () => {
      223 |     it('should check if tool name has prefix', () => {
    > 224 |       expect(service.hasToolPrefix('filesystem__read_file')).toBe(true);
          |                      ^
      225 |       expect(service.hasToolPrefix('execution-server__run_command')).toBe(true);
      226 |       expect(service.hasToolPrefix('simple_tool')).toBe(false);
      227 |     });

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:224:22)

  â— ToolDiscoveryService â€º Tool Prefixing â€º should extract prefix from tool name

    TypeError: service.getToolPrefix is not a function

      228 |
      229 |     it('should extract prefix from tool name', () => {
    > 230 |       expect(service.getToolPrefix('filesystem__read_file')).toBe('filesystem');
          |                      ^
      231 |       expect(service.getToolPrefix('execution-server__run_command'))
      232 |         .toBe('execution-server');
      233 |       expect(service.getToolPrefix('simple_tool')).toBeNull();

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:230:22)

  â— ToolDiscoveryService â€º Tool Prefixing â€º should strip prefix from tool name

    TypeError: service.stripToolPrefix is not a function

      235 |
      236 |     it('should strip prefix from tool name', () => {
    > 237 |       expect(service.stripToolPrefix('filesystem__read_file')).toBe('read_file');
          |                      ^
      238 |       expect(service.stripToolPrefix('execution-server__run_command'))
      239 |         .toBe('run_command');
      240 |       expect(service.stripToolPrefix('simple_tool')).toBe('simple_tool');

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:237:22)

  â— ToolDiscoveryService â€º Configuration Updates â€º should update policy control configuration

    TypeError: service.getToolByName is not a function

      245 |     it('should update policy control configuration', () => {
      246 |       // Initial state
    > 247 |       let bashTool = service.getToolByName('Bash');
          |                              ^
      248 |       expect(bashTool?.policyControlled).toBe(true);
      249 |       
      250 |       // Update config to exclude Bash

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:247:30)

  â— ToolDiscoveryService â€º Configuration Updates â€º should handle defaultEnabled = false correctly

    TypeError: service.updatePolicyControl is not a function

      260 |
      261 |     it('should handle defaultEnabled = false correctly', () => {
    > 262 |       service.updatePolicyControl({
          |               ^
      263 |         defaultEnabled: false,
      264 |         exceptions: ['Bash'] // This should be enabled as exception
      265 |       });

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:262:15)

  â— ToolDiscoveryService â€º Integration Tests â€º should handle complete workflow

    TypeError: service.discoverTools is not a function

      302 |       
      303 |       service = new ToolDiscoveryService(config, mockLogger);
    > 304 |       await service.discoverTools();
          |                     ^
      305 |       
      306 |       const allTools = service.getAllTools();
      307 |       const nativeTools = allTools.filter(t => t.source === ToolSource.NATIVE);

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:304:21)

FAIL src/test/utils-config.test.ts
  â— Config â€º åŸºæœ¬è¨­å®š â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§åˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "development"
    Received: "test"

      33 |       const config = new Config();
      34 |
    > 35 |       expect(config.nodeEnv).toBe('development');
         |                              ^
      36 |       expect(config.port).toBe(3000);
      37 |       expect(config.logLevel).toBe('info');
      38 |     });

      at Object.<anonymous> (src/test/utils-config.test.ts:35:30)

  â— Config â€º åŸºæœ¬è¨­å®š â€º ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã‚€

    [Config] Secret key must be changed in production environment

      175 |     // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæ¤œè¨¼
      176 |     if (this.config.nodeEnv === 'production' && this.config.secretKey === DEFAULT_SECRET_KEY) {
    > 177 |       throw new Error('[Config] Secret key must be changed in production environment');
          |             ^
      178 |     }
      179 |
      180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {

      at Config.validateConfig (src/utils/config.ts:177:13)
      at new Config (src/utils/config.ts:87:10)
      at Object.<anonymous> (src/test/utils-config.test.ts:45:22)

  â— Config â€º LLMè¨­å®š â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®LLMè¨­å®šã‚’ä½¿ç”¨ã™ã‚‹

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
        "apiKey": "",
        "baseURL": undefined,
        "maxTokens": 4096,
    -   "model": "gpt-4",
    -   "provider": "openai",
    +   "model": "claude-opus-4-20250514",
    +   "provider": "anthropic",
        "temperature": 0.3,
      }

      67 |       const config = new Config();
      68 |
    > 69 |       expect(config.llm).toEqual({
         |                          ^
      70 |         provider: 'openai',
      71 |         apiKey: '',
      72 |         model: 'gpt-4',

      at Object.<anonymous> (src/test/utils-config.test.ts:69:26)

  â— Config â€º ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š â€º æœ¬ç•ªç’°å¢ƒã§ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨æ­£å¸¸ã«å‹•ä½œã™ã‚‹

    expect(received).not.toThrow()

    Error name:    "Error"
    Error message: "[Config] Secret key must be at least 32 characters long in production"

          179 |
          180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {
        > 181 |       throw new Error('[Config] Secret key must be at least 32 characters long in production');
              |             ^
          182 |     }
          183 |
          184 |     // ãƒãƒ¼ãƒˆç•ªå·æ¤œè¨¼

      at Config.validateConfig (src/utils/config.ts:181:13)
      at new Config (src/utils/config.ts:87:10)
      at src/test/utils-config.test.ts:277:20
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/utils-config.test.ts:277:38)
      at Object.<anonymous> (src/test/utils-config.test.ts:277:38)

  â— Config â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã®ãƒ‘ãƒ¼ã‚¹ â€º ç©ºç™½ã‚’å«ã‚€è¨­å®šã‚‚å‡¦ç†ã™ã‚‹

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "server1": "http://server1.com",
    -   "server2": "http://server2.com",
    +   "server1 ": " http://server1.com",
    +   "server2 ": " http://server2.com",
      }

      306 |       const config = new Config();
      307 |
    > 308 |       expect(config.mcpProxy.upstreamServers).toEqual({
          |                                               ^
      309 |         server1: 'http://server1.com',
      310 |         server2: 'http://server2.com'
      311 |       });

      at Object.<anonymous> (src/test/utils-config.test.ts:308:47)

  â— Config â€º ç’°å¢ƒãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ â€º isProductionãŒæ­£ã—ãå‹•ä½œã™ã‚‹

    [Config] Secret key must be at least 32 characters long in production

      179 |
      180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {
    > 181 |       throw new Error('[Config] Secret key must be at least 32 characters long in production');
          |             ^
      182 |     }
      183 |
      184 |     // ãƒãƒ¼ãƒˆç•ªå·æ¤œè¨¼

      at Config.validateConfig (src/utils/config.ts:181:13)
      at new Config (src/utils/config.ts:87:10)
      at Object.<anonymous> (src/test/utils-config.test.ts:346:22)

  â— Config â€º è¨­å®šæ¤œè¨¼ â€º APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«è­¦å‘Šã‚’å‡ºåŠ›ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[Config] Warning: OpenAI API key not set. Set OPENAI_API_KEY environment variable."

    Number of calls: 0

      366 |       new Config();
      367 |
    > 368 |       expect(consoleErrorSpy).toHaveBeenCalledWith(
          |                               ^
      369 |         '[Config] Warning: OpenAI API key not set. Set OPENAI_API_KEY environment variable.'
      370 |       );
      371 |     });

      at Object.<anonymous> (src/test/utils-config.test.ts:368:31)

  â— Config â€º è¨­å®šæ¤œè¨¼ â€º è¨­å®šãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã“ã¨ã‚’ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[Config] Configuration loaded successfully"

    Number of calls: 0

      411 |       new Config();
      412 |
    > 413 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] Configuration loaded successfully');
          |                               ^
      414 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] Environment: development');
      415 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] LLM Provider: openai');
      416 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] LLM Model: gpt-4');

      at Object.<anonymous> (src/test/utils-config.test.ts:413:31)

  â— Config â€º toJSON â€º æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚¹ã‚¯ã—ã¦å‡ºåŠ›ã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "[REDACTED]"
    Received: "[NOT_SET]"

      427 |       const json = config.toJSON();
      428 |
    > 429 |       expect(json.llm?.apiKey).toBe('[REDACTED]');
          |                                ^
      430 |       expect(json.secretKey).toBe('[REDACTED]');
      431 |       expect(json.jwtSecret).toBe('[REDACTED]');
      432 |     });

      at Object.<anonymous> (src/test/utils-config.test.ts:429:32)

  â— Config â€º dotenvè¨­å®š â€º dotenv.configãŒoverride: falseã§å‘¼ã°ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"override": false}

    Number of calls: 0

      462 |       new Config();
      463 |
    > 464 |       expect(dotenv.config).toHaveBeenCalledWith({ override: false });
          |                             ^
      465 |     });
      466 |   });
      467 | });

      at Object.<anonymous> (src/test/utils-config.test.ts:464:29)

FAIL src/test/context-enrichers.test.ts
  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º ãƒªã‚½ãƒ¼ã‚¹ã®æ©Ÿå¯†åº¦ã‚’åˆ†é¡ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 4
    + Received  + 4

      Object {
    -   "dataType": "customer-data",
    +   "dataType": "unclassified",
        "sensitivityLevel": "high",
    -   "tags": ArrayContaining [
    -     "pii",
    -     "regulated",
    +   "tags": Array [
    +     "unclassified",
    +     "review-required",
        ],
      }

      319 |         const enriched = await classifier.enrich(context);
      320 |
    > 321 |         expect(enriched['resource-classifier']).toMatchObject({
          |                                                 ^
      322 |           dataType: testCase.expectedType,
      323 |           sensitivityLevel: testCase.expectedSensitivity,
      324 |           tags: expect.arrayContaining(testCase.expectedTags)

      at Object.<anonymous> (src/test/context-enrichers.test.ts:321:49)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º å€‹äººæƒ…å ±ã‚’å«ã‚€ãƒªã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥ã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      346 |         const enriched = await classifier.enrich(context);
      347 |
    > 348 |         expect(enriched['resource-classifier'].isPii).toBe(true);
          |                                                       ^
      349 |         expect(enriched['resource-classifier'].tags).toContain('pii');
      350 |       }
      351 |     });

      at Object.<anonymous> (src/test/context-enrichers.test.ts:348:55)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º SecurityInfoEnricher â€º ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      521 |       
      522 |       // ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 523 |       expect(enriched['security-info'].unusualActivity.length).toBeGreaterThan(0);
          |                                                                ^
      524 |     });
      525 |   });
      526 |

      at Object.<anonymous> (src/test/context-enrichers.test.ts:523:64)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ContextCollectorçµ±åˆãƒ†ã‚¹ãƒˆ â€º å…¨ã¦ã®enricherãŒå”èª¿ã—ã¦å‹•ä½œã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  -  12
    + Received  + 126

      Object {
        "action": "read",
        "agent": "customer-support-agent",
    -   "environment": ObjectContaining {
    -     "agent-info": ObjectContaining {
    -       "agentType": Any<String>,
    -       "clearanceLevel": Any<Number>,
    -       "department": Any<String>,
    +   "environment": Object {
    +     "clientIP": "192.168.1.100",
    +     "enrichmentTime": 1,
    +     "enrichments": Object {
    +       "agent-info": Object {
    +         "activityStatus": "active-today",
    +         "ageDays": 760,
    +         "agentId": "customer-support-agent",
    +         "agentType": "support",
    +         "clearanceLevel": 2,
    +         "clearanceName": "standard",
    +         "createdAt": "2024-01-15T00:00:00.000Z",
    +         "department": "customer-service",
    +         "hasAdminPrivileges": false,
    +         "hasHighClearance": false,
    +         "inactiveDays": 0,
    +         "isExternal": false,
    +         "isInactive": false,
    +         "isNewAgent": false,
    +         "lastActivity": "2026-02-13T00:27:01.704Z",
    +         "location": "tokyo-office",
    +         "permissions": Array [
    +           "read-customer-data",
    +           "create-tickets",
    +         ],
    +         "requiresSupervision": false,
    +         "riskScore": 0.2,
    +         "supervisor": "support-manager",
    +         "tags": Array [
    +           "production",
    +           "verified",
    +         ],
    +         "trustScore": 1,
    +       },
    +       "resource-classifier": Object {
    +         "accessFrequency": Object {
    +           "daily": 66,
    +           "monthly": 1298,
    +           "trend": "stable",
    +           "weekly": 379,
              },
    -     "requestId": "req-123",
    -     "resource-classifier": ObjectContaining {
    -       "dataType": Any<String>,
    +         "dataAge": "current",
    +         "dataController": "data-governance-team",
    +         "dataType": "unclassified",
    +         "department": "unknown",
    +         "isFinancial": false,
    +         "isPhi": false,
    +         "isPii": false,
    +         "isPublic": false,
    +         "isRegulated": false,
    +         "lineage": Object {
    +           "dependencies": Array [],
    +           "lastModified": "2026-02-13T00:27:01.728Z",
    +           "source": "original-system",
    +           "transformations": Array [
    +             "anonymized",
    +             "aggregated",
    +           ],
    +           "version": "1.0",
    +         },
    +         "owner": "unknown",
    +         "requiresAudit": false,
    +         "requiresEncryption": true,
    +         "resourceHost": "profile",
    +         "resourcePath": "/12345",
    +         "resourceScheme": "customer",
    +         "resourceUri": "customer://profile/12345",
    +         "retentionDays": 90,
              "sensitivityLevel": "high",
    +         "sensitivityScore": 0.8,
    +         "tags": Array [
    +           "unclassified",
    +           "review-required",
    +         ],
            },
    -     "security-info": ObjectContaining {
    +       "security-info": Object {
    +         "authMethod": "password",
    +         "authStrength": "medium",
              "clientIP": "192.168.1.100",
    -       "threatLevel": Any<String>,
    +         "deviceTrust": "untrusted",
    +         "geoLocation": Object {
    +           "city": "Unknown",
    +           "country": "US",
    +           "isHighRisk": false,
    +           "region": "Unknown",
    +           "timezone": "UTC",
              },
    -     "sessionId": "session-456",
    -     "time-based": ObjectContaining {
    +         "ipType": "external",
    +         "isInternalIP": false,
    +         "isOfficeIP": false,
    +         "isThreatIP": false,
    +         "isVpnConnection": false,
    +         "lastSuccessfulAccess": null,
    +         "mfaEnabled": false,
    +         "networkTrust": "untrusted",
    +         "recentFailedAttempts": 0,
    +         "requiresAdditionalAuth": true,
    +         "securityScore": 0.4,
    +         "sessionAge": 2164,
    +         "threatLevel": "low",
    +         "threatReasons": Array [],
    +         "unusualActivity": Array [],
    +         "vpnType": null,
    +       },
    +       "time-based": Object {
    +         "businessHoursConfig": Object {
    +           "end": 18,
    +           "start": 9,
    +           "timezone": "Asia/Tokyo",
    +         },
    +         "currentTime": "2024-01-15T01:00:00.000Z",
    +         "dayOfMonth": 15,
    +         "dayOfWeek": 1,
              "dayOfWeekName": "Monday",
    +         "fiscalQuarter": 4,
    +         "fiscalYear": 2023,
    +         "hour": 10,
    +         "isBusinessDay": true,
              "isBusinessHours": true,
    +         "isHoliday": false,
    +         "isMonthEnd": false,
              "isWeekend": false,
    +         "minute": 0,
    +         "month": 1,
    +         "monthName": "January",
    +         "quarter": 1,
    +         "timeOfDay": "morning",
    +         "timeSinceBusinessStart": 60,
    +         "timeUntilBusinessEnd": 480,
    +         "timezone": "Asia/Tokyo",
    +         "year": 2024,
            },
    +     },
    +     "requestId": "req-123",
    +     "sessionId": "session-456",
        },
        "purpose": "customer-inquiry",
        "resource": "customer://profile/12345",
      }

      557 |
      558 |       // å…¨ã¦ã®enricherã‹ã‚‰ã®æƒ…å ±ãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 559 |       expect(enrichedContext).toMatchObject({
          |                               ^
      560 |         // åŸºæœ¬æƒ…å ±
      561 |         agent: 'customer-support-agent',
      562 |         action: 'read',

      at Object.<anonymous> (src/test/context-enrichers.test.ts:559:31)

FAIL src/test/schemas/config.schema.test.ts
  â— Configuration Schema Validation Tests â€º Schema Structure Validation â€º should accept valid complete configuration

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      }
    ]"

          58 |       };
          59 |
        > 60 |       expect(() => AEGISConfigSchema.parse(validConfig)).not.toThrow();
             |                                      ^
          61 |     });
          62 |
          63 |     it('should accept minimal valid configuration', () => {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:60:38
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:60:62)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:60:62)

  â— Configuration Schema Validation Tests â€º Schema Structure Validation â€º should accept minimal valid configuration

    ZodError: [
      {
        "code": "invalid_type",
        "expected": "string",
        "received": "undefined",
        "path": [
          "llm",
          "model"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "cache"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "log"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "security"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "monitoring"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "policy"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "mcp"
        ],
        "message": "Required"
      }
    ]

      69 |       };
      70 |
    > 71 |       const result = AEGISConfigSchema.parse(minimalConfig);
         |                                        ^
      72 |       expect(result.llm.provider).toBe('openai');
      73 |       expect(result.llm.apiKey).toBe('test-key');
      74 |       // Check defaults are applied

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:71:40)

  â— Configuration Schema Validation Tests â€º LLM Configuration Schema â€º should validate temperature range

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          113 |           expect(() => AEGISConfigSchema.parse(config)).toThrow();
          114 |         } else {
        > 115 |           expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                          ^
          116 |         }
          117 |       });
          118 |     });

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:115:42
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:115:61
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:103:17)
      at src/test/schemas/config.schema.test.ts:115:61
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:103:17)

  â— Configuration Schema Validation Tests â€º MCP Configuration Schema â€º should validate transport types

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      }
    ]"

          151 |         };
          152 |         
        > 153 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          154 |       });
          155 |
          156 |       const invalidTransport = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:153:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:153:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:147:23)
      at src/test/schemas/config.schema.test.ts:153:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:147:23)

  â— Configuration Schema Validation Tests â€º MCP Configuration Schema â€º should validate port numbers

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      }
    ]"

          181 |           expect(() => AEGISConfigSchema.parse(config)).toThrow();
          182 |         } else {
        > 183 |           expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                          ^
          184 |         }
          185 |       });
          186 |     });

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:183:42
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:183:61
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:174:17)
      at src/test/schemas/config.schema.test.ts:183:61
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:174:17)

  â— Configuration Schema Validation Tests â€º MCP Configuration Schema â€º should validate CORS origins are valid URLs

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      }
    ]"

          198 |       };
          199 |
        > 200 |       expect(() => AEGISConfigSchema.parse(validOrigins)).not.toThrow();
              |                                      ^
          201 |
          202 |       const invalidOrigins = {
          203 |         llm: { provider: 'openai', apiKey: 'key' },

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:200:38
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:200:63)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:200:63)

  â— Configuration Schema Validation Tests â€º Security Configuration Schema â€º should validate secret key length

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          229 |       };
          230 |
        > 231 |       expect(() => AEGISConfigSchema.parse(validKey)).not.toThrow();
              |                                      ^
          232 |     });
          233 |
          234 |     it('should validate encryption algorithms', () => {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:231:38
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:231:59)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:231:59)

  â— Configuration Schema Validation Tests â€º Security Configuration Schema â€º should validate encryption algorithms

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          244 |         };
          245 |         
        > 246 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          247 |       });
          248 |
          249 |       const invalidAlgorithm = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:246:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:246:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:237:23)
      at src/test/schemas/config.schema.test.ts:246:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:237:23)

  â— Configuration Schema Validation Tests â€º Cache Configuration Schema â€º should validate cache strategies

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          281 |         };
          282 |         
        > 283 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          284 |       });
          285 |
          286 |       const invalidStrategy = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:283:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:283:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:277:23)
      at src/test/schemas/config.schema.test.ts:283:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:277:23)

  â— Configuration Schema Validation Tests â€º Monitoring Configuration Schema â€º should validate log levels

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          321 |         };
          322 |         
        > 323 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          324 |       });
          325 |
          326 |       const invalidLevel = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:323:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:323:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:317:19)
      at src/test/schemas/config.schema.test.ts:323:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:317:19)

  â— Configuration Schema Validation Tests â€º Policy Configuration Schema â€º should validate strictness levels

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          369 |         };
          370 |         
        > 371 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          372 |       });
          373 |
          374 |       const invalidLevel = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:371:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:371:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:365:19)
      at src/test/schemas/config.schema.test.ts:371:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:365:19)

  â— Configuration Schema Validation Tests â€º Schema Error Messages â€º should provide helpful error messages for validation failures

    expect(received).toHaveLength(expected)

    Expected length: 5
    Received length: 11
    Received array:  [{"code": "invalid_enum_value", "message": "Invalid enum value. Expected 'openai' | 'anthropic', received 'invalid'", "options": ["openai", "anthropic"], "path": ["llm", "provider"], "received": "invalid"}, {"code": "invalid_type", "expected": "string", "message": "Required", "path": ["llm", "model"], "received": "undefined"}, {"code": "too_big", "exact": false, "inclusive": true, "maximum": 2, "message": "Number must be less than or equal to 2", "path": ["llm", "temperature"], "type": "number"}, {"code": "too_small", "exact": false, "inclusive": true, "message": "Number must be greater than or equal to 1", "minimum": 1, "path": ["llm", "maxTokens"], "type": "number"}, {"code": "too_small", "exact": false, "inclusive": true, "message": "Number must be greater than or equal to 0", "minimum": 0, "path": ["cache", "ttl"], "type": "number"}, {"code": "invalid_enum_value", "message": "Invalid enum value. Expected 'lru' | 'lfu' | 'fifo', received 'wrong'", "options": ["lru", "lfu", "fifo"], "path": ["cache", "strategy"], "received": "wrong"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["log"], "received": "undefined"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["security"], "received": "undefined"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["monitoring"], "received": "undefined"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["policy"], "received": "undefined"}, â€¦]

      431 |       } catch (error) {
      432 |         if (error instanceof z.ZodError) {
    > 433 |           expect(error.errors).toHaveLength(5); // Multiple validation errors
          |                                ^
      434 |           expect(error.errors.some(e => e.path.includes('provider'))).toBeTruthy();
      435 |           expect(error.errors.some(e => e.path.includes('temperature'))).toBeTruthy();
      436 |           expect(error.errors.some(e => e.path.includes('maxTokens'))).toBeTruthy();

      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:433:32)

  â— Configuration Schema Validation Tests â€º Schema Compatibility â€º should be compatible with AEGISConfig type

    ZodError: [
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "cache"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "log"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "security"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "monitoring"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "policy"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "mcp"
        ],
        "message": "Required"
      }
    ]

      454 |       };
      455 |
    > 456 |       const parsed = AEGISConfigSchema.parse(config);
          |                                        ^
      457 |       
      458 |       // Type assertion to ensure compatibility
      459 |       const _typeCheck: z.infer<typeof AEGISConfigSchema> = parsed;

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:456:40)

PASS test/policy/policy-detector.test.ts
PASS src/test/enforcement/enforcement-system.test.ts
PASS src/test/core/constraints/manager.test.ts
PASS src/test/ai-judgment-engine.test.ts
PASS src/test/simple-integration.test.ts
PASS src/test/enforcement/constraints/rate-limiter.test.ts
PASS src/test/constraints-obligations.test.ts
PASS src/test/enforcement/constraints/data-anonymizer.test.ts
PASS src/test/utils-error-handler.test.ts
PASS test/context/collector.test.ts
PASS src/test/enforcement/obligations/audit-logger.test.ts
PASS test/notification-hub.test.ts
PASS src/test/context/collector.test.ts
PASS test/ai/judgment-engine.test.ts
PASS src/test/enforcement/constraints/geo-restrictor.test.ts
PASS test/context/enrichers/security-info.test.ts
PASS src/context/enrichers/security-info.test.ts
PASS src/ai/judgment-engine.test.ts
FAIL src/test/e2e/policy-lifecycle.test.ts
  â— Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     â€¢ If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     â€¢ If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     â€¢ To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     â€¢ If you need a custom transformation specify a "transform" option in your config.
     â€¢ If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/shingo/Develop/aegis-policy-engine/node_modules/node-fetch/src/index.js:9
    import http from 'node:http';
    ^^^^^^

    SyntaxError: Cannot use import statement outside a module

       5 | import { describe, it, expect, beforeAll, afterAll } from '@jest/globals';
       6 | // @ts-ignore
    >  7 | const fetch = require('node-fetch').default || require('node-fetch');
         |               ^
       8 | import { PolicyAdministrator } from '../../policies/administrator.js';
       9 | import { AIJudgmentEngine } from '../../ai/judgment-engine.js';
      10 |

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1505:14)
      at Object.<anonymous> (src/test/e2e/policy-lifecycle.test.ts:7:15)

PASS src/test/utils/config.test.ts
FAIL src/test/mcp/policy-enforcer.test.ts (11.132 s)
  â— PolicyEnforcer â€º enforcePolicy â€º should handle policy decision timeout

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      223 |     });
      224 |
    > 225 |     it('should handle policy decision timeout', async () => {
          |     ^
      226 |       // Mock a delayed decision that will timeout
      227 |       (mockPolicyEngine.decide as jest.Mock).mockImplementation(
      228 |         () => new Promise(resolve => setTimeout(resolve, TIMEOUTS.POLICY_DECISION + 1000))

      at src/test/mcp/policy-enforcer.test.ts:225:5
      at src/test/mcp/policy-enforcer.test.ts:102:3
      at Object.<anonymous> (src/test/mcp/policy-enforcer.test.ts:86:1)

  â— PolicyEnforcer â€º enforcePolicy â€º should use default policy when no policy loader provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"action": "read", "agent": "test-agent", "environment": {"agent": "test-agent", "request": {"params": {"purpose": "test-purpose"}}, "transport": "http"}, "purpose": "test-purpose", "resource": "file://test.txt", "time": 2026-02-13T00:26:54.630Z},
    - null,
    + undefined,

    Number of calls: 1

      304 |       );
      305 |
    > 306 |       expect(mockPolicyEngine.decide).toHaveBeenCalledWith(
          |                                       ^
      307 |         enrichedContext,
      308 |         null // No policy
      309 |       );

      at Object.<anonymous> (src/test/mcp/policy-enforcer.test.ts:306:39)

FAIL test/ai/judgment-engine-comprehensive.test.ts (31.591 s)
  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should handle prompt injection attempts safely

    TypeError: Cannot read properties of undefined (reading '0')

      69 |       // Verify the prompt is constructed safely
      70 |       const promptCall = mockLLM.complete.mock.calls[0][0];
    > 71 |       expect(promptCall.messages[0].content).toContain('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒªã‚·ãƒ¼');
         |                                 ^
      72 |     });
      73 |
      74 |     it('should handle context data injection attempts', async () => {

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:71:33)

  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should validate and sanitize LLM responses

    expect(received).not.toHaveProperty(path)

    Expected path: not "__proto__"

    Received value: {}

      122 |       expect(result.confidence).toBeLessThanOrEqual(1);
      123 |       expect(result.constraints).not.toContain('<script>alert("xss")</script>');
    > 124 |       expect(result).not.toHaveProperty('__proto__');
          |                          ^
      125 |       expect(result).not.toHaveProperty('constructor');
      126 |     });
      127 |   });

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:124:26)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should handle concurrent requests efficiently

    TypeError: Cannot read properties of undefined (reading 'has')

      164 |       // Should use cache for duplicate requests
      165 |       const cacheKey = (engine as any).generateCacheKey(policy, contexts[0]);
    > 166 |       expect((engine as any).cache.has(cacheKey)).toBe(true);
          |                                    ^
      167 |     });
      168 |
      169 |     it('should respect rate limits', async () => {

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:166:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should respect rate limits

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      202 |       // Some should succeed, some should fail due to rate limit
      203 |       expect(successful.length).toBeGreaterThan(0);
    > 204 |       expect(failed.length).toBeGreaterThan(0);
          |                             ^
      205 |     });
      206 |
      207 |     it('should implement request timeout', async () => {

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:204:29)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should implement request timeout

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      205 |     });
      206 |
    > 207 |     it('should implement request timeout', async () => {
          |     ^
      208 |       const policy = 'Timeout test policy';
      209 |       const context: DecisionContext = {
      210 |         agent: 'test',

      at test/ai/judgment-engine-comprehensive.test.ts:207:5
      at test/ai/judgment-engine-comprehensive.test.ts:129:3
      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:16:1)

  â— AIJudgmentEngine - Comprehensive Tests â€º Error Recovery and Resilience â€º should retry on transient failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      437 |       const result = await engine.makeDecision(policy, context);
      438 |
    > 439 |       expect(result.decision).toBe('PERMIT');
          |                               ^
      440 |       expect(attemptCount).toBe(3);
      441 |     });
      442 |

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:439:31)

  â— AIJudgmentEngine - Comprehensive Tests â€º Custom Prompt Templates â€º should support custom prompt templates

    expect(received).toContain(expected) // indexOf

    Expected substring: "SECURITY POLICY EVALUATION"
    Received string:    "\"# AIåˆ©ç”¨åˆ¶å¾¡åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ \\n\\nã‚ãªãŸã¯çµ„ç¹”ã®AIåˆ©ç”¨ã«é–¢ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚\\næä¾›ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã¨ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ã¦ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚\\n\\n## åˆ¤å®šåŸºæº–\\n1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨©é™ã¨ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©\\n2. æ“ä½œã®ç›®çš„ã¨çµ„ç¹”ã®ãƒãƒªã‚·ãƒ¼ã¨ã®æ•´åˆæ€§  \\n3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®è©•ä¾¡\\n4. æ™‚é–“çš„ãƒ»åœ°ç†çš„åˆ¶ç´„ã®ç¢ºèª\\n\\n## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±\\n\\n- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: test-agent (ã‚¿ã‚¤ãƒ—: ä¸æ˜)\\n- **è¦æ±‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: read\\n- **å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹**: test-resource\\n- **æ¥­å‹™ç›®çš„**: æœªæŒ‡å®š\\n- **æ™‚åˆ»**: 2026/2/13 9:27:25 (å–¶æ¥­æ™‚é–“å†…)\\n- **å ´æ‰€**: ä¸æ˜\\n- **ã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«**: ä¸æ˜\\n- **éå»ã®é•åå±¥æ­´**: ãªã—\\n\\n## ç’°å¢ƒæƒ…å ±\\n```json\\n{\\n  \\\"custom\\\": \\\"value\\\"\\n}\\n```\\n\\n## é©ç”¨ãƒãƒªã‚·ãƒ¼\\nCustom template test policy\\n\\n## åˆ¤å®šå¯¾è±¡\\nã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: test-agent\\nã‚¢ã‚¯ã‚·ãƒ§ãƒ³: read\\nãƒªã‚½ãƒ¼ã‚¹: test-resource\\nç›®çš„: æœªæŒ‡å®š\\n\\n## å‡ºåŠ›å½¢å¼\\nä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š\\n{\\n  \\\"decision\\\": \\\"PERMIT\\\" | \\\"DENY\\\" | \\\"INDETERMINATE\\\",\\n  \\\"reason\\\": \\\"åˆ¤å®šç†ç”±ã®è©³ç´°èª¬æ˜\\\",\\n  \\\"confidence\\\": 0.0-1.0ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢,\\n  \\\"constraints\\\": [\\\"é©ç”¨ã™ã¹ãåˆ¶ç´„ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"obligations\\\": [\\\"å®Ÿè¡Œã™ã¹ãç¾©å‹™ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"metadata\\\": {\\n    \\\"risk_level\\\": \\\"LOW\\\" | \\\"MEDIUM\\\" | \\\"HIGH\\\",\\n    \\\"policy_violations\\\": [\\\"é•åã—ãŸãƒãƒªã‚·ãƒ¼é …ç›®\\\"],\\n    \\\"recommendations\\\": [\\\"æ¨å¥¨äº‹é …\\\"]\\n  }\\n}\""

      540 |       // Verify custom template was used
      541 |       const call = mockLLM.complete.mock.calls[0][0];
    > 542 |       expect(JSON.stringify(call)).toContain('SECURITY POLICY EVALUATION');
          |                                    ^
      543 |     });
      544 |   });
      545 |

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:542:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Monitoring and Metrics â€º should track decision metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 100

      566 |       const stats = engine.getStats();
      567 |       
    > 568 |       expect(stats.totalDecisions).toBe(3);
          |                                    ^
      569 |       expect(stats.permitCount).toBe(2);
      570 |       expect(stats.denyCount).toBe(1);
      571 |       expect(stats.cacheHitRate).toBeGreaterThanOrEqual(0);

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:568:36)

FAIL src/test/ai/judgment-engine-comprehensive.test.ts (31.643 s)
  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should handle prompt injection attempts safely

    TypeError: Cannot read properties of undefined (reading '0')

      69 |       // Verify the prompt is constructed safely
      70 |       const promptCall = mockLLM.complete.mock.calls[0][0];
    > 71 |       expect(promptCall.messages[0].content).toContain('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒªã‚·ãƒ¼');
         |                                 ^
      72 |     });
      73 |
      74 |     it('should handle context data injection attempts', async () => {

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:71:33)

  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should validate and sanitize LLM responses

    expect(received).not.toHaveProperty(path)

    Expected path: not "__proto__"

    Received value: {}

      122 |       expect(result.confidence).toBeLessThanOrEqual(1);
      123 |       expect(result.constraints).not.toContain('<script>alert("xss")</script>');
    > 124 |       expect(result).not.toHaveProperty('__proto__');
          |                          ^
      125 |       expect(result).not.toHaveProperty('constructor');
      126 |     });
      127 |   });

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:124:26)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should handle concurrent requests efficiently

    TypeError: Cannot read properties of undefined (reading 'has')

      164 |       // Should use cache for duplicate requests
      165 |       const cacheKey = (engine as any).generateCacheKey(policy, contexts[0]);
    > 166 |       expect((engine as any).cache.has(cacheKey)).toBe(true);
          |                                    ^
      167 |     });
      168 |
      169 |     it('should respect rate limits', async () => {

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:166:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should respect rate limits

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      202 |       // Some should succeed, some should fail due to rate limit
      203 |       expect(successful.length).toBeGreaterThan(0);
    > 204 |       expect(failed.length).toBeGreaterThan(0);
          |                             ^
      205 |     });
      206 |
      207 |     it('should implement request timeout', async () => {

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:204:29)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should implement request timeout

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      205 |     });
      206 |
    > 207 |     it('should implement request timeout', async () => {
          |     ^
      208 |       const policy = 'Timeout test policy';
      209 |       const context: DecisionContext = {
      210 |         agent: 'test',

      at src/test/ai/judgment-engine-comprehensive.test.ts:207:5
      at src/test/ai/judgment-engine-comprehensive.test.ts:129:3
      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:16:1)

  â— AIJudgmentEngine - Comprehensive Tests â€º Error Recovery and Resilience â€º should retry on transient failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      437 |       const result = await engine.makeDecision(policy, context);
      438 |
    > 439 |       expect(result.decision).toBe('PERMIT');
          |                               ^
      440 |       expect(attemptCount).toBe(3);
      441 |     });
      442 |

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:439:31)

  â— AIJudgmentEngine - Comprehensive Tests â€º Custom Prompt Templates â€º should support custom prompt templates

    expect(received).toContain(expected) // indexOf

    Expected substring: "SECURITY POLICY EVALUATION"
    Received string:    "\"# AIåˆ©ç”¨åˆ¶å¾¡åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ \\n\\nã‚ãªãŸã¯çµ„ç¹”ã®AIåˆ©ç”¨ã«é–¢ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚\\næä¾›ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã¨ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ã¦ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚\\n\\n## åˆ¤å®šåŸºæº–\\n1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨©é™ã¨ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©\\n2. æ“ä½œã®ç›®çš„ã¨çµ„ç¹”ã®ãƒãƒªã‚·ãƒ¼ã¨ã®æ•´åˆæ€§  \\n3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®è©•ä¾¡\\n4. æ™‚é–“çš„ãƒ»åœ°ç†çš„åˆ¶ç´„ã®ç¢ºèª\\n\\n## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±\\n\\n- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: test-agent (ã‚¿ã‚¤ãƒ—: ä¸æ˜)\\n- **è¦æ±‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: read\\n- **å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹**: test-resource\\n- **æ¥­å‹™ç›®çš„**: æœªæŒ‡å®š\\n- **æ™‚åˆ»**: 2026/2/13 9:27:25 (å–¶æ¥­æ™‚é–“å†…)\\n- **å ´æ‰€**: ä¸æ˜\\n- **ã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«**: ä¸æ˜\\n- **éå»ã®é•åå±¥æ­´**: ãªã—\\n\\n## ç’°å¢ƒæƒ…å ±\\n```json\\n{\\n  \\\"custom\\\": \\\"value\\\"\\n}\\n```\\n\\n## é©ç”¨ãƒãƒªã‚·ãƒ¼\\nCustom template test policy\\n\\n## åˆ¤å®šå¯¾è±¡\\nã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: test-agent\\nã‚¢ã‚¯ã‚·ãƒ§ãƒ³: read\\nãƒªã‚½ãƒ¼ã‚¹: test-resource\\nç›®çš„: æœªæŒ‡å®š\\n\\n## å‡ºåŠ›å½¢å¼\\nä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š\\n{\\n  \\\"decision\\\": \\\"PERMIT\\\" | \\\"DENY\\\" | \\\"INDETERMINATE\\\",\\n  \\\"reason\\\": \\\"åˆ¤å®šç†ç”±ã®è©³ç´°èª¬æ˜\\\",\\n  \\\"confidence\\\": 0.0-1.0ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢,\\n  \\\"constraints\\\": [\\\"é©ç”¨ã™ã¹ãåˆ¶ç´„ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"obligations\\\": [\\\"å®Ÿè¡Œã™ã¹ãç¾©å‹™ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"metadata\\\": {\\n    \\\"risk_level\\\": \\\"LOW\\\" | \\\"MEDIUM\\\" | \\\"HIGH\\\",\\n    \\\"policy_violations\\\": [\\\"é•åã—ãŸãƒãƒªã‚·ãƒ¼é …ç›®\\\"],\\n    \\\"recommendations\\\": [\\\"æ¨å¥¨äº‹é …\\\"]\\n  }\\n}\""

      540 |       // Verify custom template was used
      541 |       const call = mockLLM.complete.mock.calls[0][0];
    > 542 |       expect(JSON.stringify(call)).toContain('SECURITY POLICY EVALUATION');
          |                                    ^
      543 |     });
      544 |   });
      545 |

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:542:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Monitoring and Metrics â€º should track decision metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 100

      566 |       const stats = engine.getStats();
      567 |       
    > 568 |       expect(stats.totalDecisions).toBe(3);
          |                                    ^
      569 |       expect(stats.permitCount).toBe(2);
      570 |       expect(stats.denyCount).toBe(1);
      571 |       expect(stats.cacheHitRate).toBeGreaterThanOrEqual(0);

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:568:36)

FAIL src/test/performance/stress-test.test.ts (106.116 s)
  â— Performance and Stress Tests â€º Load Testing â€º should handle sustained load within SLA

    thrown: "Exceeded timeout of 60000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      72 |
      73 |   describe('Load Testing', () => {
    > 74 |     it('should handle sustained load within SLA', async () => {
         |     ^
      75 |       // SLA: 99% of requests < 100ms, 99.9% availability
      76 |       
      77 |       const responseTimes: number[] = [];

      at src/test/performance/stress-test.test.ts:74:5
      at src/test/performance/stress-test.test.ts:73:3
      at Object.<anonymous> (src/test/performance/stress-test.test.ts:30:1)

  â— Performance and Stress Tests â€º Rate Limiting Performance â€º should enforce rate limits without significant overhead

    expect(received).toBeLessThanOrEqual(expected)

    Expected: <= 1100
    Received:    12000

      345 |       results.forEach(result => {
      346 |         const effectiveRate = (result.allowed / requestsPerClient) * requestsPerClient * 60; // per minute
    > 347 |         expect(effectiveRate).toBeLessThanOrEqual(STRESS_TEST_CONFIG.RATE_LIMIT * 1.1); // Within 10% tolerance
          |                               ^
      348 |       });
      349 |
      350 |       // Verify low overhead

      at src/test/performance/stress-test.test.ts:347:31
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/performance/stress-test.test.ts:345:15)

FAIL src/test/mcp/stdio-router.test.ts (156.481 s)
  â— StdioRouter â€º Server Lifecycle â€º should start server successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Successfully started upstream server: test-server"
    Received
           1: "Configured upstream server: test-server", {"args": ["test.js"], "command": "node"}
           2: "ğŸš€ Starting upstream server test-server"
           3: "ğŸ“ test-server startup message detected: Server running on stdio"

    Number of calls: 5

      128 |       });
      129 |       
    > 130 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      131 |         'Successfully started upstream server: test-server'
      132 |       );
      133 |     });

      at Object.<anonymous> (src/test/mcp/stdio-router.test.ts:130:31)

  â— StdioRouter â€º Request Routing â€º should aggregate tools/list from multiple servers

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      348 |     });
      349 |
    > 350 |     it('should aggregate tools/list from multiple servers', async () => {
          |     ^
      351 |       // Add second server
      352 |       const { process: mockProcess2, stdin: stdin2, stdout: stdout2, stderr: stderr2 } = createMockProcess();
      353 |       mockSpawn.mockReturnValue(mockProcess2);

      at src/test/mcp/stdio-router.test.ts:350:5
      at src/test/mcp/stdio-router.test.ts:280:3
      at Object.<anonymous> (src/test/mcp/stdio-router.test.ts:39:1)

A worker process has failed to exit gracefully and has been force exited. This is likely caused by tests leaking due to improper teardown. Try running with --detectOpenHandles to find leaks. Active timers can also cause this, ensure that .unref() was called on them.
Summary of all failing tests
FAIL src/test/e2e/mcp-proxy-integration.test.ts
  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º è¨±å¯ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚ŠãŒæˆåŠŸã™ã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º ç¦æ­¢ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãŒæ‹’å¦ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º åˆ¶ç´„ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ã§åŒ¿ååŒ–ãŒé©ç”¨ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º ãƒªã‚½ãƒ¼ã‚¹ä¸€è¦§å–å¾—ãŒåˆ¶å¾¡ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã¨ãƒãƒªã‚·ãƒ¼åˆ¶å¾¡ â€º ãƒªã‚½ãƒ¼ã‚¹èª­ã¿å–ã‚ŠãŒãƒãƒªã‚·ãƒ¼ã§åˆ¶å¾¡ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ç›£æŸ»ã¨ãƒ­ã‚°è¨˜éŒ² â€º ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ç›£æŸ»ã¨ãƒ­ã‚°è¨˜éŒ² â€º ãƒãƒªã‚·ãƒ¼é•åãŒç‰¹åˆ¥ã«ãƒãƒ¼ã‚¯ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â€º åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¿”ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ç„¡åŠ¹ãªãƒ„ãƒ¼ãƒ«åã§ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

  â— AEGIS E2E Tests - MCP Proxy Integration â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹

    McpError: MCP error -32000: Connection closed

      at Client._onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:312:19)
      at StdioClientTransport._transport.onclose (node_modules/@modelcontextprotocol/sdk/src/shared/protocol.ts:283:12)
      at ChildProcess.<anonymous> (node_modules/@modelcontextprotocol/sdk/src/client/stdio.ts:150:21)

FAIL test/integration/real-ai-api.test.ts
  â— AIåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ - å®ŸAPIãƒ†ã‚¹ãƒˆ â€º å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ç¢ºèª â€º ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒªã‚·ãƒ¼åˆ¤å®š - å®Ÿéš›ã«APIã‚’å‘¼ã³å‡ºã™

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      76 |         // åŸºæœ¬çš„ãªã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
      77 |         expect(decision.decision).toMatch(/PERMIT|DENY|INDETERMINATE/);
    > 78 |         expect(decision.confidence).toBeGreaterThan(0);
         |                                     ^
      79 |         expect(decision.reason).toBeTruthy();
      80 |         expect(elapsed).toBeLessThan(10000); // 10ç§’ä»¥å†…
      81 |

      at Object.<anonymous> (test/integration/real-ai-api.test.ts:78:37)

  â— AIåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ - å®ŸAPIãƒ†ã‚¹ãƒˆ â€º å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ç¢ºèª â€º ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‹•ä½œç¢ºèª

    expect(received).toBeLessThan(expected)

    Expected: < 22.900000000000002
    Received:   224

      121 |
      122 |       // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®å–å¾—ã¯é«˜é€Ÿã§ã‚ã‚‹ã¹ã
    > 123 |       expect(time2).toBeLessThan(time1 * 0.1); // 10%æœªæº€ã®æ™‚é–“
          |                     ^
      124 |       expect(decision2).toEqual(decision1); // åŒã˜çµæœ
      125 |
      126 |       console.log(`\nâœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ­£å¸¸ã«å‹•ä½œ: ${Math.round((1 - time2/time1) * 100)}% é«˜é€ŸåŒ–`);

      at Object.<anonymous> (test/integration/real-ai-api.test.ts:123:21)

  â— AIåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ - å®ŸAPIãƒ†ã‚¹ãƒˆ â€º å®Ÿéš›ã®APIã‚³ãƒ¼ãƒ«ç¢ºèª â€º è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ã§ã®åˆ¤å®š

    expect(received).toContain(expected) // indexOf

    Expected substring: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
    Received string:    "AIåˆ¤å®šã‚¨ãƒ©ãƒ¼: Anthropic API Error: 401 {\"type\":\"error\",\"error\":{\"type\":\"authentication_error\",\"message\":\"invalid x-api-key\"},\"request_id\":\"req_011CY57tfah5MKuCtsG1NEXi\"}"

      170 |       // ã‚ˆã‚Šè©³ç´°ãªåˆ†æ
      171 |       expect(decision.decision).toBeDefined();
    > 172 |       expect(decision.reason).toContain('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£');
          |                               ^
      173 |       
      174 |       if (decision.obligations?.length) {
      175 |         console.log('\nï¿½ï¿½ AIãŒæ¨å¥¨ã™ã‚‹ç¾©å‹™:', decision.obligations);

      at Object.<anonymous> (test/integration/real-ai-api.test.ts:172:31)

FAIL test/constraints-obligations.test.ts
  â— åˆ¶ç´„ãƒ»ç¾©å‹™å‡¦ç† - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ObligationExecutor - ç¾©å‹™ã®å®Ÿè¡Œ â€º è¤‡æ•°ç¾©å‹™ã®ä¸¦åˆ—å®Ÿè¡Œ â€º è¤‡æ•°ã®ç¾©å‹™ã‚’åŠ¹ç‡çš„ã«ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'send')

      441 |         // å…¨ã¦ã®ç¾©å‹™ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
      442 |         expect(executor['auditLogger'].log).toHaveBeenCalled();
    > 443 |         expect(executor['notificationService'].send).toHaveBeenCalled();
          |                                                ^
      444 |
      445 |         // ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚Šã€é †æ¬¡å®Ÿè¡Œã‚ˆã‚Šé«˜é€Ÿã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      446 |         expect(elapsed).toBeLessThan(1000); // å„ç¾©å‹™ãŒ200msç¨‹åº¦ã¨ä»®å®š

      at Object.<anonymous> (test/constraints-obligations.test.ts:443:48)

  â— åˆ¶ç´„ãƒ»ç¾©å‹™å‡¦ç† - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ObligationExecutor - ç¾©å‹™ã®å®Ÿè¡Œ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ç¾©å‹™å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ãŒå‡¦ç†ã¯ç¶™ç¶šã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'send')

      459 |
      460 |         // é€šçŸ¥é€ä¿¡ã‚’ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹
    > 461 |         executor['notificationService'].send.mockRejectedValueOnce(
          |                                         ^
      462 |           new Error('Notification service unavailable')
      463 |         );
      464 |

      at Object.<anonymous> (test/constraints-obligations.test.ts:461:41)

FAIL src/test/mcp-http-proxy-extended.test.ts
  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢è¨­å®š â€º ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒãªã„å ´åˆã¯UUIDã‚’ç”Ÿæˆã™ã‚‹

    expect(received).toBeDefined()

    Received: undefined

      208 |       // UUIDãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
      209 |       const context = proxy['requestContext'].get('test-uuid-123');
    > 210 |       expect(context).toBeDefined();
          |                       ^
      211 |     });
      212 |
      213 |     it('ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡å¾Œã«å¤ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã™ã‚‹', () => {

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:210:23)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒªã‚½ãƒ¼ã‚¹èª­ã¿å–ã‚Šçµæœã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:272:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒ„ãƒ¼ãƒ«åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:301:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§stdioã‚µãƒ¼ãƒãƒ¼ã‚’è¿½åŠ ã™ã‚‹

    TypeError: this.stdioRouter.addServerFromConfig is not a function

      540 |       this.enableBridgeMode();
      541 |     }
    > 542 |     this.stdioRouter!.addServerFromConfig(name, config);
          |                       ^
      543 |     this.logger.info(`Stdio upstream server configured: ${name}`);
      544 |   }
      545 |   

      at MCPHttpPolicyProxy.addStdioUpstreamServer (src/mcp/http-proxy.ts:542:23)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:327:13)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:350:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ â€º ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå¤§æ–‡å­—ã®å ´åˆã‚‚å‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, ObjectContaining {"agent": "TEST-AGENT"}, Any<Object>

    Number of calls: 0

      402 |       await enforcePolicy('read', 'test://resource', context);
      403 |
    > 404 |       expect(mockJudgmentEngine.makeDecision).toHaveBeenCalledWith(
          |                                               ^
      405 |         expect.any(String),
      406 |         expect.objectContaining({
      407 |           agent: 'TEST-AGENT'

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:404:47)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º åŒ…æ‹¬çš„ãªãƒ˜ãƒ«ã‚¹æƒ…å ±ã‚’è¿”ã™

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:416:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Upstream request failed", Any<Error>

    Number of calls: 0

      467 |       ).rejects.toThrow();
      468 |
    > 469 |       expect(mockLogger.error).toHaveBeenCalledWith(
          |                                ^
      470 |         expect.stringContaining('Upstream request failed'),
      471 |         expect.any(Error)
      472 |       );

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:469:32)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º JSON-RPCã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†ã™ã‚‹

    expect(received).rejects.toThrow(expected)

    Expected substring: "Internal error"
    Received message:   "No upstream servers available"

          398 |     
          399 |     if (!upstreamServer) {
        > 400 |       throw new Error('No upstream servers available');
              |             ^
          401 |     }
          402 |     
          403 |     try {

      at MCPHttpPolicyProxy.forwardToUpstream (src/mcp/http-proxy.ts:400:13)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:491:9)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:492:17)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’å‡¦ç†ã™ã‚‹

    expect(received).rejects.toThrow(expected)

    Expected substring: "Request failed with status 500"
    Received message:   "No upstream servers available"

          398 |     
          399 |     if (!upstreamServer) {
        > 400 |       throw new Error('No upstream servers available');
              |             ^
          401 |     }
          402 |     
          403 |     try {

      at MCPHttpPolicyProxy.forwardToUpstream (src/mcp/http-proxy.ts:400:13)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:505:9)
      at Object.toThrow (node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:506:17)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º APIç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:512:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º APIç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ä½œæˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:539:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º APIç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º ç„¡åŠ¹ãªãƒãƒªã‚·ãƒ¼ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:567:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º MCPç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º MCPãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:594:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º MCPç®¡ç†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ â€º MCPå‡¦ç†ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:633:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åœæ­¢å‡¦ç† â€º HTTPã‚µãƒ¼ãƒãƒ¼ã‚’é©åˆ‡ã«åœæ­¢ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:669:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åœæ­¢å‡¦ç† â€º ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚‚åœæ­¢ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:681:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åœæ­¢å‡¦ç† â€º åœæ­¢æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:688:7)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨ã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'bind')

      704 |       proxy.addPolicy('default-policy', 'Default policy content');
      705 |       
    > 706 |       const selectPolicy = proxy['selectPolicy'].bind(proxy);
          |                                                  ^
      707 |       const policy = selectPolicy('unknown-action', 'unknown-resource');
      708 |       
      709 |       expect(policy).toBe('Default policy content');

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:706:50)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦ãƒãƒªã‚·ãƒ¼ã‚’é¸æŠã™ã‚‹

    TypeError: Cannot read properties of undefined (reading 'bind')

      715 |       proxy.addPolicy('file-system-policy', 'File system policy');
      716 |       
    > 717 |       const selectPolicy = proxy['selectPolicy'].bind(proxy);
          |                                                  ^
      718 |       
      719 |       expect(selectPolicy('read', 'customer://data')).toBe('Customer data policy');
      720 |       expect(selectPolicy('read', 'email://inbox')).toBe('Email access policy');

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:717:50)

  â— MCPHttpPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚·ãƒ¼é¸æŠã‚’è¡Œã†

    TypeError: Cannot read properties of undefined (reading 'bind')

      725 |       proxy.addPolicy('claude-desktop-policy', 'Claude Desktop policy');
      726 |       
    > 727 |       const selectPolicy = proxy['selectPolicy'].bind(proxy);
          |                                                  ^
      728 |       const policy = selectPolicy('read', 'test://resource', 'claude-desktop');
      729 |       
      730 |       expect(policy).toBe('Claude Desktop policy');

      at Object.<anonymous> (src/test/mcp-http-proxy-extended.test.ts:727:50)

FAIL src/test/error-handling/external-dependencies-failures.test.ts (5.538 s)
  â— External Dependencies and Integration Failures â€º Network Service Failures â€º should handle DNS resolution failures

    TypeError: Cannot set property lookup of #<Object> which has only a getter

      50 |
      51 |       // Mock DNS failure
    > 52 |       (dns.lookup as jest.Mock) = jest.fn((hostname, callback) => {
         |                                ^
      53 |         callback(new Error('ENOTFOUND: DNS lookup failed'), null);
      54 |       });
      55 |

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:52:32)

  â— External Dependencies and Integration Failures â€º Network Service Failures â€º should handle SSL/TLS certificate errors

    TypeError: http_proxy_1.MCPHttpProxy is not a constructor

      75 |
      76 |     it('should handle SSL/TLS certificate errors', async () => {
    > 77 |       const httpProxy = new MCPHttpProxy({
         |                         ^
      78 |         port: 3000,
      79 |         upstreamMCPServers: [{
      80 |           url: 'https://secure.example.com',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:77:25)

  â— External Dependencies and Integration Failures â€º Network Service Failures â€º should handle proxy connection failures

    TypeError: http_proxy_1.MCPHttpProxy is not a constructor

      110 |       process.env.HTTPS_PROXY = 'http://proxy.example.com:8080';
      111 |       
    > 112 |       const httpProxy = new MCPHttpProxy({
          |                         ^
      113 |         port: 3000,
      114 |         upstreamMCPServers: [{
      115 |           url: 'https://api.example.com',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:112:25)

  â— External Dependencies and Integration Failures â€º External API Failures â€º should handle OpenAI API outage

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      173 |       });
      174 |
    > 175 |       expect(result.decision).toBe('PERMIT');
          |                               ^
      176 |       expect(result.reason).toContain('Fallback');
      177 |       expect(mockLogger.warn).toHaveBeenCalledWith(
      178 |         expect.stringContaining('Primary LLM failed, using fallback'),

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:175:31)

  â— External Dependencies and Integration Failures â€º External API Failures â€º should handle GeoIP service rate limiting

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {}

      207 |       };
      208 |
    > 209 |       await expect(
          |             ^
      210 |         geoRestrictor.apply('geo-restrict:JP', {}, context)
      211 |       ).rejects.toThrow('Rate limit exceeded');
      212 |

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:209:13)

  â— External Dependencies and Integration Failures â€º Message Queue and Event Bus Failures â€º should handle event bus disconnection

    TypeError: auditSystem.publishEvent is not a function

      285 |
      286 |       await expect(
    > 287 |         auditSystem.publishEvent({
          |                     ^
      288 |           type: 'policy.decision',
      289 |           data: {
      290 |             decision: 'DENY',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:287:21)

  â— External Dependencies and Integration Failures â€º Database and Storage Failures â€º should handle database connection pool exhaustion

    expect(received).rejects.toThrow()

    Received promise resolved instead of rejected
    Resolved to value: {"executedAt": 2026-02-13T00:26:55.552Z, "metadata": {"actionId": "action-1770942415549-acg23oz0g", "actionType": "delete", "resource": "customer-data", "scheduledFor": 2027-02-13T00:26:55.551Z}, "success": true}

      321 |       (dataLifecycle as any).db = mockDb;
      322 |
    > 323 |       await expect(
          |             ^
      324 |         dataLifecycle.execute(
      325 |           'schedule-deletion:30d',
      326 |           {

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:323:13)

  â— External Dependencies and Integration Failures â€º Database and Storage Failures â€º should handle storage quota exceeded

    TypeError: auditSystem.writeAuditLog is not a function

      363 |
      364 |       await expect(
    > 365 |         auditSystem.writeAuditLog({
          |                     ^
      366 |           timestamp: new Date(),
      367 |           action: 'test',
      368 |           decision: 'PERMIT',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:365:21)

  â— External Dependencies and Integration Failures â€º Authentication and Authorization Failures â€º should handle OAuth token expiration

    TypeError: http_proxy_1.MCPHttpProxy is not a constructor

      421 |   describe('Authentication and Authorization Failures', () => {
      422 |     it('should handle OAuth token expiration', async () => {
    > 423 |       const httpProxy = new MCPHttpProxy({
          |                         ^
      424 |         port: 3000,
      425 |         upstreamMCPServers: [{
      426 |           url: 'https://oauth-api.example.com',

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:423:25)

  â— External Dependencies and Integration Failures â€º Authentication and Authorization Failures â€º should handle API key revocation

    expect(received).toContain(expected) // indexOf

    Expected substring: "Authentication failed"
    Received string:    "AIåˆ¤å®šã‚¨ãƒ©ãƒ¼: Invalid API key: Key has been revoked"

      500 |
      501 |       expect(result.decision).toBe('INDETERMINATE');
    > 502 |       expect(result.reason).toContain('Authentication failed');
          |                             ^
      503 |       
      504 |       expect(mockLogger.critical).toHaveBeenCalledWith(
      505 |         expect.stringContaining('API key revoked'),

      at Object.<anonymous> (src/test/error-handling/external-dependencies-failures.test.ts:502:29)

FAIL src/test/integration/mcp-enforcement.test.ts
  â— MCP + EnforcementSystem Integration â€º Stdio Proxy Integration â€º should use EnforcementSystem for constraints

    TypeError: Cannot read properties of undefined (reading 'contents')

      78 |
      79 |       // åŒ¿ååŒ–ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 80 |       const parsedContent = JSON.parse(result.contents[0].text);
         |                                               ^
      81 |       expect(parsedContent.name).toBe('[REDACTED]');
      82 |       expect(parsedContent.email).toMatch(/\*\*\*\*@example\.com/);
      83 |       expect(parsedContent.phone).toBe('[REDACTED]');

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:80:47)

  â— MCP + EnforcementSystem Integration â€º Stdio Proxy Integration â€º should use EnforcementSystem for obligations

    expect(received).toContain(expected) // indexOf

    Expected value: "ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²"
    Received array: []

      101 |
      102 |       // ç¾©å‹™ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    > 103 |       expect(executedObligations).toContain('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²');
          |                                   ^
      104 |       expect(executedObligations).toContain('30æ—¥å¾Œå‰Šé™¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š');
      105 |     });
      106 |

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:103:35)

  â— MCP + EnforcementSystem Integration â€º Stdio Proxy Integration â€º should handle constraint errors gracefully

    expect(received).toEqual(expected) // deep equality

    Expected: {"test": "data"}
    Received: undefined

      118 |       );
      119 |
    > 120 |       expect(result).toEqual(testData);
          |                      ^
      121 |     });
      122 |   });
      123 |

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:120:22)

  â— MCP + EnforcementSystem Integration â€º HTTP Proxy Integration â€º should use EnforcementSystem for constraints

    TypeError: Cannot read properties of undefined (reading 'contents')

      150 |
      151 |       // åŒ¿ååŒ–ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 152 |       const parsedContent = JSON.parse(result.contents[0].text);
          |                                               ^
      153 |       expect(parsedContent.name).toBe('[REDACTED]');
      154 |       expect(parsedContent.email).toMatch(/\*\*\*\*@example\.com/);
      155 |       expect(parsedContent.ssn).toBe('[REDACTED]');

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:152:47)

  â— MCP + EnforcementSystem Integration â€º HTTP Proxy Integration â€º should use EnforcementSystem for obligations

    expect(received).toContain(expected) // indexOf

    Expected value: "ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²"
    Received array: []

      172 |
      173 |       // ç¾©å‹™ãŒå®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
    > 174 |       expect(executedObligations).toContain('ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²');
          |                                   ^
      175 |       expect(executedObligations).toContain('ã‚¢ã‚¯ã‚»ã‚¹é€šçŸ¥é€ä¿¡');
      176 |     });
      177 |

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:174:35)

  â— MCP + EnforcementSystem Integration â€º Legacy to New System Migration â€º should not have any legacy anonymization code in stdio proxy

    expect(received).toBeUndefined()

    Received: [Function sendNotification]

      203 |       // ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèª
      204 |       expect((stdioProxy as any).anonymizeData).toBeUndefined();
    > 205 |       expect((stdioProxy as any).sendNotification).toBeUndefined();
          |                                                    ^
      206 |       expect((stdioProxy as any).scheduleDataDeletion).toBeUndefined();
      207 |       expect((stdioProxy as any).generateAccessReport).toBeUndefined();
      208 |     });

      at Object.<anonymous> (src/test/integration/mcp-enforcement.test.ts:205:52)

FAIL src/test/mcp-stdio-proxy.test.ts
  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º MCPã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "name": "aegis-policy-proxy",
    +   "name": "aegis-proxy",
        "version": "1.0.0",
      },
      Object {
        "capabilities": Object {
    -     "resources": Object {},
    +     "prompts": Object {},
    +     "resources": Object {
    +       "listChanged": true,
    +     },
          "tools": Object {},
        },
      },

    Number of calls: 1

      148 |   describe('åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—', () => {
      149 |     it('MCPã‚µãƒ¼ãƒãƒ¼ã¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹', () => {
    > 150 |       expect(Server).toHaveBeenCalledWith(
          |                      ^
      151 |         {
      152 |           name: 'aegis-policy-proxy',
      153 |           version: '1.0.0'

      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:150:22)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º resources/read ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:198:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º resources/read ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:198:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º DENYã®åˆ¤å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:228:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ â€º DENYã®åˆ¤å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:228:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º tools/call ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:255:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º tools/call ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:255:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º åˆ¶ç´„ã‚’é©ç”¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŠ å·¥ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:307:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œåˆ¶å¾¡ â€º åˆ¶ç´„ã‚’é©ç”¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŠ å·¥ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:307:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º tools/list ã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’è¿”ã™

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:343:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º tools/list ã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã‚’è¿”ã™

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:343:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º resources/list ã§åˆ©ç”¨å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚’è¿”ã™

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:370:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¹ãƒˆæ“ä½œ â€º resources/list ã§åˆ©ç”¨å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚’è¿”ã™

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:370:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º è¨­å®šã•ã‚ŒãŸä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’ç™»éŒ²ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:382:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º è¨­å®šã•ã‚ŒãŸä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’ç™»éŒ²ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:382:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º å…¨ã¦ã®ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:394:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º å…¨ã¦ã®ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:394:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º åœæ­¢æ™‚ã«ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:403:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ç®¡ç† â€º åœæ­¢æ™‚ã«ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:403:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼æ™‚ã«INDETERMINATEã¨ã—ã¦å‡¦ç†

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:419:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼æ™‚ã«INDETERMINATEã¨ã—ã¦å‡¦ç†

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:419:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:448:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:448:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ç®¡ç† â€º ãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ ãƒ»æ›´æ–°ã§ãã‚‹

    TypeError: proxy.updatePolicy is not a function

      469 |       expect(proxy['policies'].get('test-policy')).toBe('ãƒ†ã‚¹ãƒˆãƒãƒªã‚·ãƒ¼å†…å®¹');
      470 |
    > 471 |       proxy.updatePolicy('test-policy', 'æ›´æ–°ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼å†…å®¹');
          |             ^
      472 |       expect(proxy['policies'].get('test-policy')).toBe('æ›´æ–°ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼å†…å®¹');
      473 |     });
      474 |

      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:471:13)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ â€º è¤‡æ•°ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

    TypeError: this.stdioRouter.startServers is not a function

      1503 |     } else {
      1504 |       // ã¾ã èµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯èµ·å‹•
    > 1505 |       await this.stdioRouter.startServers();
           |                              ^
      1506 |     }
      1507 |     
      1508 |     // èµ·å‹•å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª

      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1505:30)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:502:7)

  â— MCPStdioPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ â€º è¤‡æ•°ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

    listen EADDRINUSE: address already in use :::3000

      1480 |     // APIã‚µãƒ¼ãƒãƒ¼èµ·å‹•
      1481 |     const apiPort = parseInt(process.env.MCP_PROXY_PORT || '3000');
    > 1482 |     this.apiServer = this.apiApp.listen(apiPort, () => {
           |                                  ^
      1483 |       // In stdio mode, don't log anything to avoid corrupting JSON-RPC output
      1484 |       if (process.env.MCP_TRANSPORT !== 'stdio' && process.env.LOG_SILENT !== 'true') {
      1485 |         this.logger.info(`ï¿½ï¿½ AEGIS API Server running at http://localhost:${apiPort}`);

      at Function.listen (node_modules/express/lib/application.js:635:24)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1482:34)
      at Object.<anonymous> (src/test/mcp-stdio-proxy.test.ts:502:7)

FAIL src/test/mcp/base-proxy.test.ts
  â— MCPPolicyProxyBase â€º initialization â€º should work without judgment engine

    AIJudgmentEngine is required for AIPolicyEngine

      48 |     // AIãƒãƒªã‚·ãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
      49 |     if (!judgmentEngine) {
    > 50 |       throw new Error('AIJudgmentEngine is required for AIPolicyEngine');
         |             ^
      51 |     }
      52 |     this.aiPolicyEngine = new AIPolicyEngine(judgmentEngine, {
      53 |       aiThreshold: parseFloat(process.env.AEGIS_AI_THRESHOLD || '0.7'),

      at new MCPPolicyProxyBase (src/mcp/base-proxy.ts:50:13)
      at new TestMCPProxy (src/test/mcp/base-proxy.test.ts:29:9)
      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:150:30)

  â— MCPPolicyProxyBase â€º selectApplicablePolicy â€º should select high-risk-operations-policy for dangerous actions

    expect(received).toBe(expected) // Object.is equality

    Expected: "high-risk-operations-policy"
    Received: "file-system-policy"

      217 |
      218 |       const policy = await proxy.testSelectApplicablePolicy(deleteContext);
    > 219 |       expect(policy).toBe('high-risk-operations-policy');
          |                      ^
      220 |     });
      221 |
      222 |     it('should select default-policy when no specific policy matches', async () => {

      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:219:22)

  â— MCPPolicyProxyBase â€º addPolicy â€º should add policy to internal map

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Policy added: test-policy"
    Received
           1: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: time-based"
           2: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: agent-info"
           3: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: resource-classifier"

    Number of calls: 5

      357 |
      358 |       expect(proxy.getPolicies().get('test-policy')).toBe('Test policy content');
    > 359 |       expect(mockLogger.info).toHaveBeenCalledWith('Policy added: test-policy');
          |                               ^
      360 |     });
      361 |
      362 |     it('should handle policy addition errors gracefully', () => {

      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:359:31)

  â— MCPPolicyProxyBase â€º addPolicy â€º should handle policy addition errors gracefully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Policy added: error-policy"
    Received
           1: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: time-based"
           2: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: agent-info"
           3: "ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼ç™»éŒ²: resource-classifier"

    Number of calls: 5

      366 |       // Should still add to internal map
      367 |       expect(proxy.getPolicies().get('error-policy')).toBe('Error policy content');
    > 368 |       expect(mockLogger.info).toHaveBeenCalledWith('Policy added: error-policy');
          |                               ^
      369 |     });
      370 |   });
      371 |

      at Object.<anonymous> (src/test/mcp/base-proxy.test.ts:368:31)

FAIL src/test/core-controller.test.ts
  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 4
    Received number of calls: 5

      103 |       expect(AIJudgmentEngine).toHaveBeenCalledWith(testConfig.llm);
      104 |       expect(ContextCollector).toHaveBeenCalled();
    > 105 |       expect(mockContextCollector.registerEnricher).toHaveBeenCalledTimes(4); // 4ã¤ã®ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼
          |                                                     ^
      106 |       expect(mockLogger.info).toHaveBeenCalledWith('Context enrichers registered successfully');
      107 |     });
      108 |

      at Object.<anonymous> (src/test/core-controller.test.ts:105:53)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      109 |     it('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹', () => {
      110 |       // setupDefaultPoliciesãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 111 |       expect(controller['policies'].size).toBeGreaterThan(0);
          |                                           ^
      112 |     });
      113 |   });
      114 |

      at Object.<anonymous> (src/test/core-controller.test.ts:111:43)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º å®Œå…¨ãªåˆ¤å®šãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, {"action": "read", "agent": "test-agent", "environment": {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}, "resource": "customer://data/123", "time": 2026-02-13T00:26:59.682Z}, {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}

    Number of calls: 0

      162 |       );
      163 |
    > 164 |       expect(mockJudgmentEngine.makeDecision).toHaveBeenCalledWith(
          |                                               ^
      165 |         expect.any(String), // ãƒãƒªã‚·ãƒ¼æ–‡å­—åˆ—
      166 |         enrichedContext,
      167 |         enrichedContext.environment

      at Object.<anonymous> (src/test/core-controller.test.ts:164:47)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º DENYã®åˆ¤å®šã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "external-agent", "DENY", "customer://all-data", "External agents cannot delete customer data"

    Number of calls: 0

      218 |       expect(result.decision).toBe('DENY');
      219 |       expect(result.riskLevel).toBe('CRITICAL');
    > 220 |       expect(mockLogger.decision).toHaveBeenCalledWith(
          |                                   ^
      221 |         'external-agent',
      222 |         'DENY',
      223 |         'customer://all-data',

      at Object.<anonymous> (src/test/core-controller.test.ts:220:35)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º æ±ºå®šå±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      338 |
      339 |       // å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 340 |       expect(controller['decisionHistory']).toHaveLength(1);
          |                                             ^
      341 |       expect(controller['decisionHistory'][0]).toMatchObject({
      342 |         timestamp: expect.any(Date),
      343 |         context: enrichedContext,

      at Object.<anonymous> (src/test/core-controller.test.ts:340:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º å±¥æ­´ã®ä¸Šé™ã‚’å®ˆã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 3
    Received length: 0
    Received array:  []

      383 |
      384 |       // å±¥æ­´ãŒ3ä»¶ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 385 |       expect(limitedController['decisionHistory']).toHaveLength(3);
          |                                                    ^
      386 |       // æœ€æ–°ã®3ä»¶ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      387 |       expect(limitedController['decisionHistory'][0].context.agent).toBe('agent-1');
      388 |       expect(limitedController['decisionHistory'][2].context.agent).toBe('agent-3');

      at Object.<anonymous> (src/test/core-controller.test.ts:385:52)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º çµ±è¨ˆæƒ…å ± â€º çµ±è¨ˆæƒ…å ±ã‚’åé›†ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 5
    + Received  + 5

      Object {
    -   "averageConfidence": closeTo<0.8375, 2>,
    +   "averageConfidence": 0,
        "averageProcessingTime": Any<Number>,
    -   "denyCount": 1,
    -   "indeterminateCount": 1,
    -   "permitCount": 2,
    -   "totalDecisions": 4,
    +   "denyCount": 0,
    +   "indeterminateCount": 0,
    +   "permitCount": 0,
    +   "totalDecisions": 0,
      }

      415 |       const stats = controller.getStatistics();
      416 |
    > 417 |       expect(stats).toMatchObject({
          |                     ^
      418 |         totalDecisions: 4,
      419 |         permitCount: 2,
      420 |         denyCount: 1,

      at Object.<anonymous> (src/test/core-controller.test.ts:417:21)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º æ±ºå®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      470 |       controller.clearCache();
      471 |       
    > 472 |       expect(mockJudgmentEngine.clearCache).toHaveBeenCalled();
          |                                             ^
      473 |       expect(mockLogger.info).toHaveBeenCalledWith('Decision cache cleared');
      474 |     });
      475 |

      at Object.<anonymous> (src/test/core-controller.test.ts:472:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º å‡¦ç†æ™‚é–“ã‚’æ­£ç¢ºã«æ¸¬å®šã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 150
    Received:   55

      498 |
      499 |       // å‡¦ç†æ™‚é–“ãŒé©åˆ‡ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆä½™è£•ã‚’æŒãŸã›ã¦150msä»¥ä¸Šï¼‰
    > 500 |       expect(result.processingTime).toBeGreaterThan(150);
          |                                     ^
      501 |     });
      502 |   });
      503 | });

      at Object.<anonymous> (src/test/core-controller.test.ts:500:37)

FAIL src/test/mcp-http-proxy.test.ts
  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º Expressã‚¢ãƒ—ãƒªã¨MCPã‚µãƒ¼ãƒãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "name": "aegis-policy-proxy-http",
    +   "name": "aegis-proxy",
        "version": "1.0.0",
      },
      Object {
        "capabilities": Object {
    -     "resources": Object {},
    +     "prompts": Object {},
    +     "resources": Object {
    +       "listChanged": true,
    +     },
          "tools": Object {},
        },
      },

    Number of calls: 1

      127 |     it('Expressã‚¢ãƒ—ãƒªã¨MCPã‚µãƒ¼ãƒãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹', () => {
      128 |       expect(express).toHaveBeenCalled();
    > 129 |       expect(Server).toHaveBeenCalledWith(
          |                      ^
      130 |         {
      131 |           name: 'aegis-policy-proxy-http',
      132 |           version: '1.0.0'

      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:129:22)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ãŒç™»éŒ²ã•ã‚Œã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:147:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º resources/read ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚’å®Ÿè¡Œã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:176:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º tools/call ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åˆ¶ç´„ã‚’é©ç”¨ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:224:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º DENYã®åˆ¤å®šæ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:252:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ â€º ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¨­å®šã•ã‚Œã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:267:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼é€šä¿¡ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:319:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼é€šä¿¡ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:354:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼é€šä¿¡ â€º ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:376:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:405:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:423:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ â€º è¤‡æ•°ã®åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:453:7)

  â— MCPHttpPolicyProxy - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç† â€º ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ãƒ»åœæ­¢ã§ãã‚‹

    TypeError: this.app.put is not a function

      647 |     });
      648 |
    > 649 |     this.app.put('/policies/:id', async (req, res) => {
          |              ^
      650 |       try {
      651 |         const { policyLoader } = await import('../policies/policy-loader.js');
      652 |         await policyLoader.updatePolicy(req.params.id, req.body);

      at MCPHttpPolicyProxy.start (src/mcp/http-proxy.ts:649:14)
      at Object.<anonymous> (src/test/mcp-http-proxy.test.ts:472:7)

FAIL test/core-controller.test.ts
  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 4
    Received number of calls: 5

      103 |       expect(AIJudgmentEngine).toHaveBeenCalledWith(testConfig.llm);
      104 |       expect(ContextCollector).toHaveBeenCalled();
    > 105 |       expect(mockContextCollector.registerEnricher).toHaveBeenCalledTimes(4); // 4ã¤ã®ã‚¨ãƒ³ãƒªãƒƒãƒãƒ£ãƒ¼
          |                                                     ^
      106 |       expect(mockLogger.info).toHaveBeenCalledWith('Context enrichers registered successfully');
      107 |     });
      108 |

      at Object.<anonymous> (test/core-controller.test.ts:105:53)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º åˆæœŸåŒ–ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      109 |     it('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã‚‹', () => {
      110 |       // setupDefaultPoliciesãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 111 |       expect(controller['policies'].size).toBeGreaterThan(0);
          |                                           ^
      112 |     });
      113 |   });
      114 |

      at Object.<anonymous> (test/core-controller.test.ts:111:43)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º å®Œå…¨ãªåˆ¤å®šãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, {"action": "read", "agent": "test-agent", "environment": {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}, "resource": "customer://data/123", "time": 2026-02-13T00:26:59.974Z}, {"agentType": "internal", "businessHours": true, "clientIP": "192.168.1.1", "resourceSensitivity": "high"}

    Number of calls: 0

      162 |       );
      163 |
    > 164 |       expect(mockJudgmentEngine.makeDecision).toHaveBeenCalledWith(
          |                                               ^
      165 |         expect.any(String), // ãƒãƒªã‚·ãƒ¼æ–‡å­—åˆ—
      166 |         enrichedContext,
      167 |         enrichedContext.environment

      at Object.<anonymous> (test/core-controller.test.ts:164:47)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼ â€º DENYã®åˆ¤å®šã‚’æ­£ã—ãå‡¦ç†ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "external-agent", "DENY", "customer://all-data", "External agents cannot delete customer data"

    Number of calls: 0

      218 |       expect(result.decision).toBe('DENY');
      219 |       expect(result.riskLevel).toBe('CRITICAL');
    > 220 |       expect(mockLogger.decision).toHaveBeenCalledWith(
          |                                   ^
      221 |         'external-agent',
      222 |         'DENY',
      223 |         'customer://all-data',

      at Object.<anonymous> (test/core-controller.test.ts:220:35)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º æ±ºå®šå±¥æ­´ã‚’è¨˜éŒ²ã™ã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

      338 |
      339 |       // å±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 340 |       expect(controller['decisionHistory']).toHaveLength(1);
          |                                             ^
      341 |       expect(controller['decisionHistory'][0]).toMatchObject({
      342 |         timestamp: expect.any(Date),
      343 |         context: enrichedContext,

      at Object.<anonymous> (test/core-controller.test.ts:340:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º æ±ºå®šå±¥æ­´ç®¡ç† â€º å±¥æ­´ã®ä¸Šé™ã‚’å®ˆã‚‹

    expect(received).toHaveLength(expected)

    Expected length: 3
    Received length: 0
    Received array:  []

      383 |
      384 |       // å±¥æ­´ãŒ3ä»¶ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 385 |       expect(limitedController['decisionHistory']).toHaveLength(3);
          |                                                    ^
      386 |       // æœ€æ–°ã®3ä»¶ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      387 |       expect(limitedController['decisionHistory'][0].context.agent).toBe('agent-1');
      388 |       expect(limitedController['decisionHistory'][2].context.agent).toBe('agent-3');

      at Object.<anonymous> (test/core-controller.test.ts:385:52)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º çµ±è¨ˆæƒ…å ± â€º çµ±è¨ˆæƒ…å ±ã‚’åé›†ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 5
    + Received  + 5

      Object {
    -   "averageConfidence": closeTo<0.8375, 2>,
    +   "averageConfidence": 0,
        "averageProcessingTime": Any<Number>,
    -   "denyCount": 1,
    -   "indeterminateCount": 1,
    -   "permitCount": 2,
    -   "totalDecisions": 4,
    +   "denyCount": 0,
    +   "indeterminateCount": 0,
    +   "permitCount": 0,
    +   "totalDecisions": 0,
      }

      415 |       const stats = controller.getStatistics();
      416 |
    > 417 |       expect(stats).toMatchObject({
          |                     ^
      418 |         totalDecisions: 4,
      419 |         permitCount: 2,
      420 |         denyCount: 1,

      at Object.<anonymous> (test/core-controller.test.ts:417:21)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º æ±ºå®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      470 |       controller.clearCache();
      471 |       
    > 472 |       expect(mockJudgmentEngine.clearCache).toHaveBeenCalled();
          |                                             ^
      473 |       expect(mockLogger.info).toHaveBeenCalledWith('Decision cache cleared');
      474 |     });
      475 |

      at Object.<anonymous> (test/core-controller.test.ts:472:45)

  â— AEGISController - çµ±åˆãƒ†ã‚¹ãƒˆ â€º ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒ¡ãƒ¢ãƒªç®¡ç† â€º å‡¦ç†æ™‚é–“ã‚’æ­£ç¢ºã«æ¸¬å®šã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 150
    Received:   52

      498 |
      499 |       // å‡¦ç†æ™‚é–“ãŒé©åˆ‡ã«è¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆä½™è£•ã‚’æŒãŸã›ã¦150msä»¥ä¸Šï¼‰
    > 500 |       expect(result.processingTime).toBeGreaterThan(150);
          |                                     ^
      501 |     });
      502 |   });
      503 | });

      at Object.<anonymous> (test/core-controller.test.ts:500:37)

FAIL src/test/integration/config-integration.test.ts
  â— Configuration Integration Tests â€º Component Configuration Integration â€º should handle missing API keys gracefully in components

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "OpenAI API key not set"

    Number of calls: 0

      70 |       (config as any).validateConfig();
      71 |
    > 72 |       expect(consoleSpy).toHaveBeenCalledWith(
         |                          ^
      73 |         expect.stringContaining('OpenAI API key not set')
      74 |       );
      75 |

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:72:26)

  â— Configuration Integration Tests â€º Security Integration Tests â€º should prevent system startup with default secret in production

    [Config] Secret key must be changed in production environment

      175 |     // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæ¤œè¨¼
      176 |     if (this.config.nodeEnv === 'production' && this.config.secretKey === DEFAULT_SECRET_KEY) {
    > 177 |       throw new Error('[Config] Secret key must be changed in production environment');
          |             ^
      178 |     }
      179 |
      180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {

      at Config.validateConfig (src/utils/config.ts:177:13)
      at new Config (src/utils/config.ts:87:10)
      at Object.<anonymous> (src/test/integration/config-integration.test.ts:86:22)

  â— Configuration Integration Tests â€º Configuration Update and Reload â€º should handle configuration updates correctly

    ReferenceError: Configuration is not defined

      196 |       
      197 |       // Reset singleton to reload
    > 198 |       (Configuration as any).instance = null;
          |        ^
      199 |       config = new Config();
      200 |       
      201 |       expect(config.getConfig().logLevel).toBe('debug');

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:198:8)

  â— Configuration Integration Tests â€º Error Scenarios â€º should handle invalid port numbers gracefully

    expect(received).toBeTruthy()

    Received: false

      224 |       const port = config.getConfig().port;
      225 |       
    > 226 |       expect(isNaN(port)).toBeTruthy();
          |                           ^
      227 |     });
      228 |
      229 |     it('should handle malformed JSON in upstream servers', () => {

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:226:27)

  â— Configuration Integration Tests â€º Error Scenarios â€º should handle malformed JSON in upstream servers

    expect(received).toEqual(expected) // deep equality

    - Expected  - 1
    + Received  + 3

    - Object {}
    + Object {
    +   "{\"invalid\"": " json}",
    + }

      232 |       const config = new Config();
      233 |       // Should fallback to empty object or handle error
    > 234 |       expect(config.getConfig().mcpProxy.upstreamServers).toEqual({});
          |                                                           ^
      235 |     });
      236 |
      237 |     it('should handle invalid boolean values', () => {

      at Object.<anonymous> (src/test/integration/config-integration.test.ts:234:59)

FAIL test/ai-judgment-engine.test.ts
  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ â†’ AIåˆ¤å®šå¤‰æ› â€º é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’æ­£ã—ãåˆ¤å®šã§ãã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      72 |       const decision = await engine.judge(context, policy);
      73 |
    > 74 |       expect(decision.decision).toBe('PERMIT');
         |                                 ^
      75 |       expect(decision.confidence).toBe(0.95);
      76 |       expect(decision.constraints).toContain('å€‹äººæƒ…å ±ã®åŒ¿ååŒ–');
      77 |       expect(decision.obligations).toContain('ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²');

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:74:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º è‡ªç„¶è¨€èªãƒãƒªã‚·ãƒ¼ â†’ AIåˆ¤å®šå¤‰æ› â€º å–¶æ¥­æ™‚é–“å¤–ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦ã•ã‚Œã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

       97 |
       98 |       const decision = await engine.judge(context);
    >  99 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      100 |       expect(decision.reason).toContain('å–¶æ¥­æ™‚é–“å¤–');
      101 |     });
      102 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:99:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š â€º ç·Šæ€¥æ™‚ã¯å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      123 |
      124 |       const decision = await engine.judge(context);
    > 125 |       expect(decision.decision).toBe('PERMIT');
          |                                 ^
      126 |       expect(decision.obligations).toContain('ä¸Šé•·ã¸ã®é€šçŸ¥');
      127 |     });
      128 |

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:125:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š â€º å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ã¯æ‹’å¦

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

      146 |
      147 |       const decision = await engine.judge(context);
    > 148 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      149 |       expect(decision.confidence).toBeGreaterThan(0.9);
      150 |     });
      151 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:148:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒƒãƒå‡¦ç† â€º è¤‡æ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã§ãã‚‹

    TypeError: engine.judgeBatch is not a function

      187 |       ]);
      188 |
    > 189 |       const decisions = await engine.judgeBatch(contexts);
          |                                      ^
      190 |       
      191 |       expect(decisions).toHaveLength(2);
      192 |       expect(decisions[0].decision).toBe('PERMIT');

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:189:38)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º LLMã‚¨ãƒ©ãƒ¼æ™‚ã¯å®‰å…¨å´ï¼ˆDENYï¼‰ã«å€’ã™

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

      210 |       const decision = await engine.judge(context);
      211 |       
    > 212 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      213 |       expect(decision.reason).toContain('ã‚¨ãƒ©ãƒ¼');
      214 |       expect(decision.confidence).toBe(0);
      215 |     });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:212:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° â€º ä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã‚‚å‡¦ç†ã‚’ç¶™ç¶š

    expect(received).toBe(expected) // Object.is equality

    Expected: "DENY"
    Received: "INDETERMINATE"

      231 |       const decision = await engine.judge(context);
      232 |       
    > 233 |       expect(decision.decision).toBe('DENY');
          |                                 ^
      234 |       expect(decision.reason).toContain('å½¢å¼ã‚¨ãƒ©ãƒ¼');
      235 |     });
      236 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:233:33)

  â— AIJudgmentEngine - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º åˆ¤å®šä¿¡é ¼åº¦ã®å‡¦ç† â€º ä½ä¿¡é ¼åº¦ã®åˆ¤å®šã¯ç†ç”±ã«å«ã‚ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: 0.4
    Received: 0

      256 |       const decision = await engine.judge(context);
      257 |       
    > 258 |       expect(decision.confidence).toBe(0.4);
          |                                   ^
      259 |       expect(decision.reason).toContain('ä¿¡é ¼åº¦: 40%');
      260 |     });
      261 |   });

      at Object.<anonymous> (test/ai-judgment-engine.test.ts:258:35)

FAIL src/test/mcp-stdio-proxy-extended.test.ts (6.785 s)
  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ãƒ­ãƒ¼ãƒ€ãƒ¼æ©Ÿèƒ½ â€º ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒªã‚·ãƒ¼ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ã™ã‚‹

    TypeError: this.stdioRouter.on is not a function

      1529 |   private setupNotificationHandling(): void {
      1530 |     // StdioRouterã‹ã‚‰ã®upstreamNotificationã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
    > 1531 |     this.stdioRouter.on('upstreamNotification', (event: {
           |                      ^
      1532 |       serverName: string;
      1533 |       notificationMethod: string;
      1534 |       notificationParams: any;

      at MCPStdioPolicyProxy.setupNotificationHandling (src/mcp/stdio-proxy.ts:1531:22)
      at MCPStdioPolicyProxy.start (src/mcp/stdio-proxy.ts:1513:10)
      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:211:7)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç•°å¸¸æ¤œçŸ¥ â€º ãƒãƒªã‚·ãƒ¼åˆ¤å®šå¾Œã«ç•°å¸¸æ¤œçŸ¥ã‚’å®Ÿè¡Œã™ã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      267 |       await enforcePolicy('read', 'test://resource', {});
      268 |       
    > 269 |       expect(mockAnomalyDetector.detectRealTimeAnomalies).toHaveBeenCalled();
          |                                                           ^
      270 |       expect(mockLogger.info).toHaveBeenCalledWith(
      271 |         expect.stringContaining('Detected 1 real-time anomalies'),
      272 |         expect.any(Object)

      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:269:59)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ  â€º æ–°ã—ã„åˆ¤å®šçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      329 |       await enforcePolicy('read', 'test://resource', {});
      330 |       
    > 331 |       expect(mockCacheSystem.set).toHaveBeenCalled();
          |                                   ^
      332 |     });
      333 |
      334 |     it('ã‚­ãƒ£ãƒƒã‚·ãƒ¥çµ±è¨ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹', () => {

      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:331:35)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼æ©Ÿèƒ½ â€º æˆåŠŸæ™‚ã«ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: 0
    Received: undefined

      438 |       
      439 |       const stats = proxy.getCircuitBreakerStats();
    > 440 |       expect(stats['test-method']?.failures).toBe(0);
          |                                              ^
      441 |     });
      442 |
      443 |     it('ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“å¾Œã«ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹', async () => {

      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:440:46)

  â— MCPStdioPolicyProxy - æ‹¡å¼µæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° â€º èµ·å‹•æ™‚ã«ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã‚’é–‹å§‹ã™ã‚‹

    Configuration error:

    Could not locate module ./http-proxy.js mapped as:
    $1.

    Please check your configuration for these entries:
    {
      "moduleNameMapper": {
        "/^(\.{1,2}\/.*)\.js$/": "$1"
      },
      "resolver": undefined
    }

      637 |       };
      638 |       
    > 639 |       jest.doMock('./http-proxy.js', () => ({
          |            ^
      640 |         MCPHttpPolicyProxy: jest.fn().mockImplementation(() => mockHttpProxy)
      641 |       }));
      642 |       

      at createNoMappedModuleFoundError (node_modules/jest-resolve/build/resolver.js:759:17)
      at Object.<anonymous> (src/test/mcp-stdio-proxy-extended.test.ts:639:12)

FAIL src/test/error-handling/edge-cases-and-boundaries.test.ts
  â— Edge Cases and Boundary Value Tests â€º Input Validation Edge Cases â€º should handle extremely long policy names

    expect(received).resolves.toBeDefined()

    Received promise rejected instead of resolved
    Rejected to value: [TypeError: this.contextCollector.enrichContext is not a function]

      54 |
      55 |       // Should truncate or handle gracefully
    > 56 |       await expect(
         |             ^
      57 |         enforcer.enforcePolicy('read', 'test', context, {
      58 |           selectPolicy: async () => ({ id: '1', name: veryLongPolicyName, content: 'test' })
      59 |         } as any)

      at expect (node_modules/expect/build/index.js:113:15)
      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:56:13)

  â— Edge Cases and Boundary Value Tests â€º Input Validation Edge Cases â€º should handle unicode and special characters in inputs

    expect(received).toBeDefined()

    Received: undefined

       96 |         // Should handle without crashing
       97 |         expect(result).toBeDefined();
    >  98 |         expect(result.data).toBeDefined();
          |                             ^
       99 |       }
      100 |     });
      101 |

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:98:29)

  â— Edge Cases and Boundary Value Tests â€º Input Validation Edge Cases â€º should handle empty and whitespace-only inputs

    TypeError: dynamic_tool_discovery_1.DynamicToolDiscovery is not a constructor

      110 |       ];
      111 |
    > 112 |       const discovery = new DynamicToolDiscovery(mockLogger);
          |                         ^
      113 |
      114 |       for (const input of emptyInputs) {
      115 |         // Should handle empty tool names gracefully

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:112:25)

  â— Edge Cases and Boundary Value Tests â€º Numeric Boundary Values â€º should handle rate limiter at boundaries

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

      146 |       for (let i = 0; i < 3; i++) {
      147 |         const result = await rateLimiter.apply('rate-limit:3/100ms', {}, context);
    > 148 |         expect(result.rateLimited).toBe(false);
          |                                    ^
      149 |       }
      150 |
      151 |       // Just over limit

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:148:36)

  â— Edge Cases and Boundary Value Tests â€º Numeric Boundary Values â€º should handle cache size limits

    TypeError: cache.metrics is not a function

      186 |       }
      187 |
    > 188 |       const stats1 = await cache.metrics();
          |                                  ^
      189 |       expect(stats1.size).toBe(3);
      190 |       expect(stats1.evictions).toBe(0);
      191 |

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:188:34)

  â— Edge Cases and Boundary Value Tests â€º Date and Time Edge Cases â€º should handle various date formats and edge cases

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      285 |             { decision: 'PERMIT', reason: 'Test', confidence: 0.9 }
      286 |           );
    > 287 |           expect(result.logged).toBe(true);
          |                                 ^
      288 |         }
      289 |       }
      290 |     });

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:287:33)

  â— Edge Cases and Boundary Value Tests â€º Concurrency Edge Cases â€º should handle exactly simultaneous requests

    expect(received).toMatch(expected)

    Matcher error: received value must be a string

    Received has value: undefined

      412 |       const result = await cache.get(context, 'policy', {});
      413 |       expect(result).toBeDefined();
    > 414 |       expect(result?.reason).toMatch(/Decision \d/);
          |                              ^
      415 |     });
      416 |
      417 |     it('should handle rapid policy updates without corruption', async () => {

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:414:30)

  â— Edge Cases and Boundary Value Tests â€º Memory and Buffer Edge Cases â€º should handle buffer overflow scenarios

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "Large buffer allocation", ObjectContaining {"size": 16777216}

    Number of calls: 0

      560 |         
      561 |         if (size > 10 * 1024 * 1024) {
    > 562 |           expect(mockLogger.warn).toHaveBeenCalledWith(
          |                                   ^
      563 |             expect.stringContaining('Large buffer allocation'),
      564 |             expect.objectContaining({ size })
      565 |           );

      at Object.<anonymous> (src/test/error-handling/edge-cases-and-boundaries.test.ts:562:35)

FAIL src/test/policy-management.test.ts
  â— PolicyAdministrator - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒãƒªã‚·ãƒ¼CRUDæ“ä½œ â€º æ–°ã—ã„ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "test-policies/policy-", StringContaining "Customer Data Access Policy", {"encoding": "utf-8"}
    Received
           1: "test-policies/policy-8e08e743-e509-4b10-88b3-0fb5bba08042.json", "{
      \"name\": \"Customer Data Access Policy\",
      \"description\": \"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãƒãƒªã‚·ãƒ¼\",
      \"policy\": \"\\n        é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š\\n        \\n        ã€åŸºæœ¬åŸå‰‡ã€‘\\n        - é¡§å®¢ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½\\n        - å–¶æ¥­æ™‚é–“å†…ã®ã¿è¨±å¯\\n        - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°å¿…é ˆ\\n        \\n        ã€åˆ¶é™äº‹é …ã€‘\\n        - å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢\\n        - ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨å…±æœ‰ã¯ä¸€åˆ‡ç¦æ­¢\\n        - å€‹äººæƒ…å ±ã®é•·æœŸä¿å­˜ç¦æ­¢\\n      \",
      \"examples\": [],
      \"metadata\": {
        \"id\": \"policy-8e08e743-e509-4b10-88b3-0fb5bba08042\",
        \"name\": \"Customer Data Access Policy\",
        \"description\": \"é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãƒãƒªã‚·ãƒ¼\",
        \"version\": \"1.0.0\",
        \"createdAt\": \"2026-02-13T00:27:00.237Z\",
        \"createdBy\": \"admin\",
        \"lastModified\": \"2026-02-13T00:27:00.237Z\",
        \"lastModifiedBy\": \"admin\",
        \"tags\": [
          \"customer\",
          \"data-access\"
        ],
        \"status\": \"active\"
      }
    }"
           2: "test-policies/history/policy-8e08e743-e509-4b10-88b3-0fb5bba08042.json", "[
      {
        \"version\": \"1.0.0\",
        \"policy\": \"\\n        é¡§å®¢ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ï¼š\\n        \\n        ã€åŸºæœ¬åŸå‰‡ã€‘\\n        - é¡§å®¢ã‚µãƒãƒ¼ãƒˆæ‹…å½“è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½\\n        - å–¶æ¥­æ™‚é–“å†…ã®ã¿è¨±å¯\\n        - ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°å¿…é ˆ\\n        \\n        ã€åˆ¶é™äº‹é …ã€‘\\n        - å¤–éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢\\n        - ãƒ‡ãƒ¼ã‚¿ã®å¤–éƒ¨å…±æœ‰ã¯ä¸€åˆ‡ç¦æ­¢\\n        - å€‹äººæƒ…å ±ã®é•·æœŸä¿å­˜ç¦æ­¢\\n      \",
        \"createdAt\": \"2026-02-13T00:27:00.237Z\",
        \"createdBy\": \"admin\",
        \"changeLog\": \"Initial version\"
      }
    ]"

    Number of calls: 2

      52 |
      53 |       expect(policyId).toMatch(/^policy-[a-f0-9-]+$/);
    > 54 |       expect(fs.writeFile).toHaveBeenCalledWith(
         |                            ^
      55 |         expect.stringContaining('test-policies/policy-'),
      56 |         expect.stringContaining('Customer Data Access Policy'),
      57 |         { encoding: 'utf-8' }

      at Object.<anonymous> (src/test/policy-management.test.ts:54:28)

  â— PolicyAdministrator - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â€º ãƒãƒªã‚·ãƒ¼ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "exports", Any<String>, Any<String>
    Received
           1: "test-policies/policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58.json", "{
      \"name\": \"Export Test\",
      \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
      \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
      \"examples\": [],
      \"metadata\": {
        \"id\": \"policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58\",
        \"name\": \"Export Test\",
        \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
        \"version\": \"1.0.0\",
        \"createdAt\": \"2026-02-13T00:27:00.366Z\",
        \"createdBy\": \"system\",
        \"lastModified\": \"2026-02-13T00:27:00.366Z\",
        \"lastModifiedBy\": \"system\",
        \"tags\": [
          \"test\",
          \"export\"
        ],
        \"status\": \"active\"
      }
    }"
           2: "test-policies/history/policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58.json", "[
      {
        \"version\": \"1.0.0\",
        \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
        \"createdAt\": \"2026-02-13T00:27:00.366Z\",
        \"createdBy\": \"system\",
        \"changeLog\": \"Initial version\"
      }
    ]"
           3: "test-policies/exports/policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58-export-1770942420366.json", "{
      \"version\": \"1.0\",
      \"exportedAt\": \"2026-02-13T00:27:00.366Z\",
      \"exportedBy\": \"system\",
      \"policy\": {
        \"name\": \"Export Test\",
        \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
        \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
        \"examples\": [],
        \"metadata\": {
          \"id\": \"policy-f2e8b27b-16c8-43a8-9951-d1a7a3d21b58\",
          \"name\": \"Export Test\",
          \"description\": \"ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ\",
          \"version\": \"1.0.0\",
          \"createdAt\": \"2026-02-13T00:27:00.366Z\",
          \"createdBy\": \"system\",
          \"lastModified\": \"2026-02-13T00:27:00.366Z\",
          \"lastModifiedBy\": \"system\",
          \"tags\": [
            \"test\",
            \"export\"
          ],
          \"status\": \"active\"
        }
      },
      \"history\": [
        {
          \"version\": \"1.0.0\",
          \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\nã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
          \"createdAt\": \"2026-02-13T00:27:00.366Z\",
          \"createdBy\": \"system\",
          \"changeLog\": \"Initial version\"
        }
      ]
    }"

    Number of calls: 3

      267 |       });
      268 |
    > 269 |       expect(fs.writeFile).toHaveBeenCalledWith(
          |                            ^
      270 |         expect.stringContaining('exports'),
      271 |         expect.any(String),
      272 |         expect.any(String)

      at Object.<anonymous> (src/test/policy-management.test.ts:269:28)

  â— PolicyAdministrator - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ°¸ç¶šåŒ– â€º ãƒãƒªã‚·ãƒ¼ä½œæˆæ™‚ã«ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿å­˜ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "test-policies/policy-", StringContaining "Persist Test", Any<String>
    Received
           1: "test-policies/policy-9012dd5c-5d53-417e-836f-0f42b8bc5741.json", "{
      \"name\": \"Persist Test\",
      \"description\": \"Policy for Persist Test\",
      \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\næ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
      \"examples\": [],
      \"metadata\": {
        \"id\": \"policy-9012dd5c-5d53-417e-836f-0f42b8bc5741\",
        \"name\": \"Persist Test\",
        \"description\": \"Policy for Persist Test\",
        \"version\": \"1.0.0\",
        \"createdAt\": \"2026-02-13T00:27:00.492Z\",
        \"createdBy\": \"system\",
        \"lastModified\": \"2026-02-13T00:27:00.492Z\",
        \"lastModifiedBy\": \"system\",
        \"tags\": [],
        \"status\": \"active\"
      }
    }"
           2: "test-policies/history/policy-9012dd5c-5d53-417e-836f-0f42b8bc5741.json", "[
      {
        \"version\": \"1.0.0\",
        \"policy\": \"ã€åŸºæœ¬åŸå‰‡ã€‘\\næ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ\\nã€åˆ¶é™äº‹é …ã€‘\\nãªã—\",
        \"createdAt\": \"2026-02-13T00:27:00.492Z\",
        \"createdBy\": \"system\",
        \"changeLog\": \"Initial version\"
      }
    ]"

    Number of calls: 2

      407 |       );
      408 |
    > 409 |       expect(fs.writeFile).toHaveBeenCalledWith(
          |                            ^
      410 |         expect.stringContaining('test-policies/policy-'),
      411 |         expect.stringContaining('Persist Test'),
      412 |         expect.any(String)

      at Object.<anonymous> (src/test/policy-management.test.ts:409:28)

FAIL src/test/integration/full-mcp-flow.test.ts
  â— Full MCP Request Flow Integration â€º End-to-End Request Scenarios â€º should handle complete tool discovery and execution flow

    TypeError: policyAdmin.getAuditTrail is not a function

      206 |
      207 |       // Verify audit trail
    > 208 |       const auditEntries = await policyAdmin.getAuditTrail();
          |                                              ^
      209 |       expect(auditEntries).toContainEqual(expect.objectContaining({
      210 |         action: 'tools/call',
      211 |         resource: 'execute-command',

      at Object.<anonymous> (src/test/integration/full-mcp-flow.test.ts:208:46)

FAIL src/test/core/obligations/manager.test.ts
  â— ObligationExecutorManager â€º execution history and stats â€º should calculate execution statistics

    expect(received).toBe(expected) // Object.is equality

    Expected: 4
    Received: 3

      371 |       const stats = manager.getExecutionStats();
      372 |       
    > 373 |       expect(stats.totalExecutions).toBe(4); // 3 success + 1 fail
          |                                     ^
      374 |       expect(stats.successCount).toBe(3);
      375 |       expect(stats.failureCount).toBe(1);
      376 |       expect(stats.averageDuration).toBeGreaterThan(0);

      at Object.<anonymous> (src/test/core/obligations/manager.test.ts:373:37)

FAIL src/test/security/config-security.test.ts
  â— Configuration Security Tests â€º Secret Key Security â€º should reject weak secret keys in production

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should reject weak secret keys in production

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should enforce minimum secret key length

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should enforce minimum secret key length

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should generate cryptographically secure defaults in development

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Secret Key Security â€º should generate cryptographically secure defaults in development

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º API Key Security â€º should never expose API keys in error messages

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º API Key Security â€º should never expose API keys in error messages

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º API Key Security â€º should validate API key format

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º API Key Security â€º should validate API key format

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º API Key Security â€º should mask API keys in toString representations

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º API Key Security â€º should mask API keys in toString representations

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º JWT Security â€º should enforce strong JWT secrets

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º JWT Security â€º should enforce strong JWT secrets

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º JWT Security â€º should use different secrets for JWT and encryption

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º JWT Security â€º should use different secrets for JWT and encryption

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should only allow secure encryption algorithms

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should only allow secure encryption algorithms

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should validate encryption key derivation settings

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Encryption Configuration Security â€º should validate encryption key derivation settings

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º CORS Security â€º should validate CORS origins

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º CORS Security â€º should validate CORS origins

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º CORS Security â€º should only allow HTTPS origins in production

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º CORS Security â€º should only allow HTTPS origins in production

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should enforce encryption for audit logs

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should enforce encryption for audit logs

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should validate audit log retention policies

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Audit Log Security â€º should validate audit log retention policies

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should not expose services on all interfaces by default

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should not expose services on all interfaces by default

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should validate upstream server URLs

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Network Security Configuration â€º should validate upstream server URLs

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should not log environment variables

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should not log environment variables

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should sanitize configuration output

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Environment Variable Security â€º should sanitize configuration output

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should prevent prototype pollution

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should prevent prototype pollution

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should validate numeric inputs to prevent injection

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Configuration Injection Prevention â€º should validate numeric inputs to prevent injection

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Security Headers and Settings â€º should enforce secure defaults

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Security Headers and Settings â€º should enforce secure defaults

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should support compliance configuration

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should support compliance configuration

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should validate data retention policies

    ReferenceError: Configuration is not defined

      12 |       }
      13 |     });
    > 14 |     (Configuration as any).instance = null;
         |      ^
      15 |   });
      16 |
      17 |   afterEach(() => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:14:6)

  â— Configuration Security Tests â€º Compliance and Regulatory â€º should validate data retention policies

    ReferenceError: Configuration is not defined

      17 |   afterEach(() => {
      18 |     process.env = originalEnv;
    > 19 |     (Configuration as any).instance = null;
         |      ^
      20 |   });
      21 |
      22 |   describe('Secret Key Security', () => {

      at Object.<anonymous> (src/test/security/config-security.test.ts:19:6)

FAIL test/dynamic-tool-discovery.test.ts
  â— DynamicToolDiscoveryService â€º åˆæœŸåŒ– â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      55 |     it('æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹', () => {
      56 |       expect(service).toBeDefined();
    > 57 |       expect(Logger).toHaveBeenCalled();
         |                      ^
      58 |     });
      59 |
      60 |     it('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–“éš”ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å®šæœŸå®Ÿè¡Œã‚’è¨­å®šã™ã‚‹', () => {

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:57:22)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º é«˜ãƒªã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 8
    Received number of calls: 4

      252 |
      253 |       // å„ãƒ„ãƒ¼ãƒ«ãŒé«˜ãƒªã‚¹ã‚¯ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 254 |       expect(mockLogger.info).toHaveBeenCalledTimes(highRiskTools.length * 2); // ç™ºè¦‹ãƒ­ã‚° + ç™»éŒ²ãƒ­ã‚°
          |                               ^
      255 |       
      256 |       highRiskTools.forEach(tool => {
      257 |         expect(mockLogger.info).toHaveBeenCalledWith(

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:254:31)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’é©ç”¨ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "custom_high_risk", "risk": "high"}
    Received
           1: "Registered dynamic tool", {"category": "general", "name": "custom_high_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "general", "name": "custom_low_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}

    Number of calls: 2

      321 |
      322 |       // execãƒ‘ã‚¿ãƒ¼ãƒ³ãŒhighRiskPatternsã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚
    > 323 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      324 |         'Registered dynamic tool',
      325 |         expect.objectContaining({
      326 |           name: 'custom_high_risk',

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:323:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "trusted-tool", "policyEnforced": false, "source": "official-mcp-server"}
    Received: "Registered dynamic tool", {"category": "general", "name": "trusted-tool", "policyEnforced": true, "risk": "medium", "source": "official-mcp-server"}

    Number of calls: 1

      369 |       );
      370 |
    > 371 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      372 |         'Registered dynamic tool',
      373 |         expect.objectContaining({
      374 |           name: 'trusted-tool',

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:371:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º smartãƒ¢ãƒ¼ãƒ‰ã§ä½ãƒªã‚¹ã‚¯ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "read_data", "policyEnforced": false, "risk": "low"}
    Received: "Registered dynamic tool", {"category": "data", "name": "read_data", "policyEnforced": true, "risk": "low", "source": "unknown-source"}

    Number of calls: 1

      445 |       await service.discoverToolsFromListResponse({ tools: [tool] }, 'unknown-source');
      446 |
    > 447 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      448 |         'Registered dynamic tool',
      449 |         expect.objectContaining({
      450 |           name: 'read_data',

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:447:31)

  â— DynamicToolDiscoveryService â€º ãƒ„ãƒ¼ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ â€º è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’åŒã˜ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"category": "file-management", "name": "read_file"}
    Received
           1: "Registered dynamic tool", {"category": "filesystem", "name": "read_file", "policyEnforced": true, "risk": "low", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "filesystem", "name": "write_file", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           3: "Registered dynamic tool", {"category": "filesystem", "name": "delete_file", "policyEnforced": true, "risk": "high", "source": "test-source"}

    Number of calls: 3

      490 |       // ã™ã¹ã¦ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…
      491 |       fileTools.forEach(tool => {
    > 492 |         expect(mockLogger.info).toHaveBeenCalledWith(
          |                                 ^
      493 |           'Registered dynamic tool',
      494 |           expect.objectContaining({
      495 |             name: tool.name,

      at test/dynamic-tool-discovery.test.ts:492:33
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:491:17)

  â— DynamicToolDiscoveryService â€º ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ â€º ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒ„ãƒ¼ãƒ«ã‚’å–å¾—ã§ãã‚‹

    expect(received).toBeGreaterThanOrEqual(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      601 |
      602 |       const fileTools = getToolsByCategory('file-management');
    > 603 |       expect(fileTools?.size).toBeGreaterThanOrEqual(2);
          |                               ^
      604 |       
      605 |       const execTools = getToolsByCategory('execution');
      606 |       expect(execTools?.has('exec_command')).toBe(true);

      at Object.<anonymous> (test/dynamic-tool-discovery.test.ts:603:31)

FAIL src/test/mcp/tool-discovery.test.ts
  â— ToolDiscoveryService â€º Native Tools Registration â€º should register all native tools on initialization

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      47 |       
      48 |       // Check some native tools are registered
    > 49 |       expect(tools.some(t => t.name === 'Agent')).toBe(true);
         |                                                   ^
      50 |       expect(tools.some(t => t.name === 'Bash')).toBe(true);
      51 |       expect(tools.some(t => t.name === 'Edit')).toBe(true);
      52 |       

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:49:51)

  â— ToolDiscoveryService â€º Native Tools Registration â€º should apply policy control based on risk level

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      91 |       const read = service.getTool('Read');
      92 |       
    > 93 |       expect(agent?.source.policyControlled).toBe(true); // High risk
         |                                              ^
      94 |       expect(read?.source.policyControlled).toBe(true); // Low risk but not in exceptions
      95 |     });
      96 |

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:93:46)

  â— ToolDiscoveryService â€º Native Tools Registration â€º should respect exceptions list

    expect(received).toBe(expected) // Object.is equality

    Expected: false
    Received: undefined

       99 |       const ls = service.getTool('LS');
      100 |       
    > 101 |       expect(todoRead?.source.policyControlled).toBe(false);
          |                                                 ^
      102 |       expect(ls?.source.policyControlled).toBe(false);
      103 |     });
      104 |   });

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:101:49)

  â— ToolDiscoveryService â€º Policy Control â€º should force policy control for high-risk tools

    expect(received).toBe(expected) // Object.is equality

    Expected: "high"
    Received: "medium"

      254 |       // For test, we'll use the risk assessment method
      255 |       const bashRisk = serviceHighRisk.assessToolRisk('Bash');
    > 256 |       expect(bashRisk).toBe('high');
          |                        ^
      257 |     });
      258 |   });
      259 |

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:256:24)

  â— ToolDiscoveryService â€º Tool Risk Assessment â€º should assess risk based on tool metadata

    expect(received).toBe(expected) // Object.is equality

    Expected: "high"
    Received: "medium"

      261 |     it('should assess risk based on tool metadata', () => {
      262 |       // Native tools have risk metadata
    > 263 |       expect(service.assessToolRisk('Agent')).toBe('high');
          |                                               ^
      264 |       expect(service.assessToolRisk('Edit')).toBe('medium');
      265 |       expect(service.assessToolRisk('Read')).toBe('low');
      266 |     });

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:263:47)

  â— ToolDiscoveryService â€º Tool Queries â€º should get policy-controlled tools only

    expect(received).toBeDefined()

    Received: undefined

      307 |       // Should include high-risk tools
      308 |       const agent = controlledTools.find(t => t.name === 'Agent');
    > 309 |       expect(agent).toBeDefined();
          |                     ^
      310 |     });
      311 |
      312 |     it('should get specific tool by name', () => {

      at Object.<anonymous> (src/test/mcp/tool-discovery.test.ts:309:21)

FAIL src/test/dynamic-tool-discovery.test.ts
  â— DynamicToolDiscoveryService â€º åˆæœŸåŒ– â€º æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      55 |     it('æ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã‚‹', () => {
      56 |       expect(service).toBeDefined();
    > 57 |       expect(Logger).toHaveBeenCalled();
         |                      ^
      58 |     });
      59 |
      60 |     it('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é–“éš”ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€å®šæœŸå®Ÿè¡Œã‚’è¨­å®šã™ã‚‹', () => {

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:57:22)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º é«˜ãƒªã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ­£ã—ãæ¤œå‡ºã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 8
    Received number of calls: 4

      252 |
      253 |       // å„ãƒ„ãƒ¼ãƒ«ãŒé«˜ãƒªã‚¹ã‚¯ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    > 254 |       expect(mockLogger.info).toHaveBeenCalledTimes(highRiskTools.length * 2); // ç™ºè¦‹ãƒ­ã‚° + ç™»éŒ²ãƒ­ã‚°
          |                               ^
      255 |       
      256 |       highRiskTools.forEach(tool => {
      257 |         expect(mockLogger.info).toHaveBeenCalledWith(

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:254:31)

  â— DynamicToolDiscoveryService â€º ãƒªã‚¹ã‚¯è©•ä¾¡ â€º ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è©•ä¾¡ã‚’é©ç”¨ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "custom_high_risk", "risk": "high"}
    Received
           1: "Registered dynamic tool", {"category": "general", "name": "custom_high_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "general", "name": "custom_low_risk", "policyEnforced": true, "risk": "medium", "source": "test-source"}

    Number of calls: 2

      321 |
      322 |       // execãƒ‘ã‚¿ãƒ¼ãƒ³ãŒhighRiskPatternsã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚
    > 323 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      324 |         'Registered dynamic tool',
      325 |         expect.objectContaining({
      326 |           name: 'custom_high_risk',

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:323:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º ä¿¡é ¼ã§ãã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã®ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "trusted-tool", "policyEnforced": false, "source": "official-mcp-server"}
    Received: "Registered dynamic tool", {"category": "general", "name": "trusted-tool", "policyEnforced": true, "risk": "medium", "source": "official-mcp-server"}

    Number of calls: 1

      369 |       );
      370 |
    > 371 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      372 |         'Registered dynamic tool',
      373 |         expect.objectContaining({
      374 |           name: 'trusted-tool',

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:371:31)

  â— DynamicToolDiscoveryService â€º ãƒãƒªã‚·ãƒ¼è¨­å®šã®æ±ºå®š â€º smartãƒ¢ãƒ¼ãƒ‰ã§ä½ãƒªã‚¹ã‚¯ãƒ„ãƒ¼ãƒ«ã¯è¨±å¯ã•ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"name": "read_data", "policyEnforced": false, "risk": "low"}
    Received: "Registered dynamic tool", {"category": "data", "name": "read_data", "policyEnforced": true, "risk": "low", "source": "unknown-source"}

    Number of calls: 1

      445 |       await service.discoverToolsFromListResponse({ tools: [tool] }, 'unknown-source');
      446 |
    > 447 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      448 |         'Registered dynamic tool',
      449 |         expect.objectContaining({
      450 |           name: 'read_data',

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:447:31)

  â— DynamicToolDiscoveryService â€º ãƒ„ãƒ¼ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªåˆ†é¡ â€º è¤‡æ•°ã®ãƒ„ãƒ¼ãƒ«ã‚’åŒã˜ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Registered dynamic tool", ObjectContaining {"category": "file-management", "name": "read_file"}
    Received
           1: "Registered dynamic tool", {"category": "filesystem", "name": "read_file", "policyEnforced": true, "risk": "low", "source": "test-source"}
           2: "Registered dynamic tool", {"category": "filesystem", "name": "write_file", "policyEnforced": true, "risk": "medium", "source": "test-source"}
           3: "Registered dynamic tool", {"category": "filesystem", "name": "delete_file", "policyEnforced": true, "risk": "high", "source": "test-source"}

    Number of calls: 3

      490 |       // ã™ã¹ã¦ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…
      491 |       fileTools.forEach(tool => {
    > 492 |         expect(mockLogger.info).toHaveBeenCalledWith(
          |                                 ^
      493 |           'Registered dynamic tool',
      494 |           expect.objectContaining({
      495 |             name: tool.name,

      at src/test/dynamic-tool-discovery.test.ts:492:33
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:491:17)

  â— DynamicToolDiscoveryService â€º ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ â€º ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ãƒ„ãƒ¼ãƒ«ã‚’å–å¾—ã§ãã‚‹

    expect(received).toBeGreaterThanOrEqual(expected)

    Matcher error: received value must be a number or bigint

    Received has value: undefined

      601 |
      602 |       const fileTools = getToolsByCategory('file-management');
    > 603 |       expect(fileTools?.size).toBeGreaterThanOrEqual(2);
          |                               ^
      604 |       
      605 |       const execTools = getToolsByCategory('execution');
      606 |       expect(execTools?.has('exec_command')).toBe(true);

      at Object.<anonymous> (src/test/dynamic-tool-discovery.test.ts:603:31)

FAIL test/context-enrichers.test.ts
  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º ãƒªã‚½ãƒ¼ã‚¹ã®æ©Ÿå¯†åº¦ã‚’åˆ†é¡ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 4
    + Received  + 4

      Object {
    -   "dataType": "customer-data",
    +   "dataType": "unclassified",
        "sensitivityLevel": "high",
    -   "tags": ArrayContaining [
    -     "pii",
    -     "regulated",
    +   "tags": Array [
    +     "unclassified",
    +     "review-required",
        ],
      }

      319 |         const enriched = await classifier.enrich(context);
      320 |
    > 321 |         expect(enriched['resource-classifier']).toMatchObject({
          |                                                 ^
      322 |           dataType: testCase.expectedType,
      323 |           sensitivityLevel: testCase.expectedSensitivity,
      324 |           tags: expect.arrayContaining(testCase.expectedTags)

      at Object.<anonymous> (test/context-enrichers.test.ts:321:49)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º å€‹äººæƒ…å ±ã‚’å«ã‚€ãƒªã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥ã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      346 |         const enriched = await classifier.enrich(context);
      347 |
    > 348 |         expect(enriched['resource-classifier'].isPii).toBe(true);
          |                                                       ^
      349 |         expect(enriched['resource-classifier'].tags).toContain('pii');
      350 |       }
      351 |     });

      at Object.<anonymous> (test/context-enrichers.test.ts:348:55)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º SecurityInfoEnricher â€º ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      521 |       
      522 |       // ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 523 |       expect(enriched['security-info'].unusualActivity.length).toBeGreaterThan(0);
          |                                                                ^
      524 |     });
      525 |   });
      526 |

      at Object.<anonymous> (test/context-enrichers.test.ts:523:64)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ContextCollectorçµ±åˆãƒ†ã‚¹ãƒˆ â€º å…¨ã¦ã®enricherãŒå”èª¿ã—ã¦å‹•ä½œã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  -  12
    + Received  + 123

    @@ -1,28 +1,139 @@
      Object {
        "action": "read",
        "agent": "customer-support-agent",
    -   "environment": ObjectContaining {
    -     "enrichments": ObjectContaining {
    -       "agent-info": ObjectContaining {
    -         "agentType": Any<String>,
    -         "clearanceLevel": Any<Number>,
    -         "department": Any<String>,
    +   "environment": Object {
    +     "clientIP": "192.168.1.100",
    +     "enrichmentTime": 1,
    +     "enrichments": Object {
    +       "agent-info": Object {
    +         "activityStatus": "active-today",
    +         "ageDays": 760,
    +         "agentId": "customer-support-agent",
    +         "agentType": "support",
    +         "clearanceLevel": 2,
    +         "clearanceName": "standard",
    +         "createdAt": "2024-01-15T00:00:00.000Z",
    +         "department": "customer-service",
    +         "hasAdminPrivileges": false,
    +         "hasHighClearance": false,
    +         "inactiveDays": 0,
    +         "isExternal": false,
    +         "isInactive": false,
    +         "isNewAgent": false,
    +         "lastActivity": "2026-02-13T00:27:01.243Z",
    +         "location": "tokyo-office",
    +         "permissions": Array [
    +           "read-customer-data",
    +           "create-tickets",
    +         ],
    +         "requiresSupervision": false,
    +         "riskScore": 0.2,
    +         "supervisor": "support-manager",
    +         "tags": Array [
    +           "production",
    +           "verified",
    +         ],
    +         "trustScore": 1,
    +       },
    +       "resource-classifier": Object {
    +         "accessFrequency": Object {
    +           "daily": 92,
    +           "monthly": 992,
    +           "trend": "stable",
    +           "weekly": 223,
    +         },
    +         "dataAge": "current",
    +         "dataController": "data-governance-team",
    +         "dataType": "unclassified",
    +         "department": "unknown",
    +         "isFinancial": false,
    +         "isPhi": false,
    +         "isPii": false,
    +         "isPublic": false,
    +         "isRegulated": false,
    +         "lineage": Object {
    +           "dependencies": Array [],
    +           "lastModified": "2026-02-13T00:27:01.276Z",
    +           "source": "original-system",
    +           "transformations": Array [
    +             "anonymized",
    +             "aggregated",
    +           ],
    +           "version": "1.0",
              },
    -       "resource-classifier": ObjectContaining {
    -         "dataType": "customer-data",
    -         "isPii": true,
    +         "owner": "unknown",
    +         "requiresAudit": false,
    +         "requiresEncryption": true,
    +         "resourceHost": "profile",
    +         "resourcePath": "/12345",
    +         "resourceScheme": "customer",
    +         "resourceUri": "customer://profile/12345",
    +         "retentionDays": 90,
              "sensitivityLevel": "high",
    +         "sensitivityScore": 0.8,
    +         "tags": Array [
    +           "unclassified",
    +           "review-required",
    +         ],
            },
    -       "security-info": ObjectContaining {
    +       "security-info": Object {
    +         "authMethod": "password",
    +         "authStrength": "medium",
              "clientIP": "192.168.1.100",
    -         "threatLevel": Any<String>,
    +         "deviceTrust": "untrusted",
    +         "geoLocation": Object {
    +           "city": "Unknown",
    +           "country": "US",
    +           "isHighRisk": false,
    +           "region": "Unknown",
    +           "timezone": "UTC",
    +         },
    +         "ipType": "external",
    +         "isInternalIP": false,
    +         "isOfficeIP": false,
    +         "isThreatIP": false,
    +         "isVpnConnection": false,
    +         "lastSuccessfulAccess": null,
    +         "mfaEnabled": false,
    +         "networkTrust": "untrusted",
    +         "recentFailedAttempts": 0,
    +         "requiresAdditionalAuth": true,
    +         "securityScore": 0.4,
    +         "sessionAge": 2768,
    +         "threatLevel": "low",
    +         "threatReasons": Array [],
    +         "unusualActivity": Array [],
    +         "vpnType": null,
    +       },
    +       "time-based": Object {
    +         "businessHoursConfig": Object {
    +           "end": 18,
    +           "start": 9,
    +           "timezone": "Asia/Tokyo",
              },
    -       "time-based": ObjectContaining {
    +         "currentTime": "2024-01-15T01:00:00.000Z",
    +         "dayOfMonth": 15,
    +         "dayOfWeek": 1,
              "dayOfWeekName": "Monday",
    +         "fiscalQuarter": 4,
    +         "fiscalYear": 2023,
    +         "hour": 10,
    +         "isBusinessDay": true,
              "isBusinessHours": true,
    +         "isHoliday": false,
    +         "isMonthEnd": false,
              "isWeekend": false,
    +         "minute": 0,
    +         "month": 1,
    +         "monthName": "January",
    +         "quarter": 1,
    +         "timeOfDay": "morning",
    +         "timeSinceBusinessStart": 60,
    +         "timeUntilBusinessEnd": 480,
    +         "timezone": "Asia/Tokyo",
    +         "year": 2024,
            },
          },
          "requestId": "req-123",
          "sessionId": "session-456",
        },

      557 |
      558 |       // å…¨ã¦ã®enricherã‹ã‚‰ã®æƒ…å ±ãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 559 |       expect(enrichedContext).toMatchObject({
          |                               ^
      560 |         // åŸºæœ¬æƒ…å ±
      561 |         agent: 'customer-support-agent',
      562 |         action: 'read',

      at Object.<anonymous> (test/context-enrichers.test.ts:559:31)

FAIL test/mcp/tool-discovery.test.ts
  â— ToolDiscoveryService â€º Native Tools Registration â€º should register all native tools on initialization

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      47 |       
      48 |       // Check some native tools are registered
    > 49 |       expect(tools.some(t => t.name === 'Agent')).toBe(true);
         |                                                   ^
      50 |       expect(tools.some(t => t.name === 'Bash')).toBe(true);
      51 |       expect(tools.some(t => t.name === 'Edit')).toBe(true);
      52 |       expect(tools.some(t => t.name === 'Read')).toBe(true);

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:49:51)

  â— ToolDiscoveryService â€º Native Tools Registration â€º should apply policy control to native tools

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: undefined

      62 |       // Default enabled tools should have policy control
      63 |       const bashTool = tools.find(t => t.name === 'Bash');
    > 64 |       expect(bashTool?.policyControlled).toBe(true);
         |                                          ^
      65 |       
      66 |       // Exception tools should not have policy control
      67 |       const todoRead = tools.find(t => t.name === 'TodoRead');

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:64:42)

  â— ToolDiscoveryService â€º Tool Discovery â€º should discover tools from configured sources

    TypeError: service.discoverTools is not a function

      112 |       
      113 |       service = new ToolDiscoveryService(config, mockLogger);
    > 114 |       await service.discoverTools();
          |                     ^
      115 |       
      116 |       const tools = service.getAllTools();
      117 |       

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:114:21)

  â— ToolDiscoveryService â€º Tool Discovery â€º should handle discovery errors gracefully

    TypeError: service.discoverTools is not a function

      138 |       
      139 |       service = new ToolDiscoveryService(config, mockLogger);
    > 140 |       await service.discoverTools();
          |                     ^
      141 |       
      142 |       // Should log error but not throw
      143 |       expect(mockLogger.error).toHaveBeenCalledWith(

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:140:21)

  â— ToolDiscoveryService â€º Tool Discovery â€º should apply policy control based on exceptions

    TypeError: service.discoverTools is not a function

      177 |       
      178 |       service = new ToolDiscoveryService(config, mockLogger);
    > 179 |       await service.discoverTools();
          |                     ^
      180 |       
      181 |       const tools = service.getAllTools();
      182 |       

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:179:21)

  â— ToolDiscoveryService â€º Tool Filtering â€º should filter tools by policy control status

    TypeError: service.getNonPolicyControlledTools is not a function

      192 |     it('should filter tools by policy control status', () => {
      193 |       const policyControlledTools = service.getPolicyControlledTools();
    > 194 |       const nonPolicyControlledTools = service.getNonPolicyControlledTools();
          |                                                ^
      195 |       
      196 |       // All policy controlled tools should have policyControlled = true
      197 |       policyControlledTools.forEach(tool => {

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:194:48)

  â— ToolDiscoveryService â€º Tool Filtering â€º should get tool by name

    TypeError: service.getToolByName is not a function

      211 |
      212 |     it('should get tool by name', () => {
    > 213 |       const bashTool = service.getToolByName('Bash');
          |                                ^
      214 |       expect(bashTool).toBeDefined();
      215 |       expect(bashTool?.name).toBe('Bash');
      216 |       

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:213:32)

  â— ToolDiscoveryService â€º Tool Prefixing â€º should check if tool name has prefix

    TypeError: service.hasToolPrefix is not a function

      222 |   describe('Tool Prefixing', () => {
      223 |     it('should check if tool name has prefix', () => {
    > 224 |       expect(service.hasToolPrefix('filesystem__read_file')).toBe(true);
          |                      ^
      225 |       expect(service.hasToolPrefix('execution-server__run_command')).toBe(true);
      226 |       expect(service.hasToolPrefix('simple_tool')).toBe(false);
      227 |     });

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:224:22)

  â— ToolDiscoveryService â€º Tool Prefixing â€º should extract prefix from tool name

    TypeError: service.getToolPrefix is not a function

      228 |
      229 |     it('should extract prefix from tool name', () => {
    > 230 |       expect(service.getToolPrefix('filesystem__read_file')).toBe('filesystem');
          |                      ^
      231 |       expect(service.getToolPrefix('execution-server__run_command'))
      232 |         .toBe('execution-server');
      233 |       expect(service.getToolPrefix('simple_tool')).toBeNull();

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:230:22)

  â— ToolDiscoveryService â€º Tool Prefixing â€º should strip prefix from tool name

    TypeError: service.stripToolPrefix is not a function

      235 |
      236 |     it('should strip prefix from tool name', () => {
    > 237 |       expect(service.stripToolPrefix('filesystem__read_file')).toBe('read_file');
          |                      ^
      238 |       expect(service.stripToolPrefix('execution-server__run_command'))
      239 |         .toBe('run_command');
      240 |       expect(service.stripToolPrefix('simple_tool')).toBe('simple_tool');

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:237:22)

  â— ToolDiscoveryService â€º Configuration Updates â€º should update policy control configuration

    TypeError: service.getToolByName is not a function

      245 |     it('should update policy control configuration', () => {
      246 |       // Initial state
    > 247 |       let bashTool = service.getToolByName('Bash');
          |                              ^
      248 |       expect(bashTool?.policyControlled).toBe(true);
      249 |       
      250 |       // Update config to exclude Bash

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:247:30)

  â— ToolDiscoveryService â€º Configuration Updates â€º should handle defaultEnabled = false correctly

    TypeError: service.updatePolicyControl is not a function

      260 |
      261 |     it('should handle defaultEnabled = false correctly', () => {
    > 262 |       service.updatePolicyControl({
          |               ^
      263 |         defaultEnabled: false,
      264 |         exceptions: ['Bash'] // This should be enabled as exception
      265 |       });

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:262:15)

  â— ToolDiscoveryService â€º Integration Tests â€º should handle complete workflow

    TypeError: service.discoverTools is not a function

      302 |       
      303 |       service = new ToolDiscoveryService(config, mockLogger);
    > 304 |       await service.discoverTools();
          |                     ^
      305 |       
      306 |       const allTools = service.getAllTools();
      307 |       const nativeTools = allTools.filter(t => t.source === ToolSource.NATIVE);

      at Object.<anonymous> (test/mcp/tool-discovery.test.ts:304:21)

FAIL src/test/utils-config.test.ts
  â— Config â€º åŸºæœ¬è¨­å®š â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§åˆæœŸåŒ–ã•ã‚Œã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "development"
    Received: "test"

      33 |       const config = new Config();
      34 |
    > 35 |       expect(config.nodeEnv).toBe('development');
         |                              ^
      36 |       expect(config.port).toBe(3000);
      37 |       expect(config.logLevel).toBe('info');
      38 |     });

      at Object.<anonymous> (src/test/utils-config.test.ts:35:30)

  â— Config â€º åŸºæœ¬è¨­å®š â€º ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å€¤ã‚’èª­ã¿è¾¼ã‚€

    [Config] Secret key must be changed in production environment

      175 |     // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šæ¤œè¨¼
      176 |     if (this.config.nodeEnv === 'production' && this.config.secretKey === DEFAULT_SECRET_KEY) {
    > 177 |       throw new Error('[Config] Secret key must be changed in production environment');
          |             ^
      178 |     }
      179 |
      180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {

      at Config.validateConfig (src/utils/config.ts:177:13)
      at new Config (src/utils/config.ts:87:10)
      at Object.<anonymous> (src/test/utils-config.test.ts:45:22)

  â— Config â€º LLMè¨­å®š â€º ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®LLMè¨­å®šã‚’ä½¿ç”¨ã™ã‚‹

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
        "apiKey": "",
        "baseURL": undefined,
        "maxTokens": 4096,
    -   "model": "gpt-4",
    -   "provider": "openai",
    +   "model": "claude-opus-4-20250514",
    +   "provider": "anthropic",
        "temperature": 0.3,
      }

      67 |       const config = new Config();
      68 |
    > 69 |       expect(config.llm).toEqual({
         |                          ^
      70 |         provider: 'openai',
      71 |         apiKey: '',
      72 |         model: 'gpt-4',

      at Object.<anonymous> (src/test/utils-config.test.ts:69:26)

  â— Config â€º ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š â€º æœ¬ç•ªç’°å¢ƒã§ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨æ­£å¸¸ã«å‹•ä½œã™ã‚‹

    expect(received).not.toThrow()

    Error name:    "Error"
    Error message: "[Config] Secret key must be at least 32 characters long in production"

          179 |
          180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {
        > 181 |       throw new Error('[Config] Secret key must be at least 32 characters long in production');
              |             ^
          182 |     }
          183 |
          184 |     // ãƒãƒ¼ãƒˆç•ªå·æ¤œè¨¼

      at Config.validateConfig (src/utils/config.ts:181:13)
      at new Config (src/utils/config.ts:87:10)
      at src/test/utils-config.test.ts:277:20
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/utils-config.test.ts:277:38)
      at Object.<anonymous> (src/test/utils-config.test.ts:277:38)

  â— Config â€º ä¸Šæµã‚µãƒ¼ãƒãƒ¼ã®ãƒ‘ãƒ¼ã‚¹ â€º ç©ºç™½ã‚’å«ã‚€è¨­å®šã‚‚å‡¦ç†ã™ã‚‹

    expect(received).toEqual(expected) // deep equality

    - Expected  - 2
    + Received  + 2

      Object {
    -   "server1": "http://server1.com",
    -   "server2": "http://server2.com",
    +   "server1 ": " http://server1.com",
    +   "server2 ": " http://server2.com",
      }

      306 |       const config = new Config();
      307 |
    > 308 |       expect(config.mcpProxy.upstreamServers).toEqual({
          |                                               ^
      309 |         server1: 'http://server1.com',
      310 |         server2: 'http://server2.com'
      311 |       });

      at Object.<anonymous> (src/test/utils-config.test.ts:308:47)

  â— Config â€º ç’°å¢ƒãƒã‚§ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ â€º isProductionãŒæ­£ã—ãå‹•ä½œã™ã‚‹

    [Config] Secret key must be at least 32 characters long in production

      179 |
      180 |     if (this.config.nodeEnv === 'production' && (!this.config.secretKey || this.config.secretKey.length < MIN_SECRET_KEY_LENGTH)) {
    > 181 |       throw new Error('[Config] Secret key must be at least 32 characters long in production');
          |             ^
      182 |     }
      183 |
      184 |     // ãƒãƒ¼ãƒˆç•ªå·æ¤œè¨¼

      at Config.validateConfig (src/utils/config.ts:181:13)
      at new Config (src/utils/config.ts:87:10)
      at Object.<anonymous> (src/test/utils-config.test.ts:346:22)

  â— Config â€º è¨­å®šæ¤œè¨¼ â€º APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«è­¦å‘Šã‚’å‡ºåŠ›ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[Config] Warning: OpenAI API key not set. Set OPENAI_API_KEY environment variable."

    Number of calls: 0

      366 |       new Config();
      367 |
    > 368 |       expect(consoleErrorSpy).toHaveBeenCalledWith(
          |                               ^
      369 |         '[Config] Warning: OpenAI API key not set. Set OPENAI_API_KEY environment variable.'
      370 |       );
      371 |     });

      at Object.<anonymous> (src/test/utils-config.test.ts:368:31)

  â— Config â€º è¨­å®šæ¤œè¨¼ â€º è¨­å®šãŒæ­£å¸¸ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã“ã¨ã‚’ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "[Config] Configuration loaded successfully"

    Number of calls: 0

      411 |       new Config();
      412 |
    > 413 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] Configuration loaded successfully');
          |                               ^
      414 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] Environment: development');
      415 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] LLM Provider: openai');
      416 |       expect(consoleErrorSpy).toHaveBeenCalledWith('[Config] LLM Model: gpt-4');

      at Object.<anonymous> (src/test/utils-config.test.ts:413:31)

  â— Config â€º toJSON â€º æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚¹ã‚¯ã—ã¦å‡ºåŠ›ã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: "[REDACTED]"
    Received: "[NOT_SET]"

      427 |       const json = config.toJSON();
      428 |
    > 429 |       expect(json.llm?.apiKey).toBe('[REDACTED]');
          |                                ^
      430 |       expect(json.secretKey).toBe('[REDACTED]');
      431 |       expect(json.jwtSecret).toBe('[REDACTED]');
      432 |     });

      at Object.<anonymous> (src/test/utils-config.test.ts:429:32)

  â— Config â€º dotenvè¨­å®š â€º dotenv.configãŒoverride: falseã§å‘¼ã°ã‚Œã‚‹

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"override": false}

    Number of calls: 0

      462 |       new Config();
      463 |
    > 464 |       expect(dotenv.config).toHaveBeenCalledWith({ override: false });
          |                             ^
      465 |     });
      466 |   });
      467 | });

      at Object.<anonymous> (src/test/utils-config.test.ts:464:29)

FAIL src/test/context-enrichers.test.ts
  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º ãƒªã‚½ãƒ¼ã‚¹ã®æ©Ÿå¯†åº¦ã‚’åˆ†é¡ã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  - 4
    + Received  + 4

      Object {
    -   "dataType": "customer-data",
    +   "dataType": "unclassified",
        "sensitivityLevel": "high",
    -   "tags": ArrayContaining [
    -     "pii",
    -     "regulated",
    +   "tags": Array [
    +     "unclassified",
    +     "review-required",
        ],
      }

      319 |         const enriched = await classifier.enrich(context);
      320 |
    > 321 |         expect(enriched['resource-classifier']).toMatchObject({
          |                                                 ^
      322 |           dataType: testCase.expectedType,
      323 |           sensitivityLevel: testCase.expectedSensitivity,
      324 |           tags: expect.arrayContaining(testCase.expectedTags)

      at Object.<anonymous> (src/test/context-enrichers.test.ts:321:49)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ResourceClassifier â€º å€‹äººæƒ…å ±ã‚’å«ã‚€ãƒªã‚½ãƒ¼ã‚¹ã‚’è­˜åˆ¥ã™ã‚‹

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      346 |         const enriched = await classifier.enrich(context);
      347 |
    > 348 |         expect(enriched['resource-classifier'].isPii).toBe(true);
          |                                                       ^
      349 |         expect(enriched['resource-classifier'].tags).toContain('pii');
      350 |       }
      351 |     });

      at Object.<anonymous> (src/test/context-enrichers.test.ts:348:55)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º SecurityInfoEnricher â€º ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã™ã‚‹

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      521 |       
      522 |       // ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 523 |       expect(enriched['security-info'].unusualActivity.length).toBeGreaterThan(0);
          |                                                                ^
      524 |     });
      525 |   });
      526 |

      at Object.<anonymous> (src/test/context-enrichers.test.ts:523:64)

  â— Context Enrichers - æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ â€º ContextCollectorçµ±åˆãƒ†ã‚¹ãƒˆ â€º å…¨ã¦ã®enricherãŒå”èª¿ã—ã¦å‹•ä½œã™ã‚‹

    expect(received).toMatchObject(expected)

    - Expected  -  12
    + Received  + 126

      Object {
        "action": "read",
        "agent": "customer-support-agent",
    -   "environment": ObjectContaining {
    -     "agent-info": ObjectContaining {
    -       "agentType": Any<String>,
    -       "clearanceLevel": Any<Number>,
    -       "department": Any<String>,
    +   "environment": Object {
    +     "clientIP": "192.168.1.100",
    +     "enrichmentTime": 1,
    +     "enrichments": Object {
    +       "agent-info": Object {
    +         "activityStatus": "active-today",
    +         "ageDays": 760,
    +         "agentId": "customer-support-agent",
    +         "agentType": "support",
    +         "clearanceLevel": 2,
    +         "clearanceName": "standard",
    +         "createdAt": "2024-01-15T00:00:00.000Z",
    +         "department": "customer-service",
    +         "hasAdminPrivileges": false,
    +         "hasHighClearance": false,
    +         "inactiveDays": 0,
    +         "isExternal": false,
    +         "isInactive": false,
    +         "isNewAgent": false,
    +         "lastActivity": "2026-02-13T00:27:01.704Z",
    +         "location": "tokyo-office",
    +         "permissions": Array [
    +           "read-customer-data",
    +           "create-tickets",
    +         ],
    +         "requiresSupervision": false,
    +         "riskScore": 0.2,
    +         "supervisor": "support-manager",
    +         "tags": Array [
    +           "production",
    +           "verified",
    +         ],
    +         "trustScore": 1,
    +       },
    +       "resource-classifier": Object {
    +         "accessFrequency": Object {
    +           "daily": 66,
    +           "monthly": 1298,
    +           "trend": "stable",
    +           "weekly": 379,
              },
    -     "requestId": "req-123",
    -     "resource-classifier": ObjectContaining {
    -       "dataType": Any<String>,
    +         "dataAge": "current",
    +         "dataController": "data-governance-team",
    +         "dataType": "unclassified",
    +         "department": "unknown",
    +         "isFinancial": false,
    +         "isPhi": false,
    +         "isPii": false,
    +         "isPublic": false,
    +         "isRegulated": false,
    +         "lineage": Object {
    +           "dependencies": Array [],
    +           "lastModified": "2026-02-13T00:27:01.728Z",
    +           "source": "original-system",
    +           "transformations": Array [
    +             "anonymized",
    +             "aggregated",
    +           ],
    +           "version": "1.0",
    +         },
    +         "owner": "unknown",
    +         "requiresAudit": false,
    +         "requiresEncryption": true,
    +         "resourceHost": "profile",
    +         "resourcePath": "/12345",
    +         "resourceScheme": "customer",
    +         "resourceUri": "customer://profile/12345",
    +         "retentionDays": 90,
              "sensitivityLevel": "high",
    +         "sensitivityScore": 0.8,
    +         "tags": Array [
    +           "unclassified",
    +           "review-required",
    +         ],
            },
    -     "security-info": ObjectContaining {
    +       "security-info": Object {
    +         "authMethod": "password",
    +         "authStrength": "medium",
              "clientIP": "192.168.1.100",
    -       "threatLevel": Any<String>,
    +         "deviceTrust": "untrusted",
    +         "geoLocation": Object {
    +           "city": "Unknown",
    +           "country": "US",
    +           "isHighRisk": false,
    +           "region": "Unknown",
    +           "timezone": "UTC",
              },
    -     "sessionId": "session-456",
    -     "time-based": ObjectContaining {
    +         "ipType": "external",
    +         "isInternalIP": false,
    +         "isOfficeIP": false,
    +         "isThreatIP": false,
    +         "isVpnConnection": false,
    +         "lastSuccessfulAccess": null,
    +         "mfaEnabled": false,
    +         "networkTrust": "untrusted",
    +         "recentFailedAttempts": 0,
    +         "requiresAdditionalAuth": true,
    +         "securityScore": 0.4,
    +         "sessionAge": 2164,
    +         "threatLevel": "low",
    +         "threatReasons": Array [],
    +         "unusualActivity": Array [],
    +         "vpnType": null,
    +       },
    +       "time-based": Object {
    +         "businessHoursConfig": Object {
    +           "end": 18,
    +           "start": 9,
    +           "timezone": "Asia/Tokyo",
    +         },
    +         "currentTime": "2024-01-15T01:00:00.000Z",
    +         "dayOfMonth": 15,
    +         "dayOfWeek": 1,
              "dayOfWeekName": "Monday",
    +         "fiscalQuarter": 4,
    +         "fiscalYear": 2023,
    +         "hour": 10,
    +         "isBusinessDay": true,
              "isBusinessHours": true,
    +         "isHoliday": false,
    +         "isMonthEnd": false,
              "isWeekend": false,
    +         "minute": 0,
    +         "month": 1,
    +         "monthName": "January",
    +         "quarter": 1,
    +         "timeOfDay": "morning",
    +         "timeSinceBusinessStart": 60,
    +         "timeUntilBusinessEnd": 480,
    +         "timezone": "Asia/Tokyo",
    +         "year": 2024,
            },
    +     },
    +     "requestId": "req-123",
    +     "sessionId": "session-456",
        },
        "purpose": "customer-inquiry",
        "resource": "customer://profile/12345",
      }

      557 |
      558 |       // å…¨ã¦ã®enricherã‹ã‚‰ã®æƒ…å ±ãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
    > 559 |       expect(enrichedContext).toMatchObject({
          |                               ^
      560 |         // åŸºæœ¬æƒ…å ±
      561 |         agent: 'customer-support-agent',
      562 |         action: 'read',

      at Object.<anonymous> (src/test/context-enrichers.test.ts:559:31)

FAIL src/test/schemas/config.schema.test.ts
  â— Configuration Schema Validation Tests â€º Schema Structure Validation â€º should accept valid complete configuration

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      }
    ]"

          58 |       };
          59 |
        > 60 |       expect(() => AEGISConfigSchema.parse(validConfig)).not.toThrow();
             |                                      ^
          61 |     });
          62 |
          63 |     it('should accept minimal valid configuration', () => {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:60:38
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:60:62)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:60:62)

  â— Configuration Schema Validation Tests â€º Schema Structure Validation â€º should accept minimal valid configuration

    ZodError: [
      {
        "code": "invalid_type",
        "expected": "string",
        "received": "undefined",
        "path": [
          "llm",
          "model"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "cache"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "log"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "security"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "monitoring"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "policy"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "mcp"
        ],
        "message": "Required"
      }
    ]

      69 |       };
      70 |
    > 71 |       const result = AEGISConfigSchema.parse(minimalConfig);
         |                                        ^
      72 |       expect(result.llm.provider).toBe('openai');
      73 |       expect(result.llm.apiKey).toBe('test-key');
      74 |       // Check defaults are applied

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:71:40)

  â— Configuration Schema Validation Tests â€º LLM Configuration Schema â€º should validate temperature range

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          113 |           expect(() => AEGISConfigSchema.parse(config)).toThrow();
          114 |         } else {
        > 115 |           expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                          ^
          116 |         }
          117 |       });
          118 |     });

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:115:42
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:115:61
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:103:17)
      at src/test/schemas/config.schema.test.ts:115:61
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:103:17)

  â— Configuration Schema Validation Tests â€º MCP Configuration Schema â€º should validate transport types

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      }
    ]"

          151 |         };
          152 |         
        > 153 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          154 |       });
          155 |
          156 |       const invalidTransport = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:153:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:153:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:147:23)
      at src/test/schemas/config.schema.test.ts:153:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:147:23)

  â— Configuration Schema Validation Tests â€º MCP Configuration Schema â€º should validate port numbers

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      }
    ]"

          181 |           expect(() => AEGISConfigSchema.parse(config)).toThrow();
          182 |         } else {
        > 183 |           expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                          ^
          184 |         }
          185 |       });
          186 |     });

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:183:42
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:183:61
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:174:17)
      at src/test/schemas/config.schema.test.ts:183:61
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:174:17)

  â— Configuration Schema Validation Tests â€º MCP Configuration Schema â€º should validate CORS origins are valid URLs

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      }
    ]"

          198 |       };
          199 |
        > 200 |       expect(() => AEGISConfigSchema.parse(validOrigins)).not.toThrow();
              |                                      ^
          201 |
          202 |       const invalidOrigins = {
          203 |         llm: { provider: 'openai', apiKey: 'key' },

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:200:38
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:200:63)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:200:63)

  â— Configuration Schema Validation Tests â€º Security Configuration Schema â€º should validate secret key length

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          229 |       };
          230 |
        > 231 |       expect(() => AEGISConfigSchema.parse(validKey)).not.toThrow();
              |                                      ^
          232 |     });
          233 |
          234 |     it('should validate encryption algorithms', () => {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:231:38
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:231:59)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:231:59)

  â— Configuration Schema Validation Tests â€º Security Configuration Schema â€º should validate encryption algorithms

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          244 |         };
          245 |         
        > 246 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          247 |       });
          248 |
          249 |       const invalidAlgorithm = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:246:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:246:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:237:23)
      at src/test/schemas/config.schema.test.ts:246:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:237:23)

  â— Configuration Schema Validation Tests â€º Cache Configuration Schema â€º should validate cache strategies

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          281 |         };
          282 |         
        > 283 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          284 |       });
          285 |
          286 |       const invalidStrategy = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:283:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:283:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:277:23)
      at src/test/schemas/config.schema.test.ts:283:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:277:23)

  â— Configuration Schema Validation Tests â€º Monitoring Configuration Schema â€º should validate log levels

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"policy\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          321 |         };
          322 |         
        > 323 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          324 |       });
          325 |
          326 |       const invalidLevel = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:323:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:323:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:317:19)
      at src/test/schemas/config.schema.test.ts:323:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:317:19)

  â— Configuration Schema Validation Tests â€º Policy Configuration Schema â€º should validate strictness levels

    expect(received).not.toThrow()

    Error name:    "ZodError"
    Error message: "[
      {
        \"code\": \"invalid_type\",
        \"expected\": \"string\",
        \"received\": \"undefined\",
        \"path\": [
          \"llm\",
          \"model\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"cache\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"log\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"security\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"monitoring\"
        ],
        \"message\": \"Required\"
      },
      {
        \"code\": \"invalid_type\",
        \"expected\": \"object\",
        \"received\": \"undefined\",
        \"path\": [
          \"mcp\"
        ],
        \"message\": \"Required\"
      }
    ]"

          369 |         };
          370 |         
        > 371 |         expect(() => AEGISConfigSchema.parse(config)).not.toThrow();
              |                                        ^
          372 |       });
          373 |
          374 |       const invalidLevel = {

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at src/test/schemas/config.schema.test.ts:371:40
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at src/test/schemas/config.schema.test.ts:371:59
                at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:365:19)
      at src/test/schemas/config.schema.test.ts:371:59
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:365:19)

  â— Configuration Schema Validation Tests â€º Schema Error Messages â€º should provide helpful error messages for validation failures

    expect(received).toHaveLength(expected)

    Expected length: 5
    Received length: 11
    Received array:  [{"code": "invalid_enum_value", "message": "Invalid enum value. Expected 'openai' | 'anthropic', received 'invalid'", "options": ["openai", "anthropic"], "path": ["llm", "provider"], "received": "invalid"}, {"code": "invalid_type", "expected": "string", "message": "Required", "path": ["llm", "model"], "received": "undefined"}, {"code": "too_big", "exact": false, "inclusive": true, "maximum": 2, "message": "Number must be less than or equal to 2", "path": ["llm", "temperature"], "type": "number"}, {"code": "too_small", "exact": false, "inclusive": true, "message": "Number must be greater than or equal to 1", "minimum": 1, "path": ["llm", "maxTokens"], "type": "number"}, {"code": "too_small", "exact": false, "inclusive": true, "message": "Number must be greater than or equal to 0", "minimum": 0, "path": ["cache", "ttl"], "type": "number"}, {"code": "invalid_enum_value", "message": "Invalid enum value. Expected 'lru' | 'lfu' | 'fifo', received 'wrong'", "options": ["lru", "lfu", "fifo"], "path": ["cache", "strategy"], "received": "wrong"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["log"], "received": "undefined"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["security"], "received": "undefined"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["monitoring"], "received": "undefined"}, {"code": "invalid_type", "expected": "object", "message": "Required", "path": ["policy"], "received": "undefined"}, â€¦]

      431 |       } catch (error) {
      432 |         if (error instanceof z.ZodError) {
    > 433 |           expect(error.errors).toHaveLength(5); // Multiple validation errors
          |                                ^
      434 |           expect(error.errors.some(e => e.path.includes('provider'))).toBeTruthy();
      435 |           expect(error.errors.some(e => e.path.includes('temperature'))).toBeTruthy();
      436 |           expect(error.errors.some(e => e.path.includes('maxTokens'))).toBeTruthy();

      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:433:32)

  â— Configuration Schema Validation Tests â€º Schema Compatibility â€º should be compatible with AEGISConfig type

    ZodError: [
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "cache"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "log"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "security"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "monitoring"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "policy"
        ],
        "message": "Required"
      },
      {
        "code": "invalid_type",
        "expected": "object",
        "received": "undefined",
        "path": [
          "mcp"
        ],
        "message": "Required"
      }
    ]

      454 |       };
      455 |
    > 456 |       const parsed = AEGISConfigSchema.parse(config);
          |                                        ^
      457 |       
      458 |       // Type assertion to ensure compatibility
      459 |       const _typeCheck: z.infer<typeof AEGISConfigSchema> = parsed;

      at Object.get error [as error] (node_modules/zod/dist/cjs/v3/types.js:45:31)
      at ZodObject.parse (node_modules/zod/dist/cjs/v3/types.js:120:22)
      at Object.<anonymous> (src/test/schemas/config.schema.test.ts:456:40)

FAIL src/test/e2e/policy-lifecycle.test.ts
  â— Test suite failed to run

    Jest encountered an unexpected token

    Jest failed to parse a file. This happens e.g. when your code or its dependencies use non-standard JavaScript syntax, or when Jest is not configured to support such syntax.

    Out of the box Jest supports Babel, which will be used to transform your files into valid JS based on your Babel configuration.

    By default "node_modules" folder is ignored by transformers.

    Here's what you can do:
     â€¢ If you are trying to use ECMAScript Modules, see https://jestjs.io/docs/ecmascript-modules for how to enable it.
     â€¢ If you are trying to use TypeScript, see https://jestjs.io/docs/getting-started#using-typescript
     â€¢ To have some of your "node_modules" files transformed, you can specify a custom "transformIgnorePatterns" in your config.
     â€¢ If you need a custom transformation specify a "transform" option in your config.
     â€¢ If you simply want to mock your non-JS modules (e.g. binary assets) you can stub them out with the "moduleNameMapper" config option.

    You'll find more details and examples of these config options in the docs:
    https://jestjs.io/docs/configuration
    For information about custom transformations, see:
    https://jestjs.io/docs/code-transformation

    Details:

    /Users/shingo/Develop/aegis-policy-engine/node_modules/node-fetch/src/index.js:9
    import http from 'node:http';
    ^^^^^^

    SyntaxError: Cannot use import statement outside a module

       5 | import { describe, it, expect, beforeAll, afterAll } from '@jest/globals';
       6 | // @ts-ignore
    >  7 | const fetch = require('node-fetch').default || require('node-fetch');
         |               ^
       8 | import { PolicyAdministrator } from '../../policies/administrator.js';
       9 | import { AIJudgmentEngine } from '../../ai/judgment-engine.js';
      10 |

      at Runtime.createScriptFromCode (node_modules/jest-runtime/build/index.js:1505:14)
      at Object.<anonymous> (src/test/e2e/policy-lifecycle.test.ts:7:15)

FAIL src/test/mcp/policy-enforcer.test.ts (11.132 s)
  â— PolicyEnforcer â€º enforcePolicy â€º should handle policy decision timeout

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      223 |     });
      224 |
    > 225 |     it('should handle policy decision timeout', async () => {
          |     ^
      226 |       // Mock a delayed decision that will timeout
      227 |       (mockPolicyEngine.decide as jest.Mock).mockImplementation(
      228 |         () => new Promise(resolve => setTimeout(resolve, TIMEOUTS.POLICY_DECISION + 1000))

      at src/test/mcp/policy-enforcer.test.ts:225:5
      at src/test/mcp/policy-enforcer.test.ts:102:3
      at Object.<anonymous> (src/test/mcp/policy-enforcer.test.ts:86:1)

  â— PolicyEnforcer â€º enforcePolicy â€º should use default policy when no policy loader provided

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"action": "read", "agent": "test-agent", "environment": {"agent": "test-agent", "request": {"params": {"purpose": "test-purpose"}}, "transport": "http"}, "purpose": "test-purpose", "resource": "file://test.txt", "time": 2026-02-13T00:26:54.630Z},
    - null,
    + undefined,

    Number of calls: 1

      304 |       );
      305 |
    > 306 |       expect(mockPolicyEngine.decide).toHaveBeenCalledWith(
          |                                       ^
      307 |         enrichedContext,
      308 |         null // No policy
      309 |       );

      at Object.<anonymous> (src/test/mcp/policy-enforcer.test.ts:306:39)

FAIL test/ai/judgment-engine-comprehensive.test.ts (31.591 s)
  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should handle prompt injection attempts safely

    TypeError: Cannot read properties of undefined (reading '0')

      69 |       // Verify the prompt is constructed safely
      70 |       const promptCall = mockLLM.complete.mock.calls[0][0];
    > 71 |       expect(promptCall.messages[0].content).toContain('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒªã‚·ãƒ¼');
         |                                 ^
      72 |     });
      73 |
      74 |     it('should handle context data injection attempts', async () => {

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:71:33)

  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should validate and sanitize LLM responses

    expect(received).not.toHaveProperty(path)

    Expected path: not "__proto__"

    Received value: {}

      122 |       expect(result.confidence).toBeLessThanOrEqual(1);
      123 |       expect(result.constraints).not.toContain('<script>alert("xss")</script>');
    > 124 |       expect(result).not.toHaveProperty('__proto__');
          |                          ^
      125 |       expect(result).not.toHaveProperty('constructor');
      126 |     });
      127 |   });

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:124:26)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should handle concurrent requests efficiently

    TypeError: Cannot read properties of undefined (reading 'has')

      164 |       // Should use cache for duplicate requests
      165 |       const cacheKey = (engine as any).generateCacheKey(policy, contexts[0]);
    > 166 |       expect((engine as any).cache.has(cacheKey)).toBe(true);
          |                                    ^
      167 |     });
      168 |
      169 |     it('should respect rate limits', async () => {

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:166:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should respect rate limits

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      202 |       // Some should succeed, some should fail due to rate limit
      203 |       expect(successful.length).toBeGreaterThan(0);
    > 204 |       expect(failed.length).toBeGreaterThan(0);
          |                             ^
      205 |     });
      206 |
      207 |     it('should implement request timeout', async () => {

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:204:29)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should implement request timeout

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      205 |     });
      206 |
    > 207 |     it('should implement request timeout', async () => {
          |     ^
      208 |       const policy = 'Timeout test policy';
      209 |       const context: DecisionContext = {
      210 |         agent: 'test',

      at test/ai/judgment-engine-comprehensive.test.ts:207:5
      at test/ai/judgment-engine-comprehensive.test.ts:129:3
      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:16:1)

  â— AIJudgmentEngine - Comprehensive Tests â€º Error Recovery and Resilience â€º should retry on transient failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      437 |       const result = await engine.makeDecision(policy, context);
      438 |
    > 439 |       expect(result.decision).toBe('PERMIT');
          |                               ^
      440 |       expect(attemptCount).toBe(3);
      441 |     });
      442 |

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:439:31)

  â— AIJudgmentEngine - Comprehensive Tests â€º Custom Prompt Templates â€º should support custom prompt templates

    expect(received).toContain(expected) // indexOf

    Expected substring: "SECURITY POLICY EVALUATION"
    Received string:    "\"# AIåˆ©ç”¨åˆ¶å¾¡åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ \\n\\nã‚ãªãŸã¯çµ„ç¹”ã®AIåˆ©ç”¨ã«é–¢ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚\\næä¾›ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã¨ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ã¦ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚\\n\\n## åˆ¤å®šåŸºæº–\\n1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨©é™ã¨ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©\\n2. æ“ä½œã®ç›®çš„ã¨çµ„ç¹”ã®ãƒãƒªã‚·ãƒ¼ã¨ã®æ•´åˆæ€§  \\n3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®è©•ä¾¡\\n4. æ™‚é–“çš„ãƒ»åœ°ç†çš„åˆ¶ç´„ã®ç¢ºèª\\n\\n## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±\\n\\n- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: test-agent (ã‚¿ã‚¤ãƒ—: ä¸æ˜)\\n- **è¦æ±‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: read\\n- **å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹**: test-resource\\n- **æ¥­å‹™ç›®çš„**: æœªæŒ‡å®š\\n- **æ™‚åˆ»**: 2026/2/13 9:27:25 (å–¶æ¥­æ™‚é–“å†…)\\n- **å ´æ‰€**: ä¸æ˜\\n- **ã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«**: ä¸æ˜\\n- **éå»ã®é•åå±¥æ­´**: ãªã—\\n\\n## ç’°å¢ƒæƒ…å ±\\n```json\\n{\\n  \\\"custom\\\": \\\"value\\\"\\n}\\n```\\n\\n## é©ç”¨ãƒãƒªã‚·ãƒ¼\\nCustom template test policy\\n\\n## åˆ¤å®šå¯¾è±¡\\nã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: test-agent\\nã‚¢ã‚¯ã‚·ãƒ§ãƒ³: read\\nãƒªã‚½ãƒ¼ã‚¹: test-resource\\nç›®çš„: æœªæŒ‡å®š\\n\\n## å‡ºåŠ›å½¢å¼\\nä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š\\n{\\n  \\\"decision\\\": \\\"PERMIT\\\" | \\\"DENY\\\" | \\\"INDETERMINATE\\\",\\n  \\\"reason\\\": \\\"åˆ¤å®šç†ç”±ã®è©³ç´°èª¬æ˜\\\",\\n  \\\"confidence\\\": 0.0-1.0ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢,\\n  \\\"constraints\\\": [\\\"é©ç”¨ã™ã¹ãåˆ¶ç´„ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"obligations\\\": [\\\"å®Ÿè¡Œã™ã¹ãç¾©å‹™ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"metadata\\\": {\\n    \\\"risk_level\\\": \\\"LOW\\\" | \\\"MEDIUM\\\" | \\\"HIGH\\\",\\n    \\\"policy_violations\\\": [\\\"é•åã—ãŸãƒãƒªã‚·ãƒ¼é …ç›®\\\"],\\n    \\\"recommendations\\\": [\\\"æ¨å¥¨äº‹é …\\\"]\\n  }\\n}\""

      540 |       // Verify custom template was used
      541 |       const call = mockLLM.complete.mock.calls[0][0];
    > 542 |       expect(JSON.stringify(call)).toContain('SECURITY POLICY EVALUATION');
          |                                    ^
      543 |     });
      544 |   });
      545 |

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:542:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Monitoring and Metrics â€º should track decision metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 100

      566 |       const stats = engine.getStats();
      567 |       
    > 568 |       expect(stats.totalDecisions).toBe(3);
          |                                    ^
      569 |       expect(stats.permitCount).toBe(2);
      570 |       expect(stats.denyCount).toBe(1);
      571 |       expect(stats.cacheHitRate).toBeGreaterThanOrEqual(0);

      at Object.<anonymous> (test/ai/judgment-engine-comprehensive.test.ts:568:36)

FAIL src/test/ai/judgment-engine-comprehensive.test.ts (31.643 s)
  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should handle prompt injection attempts safely

    TypeError: Cannot read properties of undefined (reading '0')

      69 |       // Verify the prompt is constructed safely
      70 |       const promptCall = mockLLM.complete.mock.calls[0][0];
    > 71 |       expect(promptCall.messages[0].content).toContain('ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒãƒªã‚·ãƒ¼');
         |                                 ^
      72 |     });
      73 |
      74 |     it('should handle context data injection attempts', async () => {

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:71:33)

  â— AIJudgmentEngine - Comprehensive Tests â€º Security Tests â€º should validate and sanitize LLM responses

    expect(received).not.toHaveProperty(path)

    Expected path: not "__proto__"

    Received value: {}

      122 |       expect(result.confidence).toBeLessThanOrEqual(1);
      123 |       expect(result.constraints).not.toContain('<script>alert("xss")</script>');
    > 124 |       expect(result).not.toHaveProperty('__proto__');
          |                          ^
      125 |       expect(result).not.toHaveProperty('constructor');
      126 |     });
      127 |   });

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:124:26)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should handle concurrent requests efficiently

    TypeError: Cannot read properties of undefined (reading 'has')

      164 |       // Should use cache for duplicate requests
      165 |       const cacheKey = (engine as any).generateCacheKey(policy, contexts[0]);
    > 166 |       expect((engine as any).cache.has(cacheKey)).toBe(true);
          |                                    ^
      167 |     });
      168 |
      169 |     it('should respect rate limits', async () => {

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:166:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should respect rate limits

    expect(received).toBeGreaterThan(expected)

    Expected: > 0
    Received:   0

      202 |       // Some should succeed, some should fail due to rate limit
      203 |       expect(successful.length).toBeGreaterThan(0);
    > 204 |       expect(failed.length).toBeGreaterThan(0);
          |                             ^
      205 |     });
      206 |
      207 |     it('should implement request timeout', async () => {

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:204:29)

  â— AIJudgmentEngine - Comprehensive Tests â€º Performance and Concurrency Tests â€º should implement request timeout

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      205 |     });
      206 |
    > 207 |     it('should implement request timeout', async () => {
          |     ^
      208 |       const policy = 'Timeout test policy';
      209 |       const context: DecisionContext = {
      210 |         agent: 'test',

      at src/test/ai/judgment-engine-comprehensive.test.ts:207:5
      at src/test/ai/judgment-engine-comprehensive.test.ts:129:3
      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:16:1)

  â— AIJudgmentEngine - Comprehensive Tests â€º Error Recovery and Resilience â€º should retry on transient failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "PERMIT"
    Received: "INDETERMINATE"

      437 |       const result = await engine.makeDecision(policy, context);
      438 |
    > 439 |       expect(result.decision).toBe('PERMIT');
          |                               ^
      440 |       expect(attemptCount).toBe(3);
      441 |     });
      442 |

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:439:31)

  â— AIJudgmentEngine - Comprehensive Tests â€º Custom Prompt Templates â€º should support custom prompt templates

    expect(received).toContain(expected) // indexOf

    Expected substring: "SECURITY POLICY EVALUATION"
    Received string:    "\"# AIåˆ©ç”¨åˆ¶å¾¡åˆ¤å®šã‚·ã‚¹ãƒ†ãƒ \\n\\nã‚ãªãŸã¯çµ„ç¹”ã®AIåˆ©ç”¨ã«é–¢ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã‚’è©•ä¾¡ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚\\næä¾›ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã¨ãƒãƒªã‚·ãƒ¼ã«åŸºã¥ã„ã¦ã€AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚\\n\\n## åˆ¤å®šåŸºæº–\\n1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ¨©é™ã¨ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©\\n2. æ“ä½œã®ç›®çš„ã¨çµ„ç¹”ã®ãƒãƒªã‚·ãƒ¼ã¨ã®æ•´åˆæ€§  \\n3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®è©•ä¾¡\\n4. æ™‚é–“çš„ãƒ»åœ°ç†çš„åˆ¶ç´„ã®ç¢ºèª\\n\\n## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±\\n\\n- **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: test-agent (ã‚¿ã‚¤ãƒ—: ä¸æ˜)\\n- **è¦æ±‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: read\\n- **å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹**: test-resource\\n- **æ¥­å‹™ç›®çš„**: æœªæŒ‡å®š\\n- **æ™‚åˆ»**: 2026/2/13 9:27:25 (å–¶æ¥­æ™‚é–“å†…)\\n- **å ´æ‰€**: ä¸æ˜\\n- **ã‚¯ãƒªã‚¢ãƒ©ãƒ³ã‚¹ãƒ¬ãƒ™ãƒ«**: ä¸æ˜\\n- **éå»ã®é•åå±¥æ­´**: ãªã—\\n\\n## ç’°å¢ƒæƒ…å ±\\n```json\\n{\\n  \\\"custom\\\": \\\"value\\\"\\n}\\n```\\n\\n## é©ç”¨ãƒãƒªã‚·ãƒ¼\\nCustom template test policy\\n\\n## åˆ¤å®šå¯¾è±¡\\nã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: test-agent\\nã‚¢ã‚¯ã‚·ãƒ§ãƒ³: read\\nãƒªã‚½ãƒ¼ã‚¹: test-resource\\nç›®çš„: æœªæŒ‡å®š\\n\\n## å‡ºåŠ›å½¢å¼\\nä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š\\n{\\n  \\\"decision\\\": \\\"PERMIT\\\" | \\\"DENY\\\" | \\\"INDETERMINATE\\\",\\n  \\\"reason\\\": \\\"åˆ¤å®šç†ç”±ã®è©³ç´°èª¬æ˜\\\",\\n  \\\"confidence\\\": 0.0-1.0ã®ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢,\\n  \\\"constraints\\\": [\\\"é©ç”¨ã™ã¹ãåˆ¶ç´„ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"obligations\\\": [\\\"å®Ÿè¡Œã™ã¹ãç¾©å‹™ã®ãƒªã‚¹ãƒˆ\\\"],\\n  \\\"metadata\\\": {\\n    \\\"risk_level\\\": \\\"LOW\\\" | \\\"MEDIUM\\\" | \\\"HIGH\\\",\\n    \\\"policy_violations\\\": [\\\"é•åã—ãŸãƒãƒªã‚·ãƒ¼é …ç›®\\\"],\\n    \\\"recommendations\\\": [\\\"æ¨å¥¨äº‹é …\\\"]\\n  }\\n}\""

      540 |       // Verify custom template was used
      541 |       const call = mockLLM.complete.mock.calls[0][0];
    > 542 |       expect(JSON.stringify(call)).toContain('SECURITY POLICY EVALUATION');
          |                                    ^
      543 |     });
      544 |   });
      545 |

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:542:36)

  â— AIJudgmentEngine - Comprehensive Tests â€º Monitoring and Metrics â€º should track decision metrics

    expect(received).toBe(expected) // Object.is equality

    Expected: 3
    Received: 100

      566 |       const stats = engine.getStats();
      567 |       
    > 568 |       expect(stats.totalDecisions).toBe(3);
          |                                    ^
      569 |       expect(stats.permitCount).toBe(2);
      570 |       expect(stats.denyCount).toBe(1);
      571 |       expect(stats.cacheHitRate).toBeGreaterThanOrEqual(0);

      at Object.<anonymous> (src/test/ai/judgment-engine-comprehensive.test.ts:568:36)

FAIL src/test/performance/stress-test.test.ts (106.116 s)
  â— Performance and Stress Tests â€º Load Testing â€º should handle sustained load within SLA

    thrown: "Exceeded timeout of 60000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      72 |
      73 |   describe('Load Testing', () => {
    > 74 |     it('should handle sustained load within SLA', async () => {
         |     ^
      75 |       // SLA: 99% of requests < 100ms, 99.9% availability
      76 |       
      77 |       const responseTimes: number[] = [];

      at src/test/performance/stress-test.test.ts:74:5
      at src/test/performance/stress-test.test.ts:73:3
      at Object.<anonymous> (src/test/performance/stress-test.test.ts:30:1)

  â— Performance and Stress Tests â€º Rate Limiting Performance â€º should enforce rate limits without significant overhead

    expect(received).toBeLessThanOrEqual(expected)

    Expected: <= 1100
    Received:    12000

      345 |       results.forEach(result => {
      346 |         const effectiveRate = (result.allowed / requestsPerClient) * requestsPerClient * 60; // per minute
    > 347 |         expect(effectiveRate).toBeLessThanOrEqual(STRESS_TEST_CONFIG.RATE_LIMIT * 1.1); // Within 10% tolerance
          |                               ^
      348 |       });
      349 |
      350 |       // Verify low overhead

      at src/test/performance/stress-test.test.ts:347:31
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (src/test/performance/stress-test.test.ts:345:15)

FAIL src/test/mcp/stdio-router.test.ts (156.481 s)
  â— StdioRouter â€º Server Lifecycle â€º should start server successfully

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: "Successfully started upstream server: test-server"
    Received
           1: "Configured upstream server: test-server", {"args": ["test.js"], "command": "node"}
           2: "ï¿½ï¿½ Starting upstream server test-server"
           3: "ï¿½ï¿½ test-server startup message detected: Server running on stdio"

    Number of calls: 5

      128 |       });
      129 |       
    > 130 |       expect(mockLogger.info).toHaveBeenCalledWith(
          |                               ^
      131 |         'Successfully started upstream server: test-server'
      132 |       );
      133 |     });

      at Object.<anonymous> (src/test/mcp/stdio-router.test.ts:130:31)

  â— StdioRouter â€º Request Routing â€º should aggregate tools/list from multiple servers

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      348 |     });
      349 |
    > 350 |     it('should aggregate tools/list from multiple servers', async () => {
          |     ^
      351 |       // Add second server
      352 |       const { process: mockProcess2, stdin: stdin2, stdout: stdout2, stderr: stderr2 } = createMockProcess();
      353 |       mockSpawn.mockReturnValue(mockProcess2);

      at src/test/mcp/stdio-router.test.ts:350:5
      at src/test/mcp/stdio-router.test.ts:280:3
      at Object.<anonymous> (src/test/mcp/stdio-router.test.ts:39:1)


Test Suites: 33 failed, 19 passed, 52 total
Tests:       241 failed, 5 skipped, 556 passed, 802 total
Snapshots:   0 total
Time:        158.492 s
Ran all test suites.
